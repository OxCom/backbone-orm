/*
  backbone-orm.js 0.6.0
  Copyright (c) 2013-2014 Vidigami
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Source: https://github.com/vidigami/backbone-orm
  Dependencies: Backbone.js, Underscore.js, and Moment.js.
*/
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),function(){try{return require("stream")}catch(e){}}()):"function"==typeof define&&define.amd?define(["underscore","backbone","stream"],t):"object"==typeof exports?exports.BackboneORM=t(require("underscore"),require("backbone"),function(){try{return require("stream")}catch(e){}}()):e.BackboneORM=t(e._,e.Backbone,e.stream)}(this,function(e,t,r){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n;e.exports={ConventionUtils:r(13),sync:r(14),Utils:r(4),JSONUtils:r(5),DateUtils:r(6),Queue:r(7),DatabaseURL:r(8),Fabricator:r(9),MemoryStore:r(15),Cursor:r(10),Schema:r(11),ConnectionPool:r(12),CacheSingletons:r(16),_:r(1),Backbone:r(2),modules:{url:r(17),querystring:r(18),"lru-cache":r(20),inflection:r(21),underscore:r(1),backbone:r(2)}};try{e.exports.modules.stream=r(3)}catch(i){n=i}},function(t){t.exports=e},function(e){e.exports=t},function(e){if("undefined"==typeof r){var t=new Error('Cannot find module "stream"');throw t.code="MODULE_NOT_FOUND",t}e.exports=r},function(e,t,r){var n,i,o,s,u,a,l,c,h,p={}.hasOwnProperty,f=function(e,t){function r(){this.constructor=e}for(var n in t)p.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};a=r(17),i=r(8),n=r(2),h=r(1),s=r(7),o=r(5),c=null,u=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},e.exports=l=function(){function e(){}return e.resetSchemas=function(e,t,r){var n,i,o,u,a,l,c,h,p;for(2===arguments.length&&(p=[{},t],t=p[0],r=p[1]),a=0,c=e.length;c>a;a++)i=e[a],i.schema();for(n=[],o=new s(1),u=function(e){return o.defer(function(r){return e.resetSchema(t,function(t){return t&&(n.push(e.model_name),console.log("Error when dropping schema for "+e.model_name+". "+t)),r()})})},l=0,h=e.length;h>l;l++)i=e[l],u(i);return o.await(function(){return t.verbose&&console.log(""+(e.length-n.length)+" schemas dropped."),n.length?r(new Error("Failed to migrate schemas: "+n.join(", "))):r()})},e.debounceCallback=function(e){var t;return t=function(){return t.was_called?void 0:(t.was_called=!0,e.apply(null,Array.prototype.slice.call(arguments,0)))}},e.guid=function(){return u()+u()+"-"+u()+"-"+u()+"-"+u()+"-"+u()+u()+u()},e.bbCallback=function(e){return{success:function(t,r,n){return e(null,t,r,n)},error:function(t,r,n){return e(r||new Error("Backbone call failed"),t,r,n)}}},e.wrapOptions=function(t,r){return null==t&&(t={}),h.isFunction(t)&&(t=e.bbCallback(t)),h.defaults(e.bbCallback(function(e,n,i){return r(e,n,i,t)}),t)},e.isModel=function(e){return e&&e.attributes&&(e instanceof n.Model||e.parse&&e.fetch)},e.isCollection=function(e){return e&&e.models&&(e instanceof n.Collection||e.reset&&e.fetch)},e.get=function(e,t,r){return e._orm||(e._orm={}),e._orm.hasOwnProperty(t)?e._orm[t]:r},e.set=function(e,t,r){return e._orm||(e._orm={}),e._orm[t]=r,e._orm[t]},e.orSet=function(e,t,r){return e._orm||(e._orm={}),e._orm.hasOwnProperty(t)||(e._orm[t]=r),e._orm[t]},e.unset=function(e,t){return e._orm||(e._orm={}),delete e._orm[t]},e.findOrGenerateModelName=function(e){var t,r;if(e.prototype.model_name)return e.prototype.model_name;if((r=h.result(new e,"url"))&&(t=new i(r).modelName()))return t;if(e.name)return e.name;throw"Could not find or generate model name for "+e},e.configureCollectionModelType=function(e,t){var r,i,o;return i=function(){var t,r;return t=h.result(this.collection||e.prototype,"url"),this.isNew()||(r=a.parse(t),r.pathname=""+r.pathname+"/encodeURIComponent(@id)",t=a.format(r)),t},o=e.prototype.model,o&&o!==n.Model?(o.prototype.sync===n.Model.prototype.sync&&(o.prototype.url=i,o.prototype.schema=e.prototype.schema,o.prototype.sync=t(o)),o):(r=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return f(n,r),n.prototype.url=i,n.prototype.schema=e.prototype.schema,n.prototype.sync=t(n),n}(n.Model),e.prototype.model=r)},e.configureModelType=function(e){return c||(c=r(22)),c(e)},e.patchRemoveByJSON=function(e,t,r){var n,i,o,u,a,l,c;if(!(u=e.schema()))return r();for(i=new s(1),a=function(e){return i.defer(function(r){return e.patchRemove(t,r)})},o=l=0,c=u.length;c>l;o=++l)n=u[o],a(o);return i.await(r)},e.presaveBelongsToRelationships=function(e,t){var r,n,i,o,u,a,l,c,h,p,f;if(!e.schema)return t();n=new s(1),a=e.schema(),f=a.relations;for(r in f)if(u=f[r],"belongsTo"===u.type&&!u.isVirtual()&&(l=e.get(r)))for(o=l.models?l.models:[l],c=function(){return function(e){return n.defer(function(t){return e.save(t)})}}(this),h=0,p=o.length;p>h;h++)i=o[h],i.id||c(i);return n.await(t)},e.dataId=function(e){return h.isObject(e)?e.id:e},e.dataIsSameModel=function(t,r){return e.dataId(t)||e.dataId(r)?e.dataId(t)===e.dataId(r):h.isEqual(t,r)},e.dataToModel=function(t,r){var n,i,o;return t?h.isArray(t)?function(){var n,o,s;for(s=[],n=0,o=t.length;o>n;n++)i=t[n],s.push(e.dataToModel(i,r));return s}():(e.isModel(t)?o=t:e.dataId(t)!==t?o=new r(r.prototype.parse(t)):((n={})[r.prototype.idAttribute]=t,o=new r(n),o.setLoaded(!1)),o):null},e.updateModel=function(t,r){return!r||t===r||r._orm_needs_load?t:(e.isModel(r)&&(r=r.toJSON()),e.dataId(r)!==r&&(t.setLoaded(!0),t.set(r)),t)},e.updateOrNew=function(t,r){var n,i,o;return(n=r.cache)&&(i=e.dataId(t))&&(o=n.get(i))&&e.updateModel(o,t),o||(o=e.isModel(t)?t:e.dataToModel(t,r),o&&n&&n.set(o.id,o)),o},e.modelJSONSave=function(t,r,i){var o;return o=new n.Model(t),o._orm_never_cache=!0,o.urlRoot=function(){return function(){var e,t;try{t=h.result(new r,"url")}catch(n){e=n}return t}}(this),r.prototype.sync("update",o,e.bbCallback(i))},e.isSorted=function(e,t){var r,n,i,o;for(t=h.uniq(t),i=0,o=e.length;o>i;i++){if(n=e[i],r&&1===this.fieldCompare(r,n,t))return!1;r=n}return!0},e.fieldCompare=function(e,t,r){var n,i;return i=r[0],h.isArray(i)&&(i=i[0]),"-"===i.charAt(0)&&(i=i.substr(1),n=!0),e.get(i)===t.get(i)?r.length>1?this.fieldCompare(e,t,r.splice(1)):0:n?e.get(i)<t.get(i)?1:-1:e.get(i)>t.get(i)?1:-1},e.jsonFieldCompare=function(e,t,r){var n,i;return i=r[0],h.isArray(i)&&(i=i[0]),"-"===i.charAt(0)&&(i=i.substr(1),n=!0),e[i]===t[i]?r.length>1?this.jsonFieldCompare(e,t,r.splice(1)):0:n?o.stringify(e[i])<o.stringify(t[i])?1:-1:o.stringify(e[i])>o.stringify(t[i])?1:-1},e}()},function(e,t,r){var n,i,o,s;s=r(1),i=r(7),o=r(4),e.exports=n=function(){function e(){}return e.stringify=function(e){var t;try{return JSON.stringify(e)}catch(r){return t=r,"Failed to stringify"}},e.parseParams=function(e){var t,r,n;r={};for(t in e)n=e[t],r[t]=JSON.parse(n);return r},e.parse=function(t){var r,n,i,o,u;if(s.isNull(t)||"null"===t)return null;if(s.isDate(t))return t;if(s.isArray(t))return s.map(t,e.parse);if(s.isObject(t)){o={};for(n in t)u=t[n],o[n]=e.parse(u);return o}if(s.isString(t)){if(t.length>=20&&"Z"===t[t.length-1])return s.isNaN((r=new Date(t)).getTime())?t:r;if("true"===t)return!0;if("false"===t)return!1;if(i=/^\"(.*)\"$/.exec(t))return i[0];try{if(t=JSON.parse(t))return e.parse(t)}catch(a){}}return t},e.toQuery=function(t,r){var n,i,o;if(null==r&&(r=0),s.isNull(t))return"null";if(s.isArray(t))return e.stringify(t);if(s.isDate(t)||t.toJSON)return t.toJSON();if(s.isObject(t)){if(r>0)return e.stringify(t);i={};for(n in t)o=t[n],i[n]=e.toQuery(o,1);return i}return t},e.renderTemplate=function(t,r,n,o){var u,a,l,c,h,p;if(3===arguments.length&&(o=n,n={}),s.isArray(t)){for(l=[],a=new i(1),c=function(t){return a.defer(function(i){return e.renderTemplate(t,r,n,function(e,t){return e?i(e):(l.push(t),i())})})},h=0,p=t.length;p>h;h++)u=t[h],c(u);return a.await(function(e){return o(e,e?void 0:l)})}return t?s.isString(r)?e.renderKey(t,r,n,o):s.isArray(r)?e.renderKeys(t,r,n,o):s.isFunction(r)?r(t,n,o):e.renderDSL(t,r,n,o):o(null,null)},e.renderDSL=function(t,r,n,o){var u,a,l,c,h;3===arguments.length&&(o=n,n={}),l=new i,c={},h=function(r,i){return l.defer(function(o){var u,a,l,h,p;return u=i.key||r,(h=t.relation(u))?(i.query?(l=i.query,p=i.template):i.$count?(l=s.clone(i),delete l.key):s.isFunction(i)?p=i:i.template?s.isObject(i.template)&&!s.isFunction(i.template)?l=i.template:(p=i.template,l=s.clone(i),delete l.key,delete l.template,0===s.size(l)&&(l=null)):(p=s.clone(i),delete p.key),p?l?h.cursor(t,u,l).toModels(function(t,i){return t?o(t):e.renderTemplate(i,p,n,function(e,t){return c[r]=t,o(e)})}):t.get(u,function(t,i){return t?o(t):e.renderTemplate(i,p,n,function(e,t){return c[r]=t,o(e)})}):h.cursor(t,u,l).toJSON(function(e,t){return c[r]=t,o(e)})):(r.length>1&&"_"===r[r.length-1]&&(r=r.slice(0,+(r.length-2)+1||9e9)),"$select"===r?s.isString(i)?e.renderKey(t,i,n,function(e,t){return c[i]=t,o(e)}):e.renderKeys(t,i,n,function(e,t){return s.extend(c,t),o(e)}):s.isString(i)?e.renderKey(t,i,n,function(e,t){return c[r]=t,o(e)}):s.isFunction(i)?i(t,n,function(e,t){return c[r]=t,o(e)}):s.isString(i.method)?(a=s.isArray(i.args)?i.args.slice():i.args?[i.args]:[],a.push(function(e,t){return c[r]=t,o(e)}),t[i.method].apply(t,a)):(console.trace("Unknown DSL action: "+r+": ",i),o(new Error("Unknown DSL action: "+r+": ",i))))})};for(a in r)u=r[a],h(a,u);return l.await(function(e){return o(e,e?void 0:c)})},e.renderKeys=function(t,r,n,o){var s,u,a,l,c,h;for(3===arguments.length&&(o=n,n={}),a={},u=new i,l=function(r){return u.defer(function(i){return e.renderKey(t,r,n,function(e,t){return e?i(e):(a[r]=t,i())})})},c=0,h=r.length;h>c;c++)s=r[c],l(s);return u.await(function(e){return o(e,e?void 0:a)})},e.renderKey=function(e,t,r,n){return 3===arguments.length&&(n=r,r={}),e.get(t,function(r,i){var o;if(r)return n(r);if(e.relation(t)){if(s.isArray(i))return n(null,function(){var e,t,r;for(r=[],e=0,t=i.length;t>e;e++)o=i[e],r.push(o.toJSON());return r}());if(i&&i.toJSON)return n(null,i=i.toJSON())}return n(null,i)})},e.renderRelated=function(t,r,n,o,u){var a,l,c,h,p,f;if(4===arguments.length&&(u=o,o={}),s.isArray(t)){for(c=[],l=new i,h=function(t){return l.defer(function(i){return t.get(r,function(t,r){return t&&i(t),e.renderTemplate(r,n,o,function(e,t){return e?i(e):(c.push(t),i())})})})},p=0,f=t.length;f>p;p++)a=t[p],h(a);return l.await(function(e){return u(e,e?void 0:c)})}return t.get(r,function(t,r){return t&&u(t),e.renderTemplate(r,n,o,u)})},e.deepClone=function(t,r){var n,i;if(!t||"object"!=typeof t)return t;if(s.isString(t))return String.prototype.slice.call(t);if(s.isDate(t))return new Date(t.getTime());if(s.isFunction(t.clone))return t.clone();if(s.isArray(t))n=Array.prototype.slice.call(t);else{if(t.constructor!=={}.constructor)return t;n=s.extend({},t)}if(!s.isUndefined(r)&&r>0)for(i in n)n[i]=e.deepClone(n[i],r-1);return n},e}()},function(e,t,r){var n,i,o;o=r(1),i={milliseconds:{milliseconds:1},seconds:{milliseconds:1e3},minutes:{milliseconds:6e4},hours:{milliseconds:144e4},days:{days:1},weeks:{days:7},months:{months:1},years:{years:1}},e.exports=n=function(){function e(){}return e.durationAsMilliseconds=function(e,t){var r;if(!(r=i[t]))throw new Error("DateUtils.durationAsMilliseconds :Unrecognized units: "+t);return r.milliseconds?e*r.milliseconds:r.days?864e5*e*r.days:r.months?e*r.months*2592e6:r.years?e*r.years*31536e6:void 0},e.isBefore=function(e,t){return e.getTime()<t.getTime()},e.isAfter=function(e,t){return e.getTime()>t.getTime()},e}()},function(e){var t,r=function(e,t){return function(){return e.apply(t,arguments)}};e.exports=t=function(){function e(e){this.parallelism=e,this._doneTask=r(this._doneTask,this),this.parallelism||(this.parallelism=1/0),this.tasks=[],this.running_count=0,this.error=null,this.await_callback=null}return e.prototype.defer=function(e){return this.tasks.push(e),this._runTasks()},e.prototype.await=function(e){if(this.await_callback)throw new Error("Awaiting callback was added twice: "+e);return this.await_callback=e,!this.error&&this.tasks.length+this.running_count?void 0:this._callAwaiting()},e.prototype._doneTask=function(e){return this.running_count--,this.error||(this.error=e),this._runTasks()},e.prototype._runTasks=function(){var e;if(this.error||!(this.tasks.length+this.running_count))return this._callAwaiting();for(;this.running_count<this.parallelism;){if(!this.tasks.length)return;e=this.tasks.shift(),this.running_count++,e(this._doneTask)}},e.prototype._callAwaiting=function(){return!this.await_called&&this.await_callback?(this.await_called=!0,this.await_callback(this.error)):void 0},e}()},function(e,t,r){var n,i,o,s,u;u=r(1),s=r(17),n=r(13),o=["protocol","slashes","auth","host","hostname","port","search","query","hash","href"],e.exports=i=function(){function e(e,t,r){var n,i,a,l,c,h,p,f,d,y,_,m,g,v,w,b,$,k;if(_=s.parse(e,t,r),p=_.pathname.split(","),p.length>1){for(d=u.pick(_,"protocol","auth","slashes"),d.host="{1}",d.pathname="{2}",y=s.format(d),y=y.replace("{1}/{2}",""),f=_.pathname.split("/"),_.pathname="/"+f[f.length-2]+"/"+f[f.length-1],l=e.replace(y,""),l=l.substring(0,l.indexOf(_.pathname)),a=l.split(","),k=["host","hostname","port"],m=0,w=k.length;w>m;m++)h=k[m],delete _[h];for(this.hosts=[],g=0,b=a.length;b>g;g++)n=a[g],c=n.split(":"),this.hosts.push(1===c.length?{host:c[0],hostname:c[0]}:{host:c[0],hostname:""+c[0]+":"+c[1],port:c[1]})}for(i=_.pathname.split("/"),this.table=i.pop(),this.database=i[i.length-1],v=0,$=o.length;$>v;v++)h=o[v],_.hasOwnProperty(h)&&(this[h]=_[h])}return e.prototype.format=function(e){var t,r,n;return null==e&&(e={}),n=u.pick(this,o),n.pathname="",this.hosts&&(t=u.map(this.hosts,function(e){return""+e.host+(e.port?":"+e.port:"")}),n.pathname+=t.join(","),n.host="{1}"),this.database&&(n.pathname+="/"+this.database),this.table&&!e.exclude_table&&(n.pathname+="/"+this.table),(e.exclude_search||e.exclude_query)&&(delete n.search,delete n.query),r=s.format(n),this.hosts&&(r=r.replace("{1}/"+n.pathname,n.pathname)),r},e.prototype.parseAuth=function(){var e,t;return this.auth?(e=this.auth.split(":"),t={user:e[0]},t.password=e.length>1?e[1]:null,t):null},e.prototype.modelName=function(){return this.table?n.conventions.modelName(this.table,!1):null},e}()},function(e,t,r){var n,i,o;o=r(1),i=r(7),e.exports=n=function(){function e(){}return e["new"]=function(e,t,r){var n,i,s,u;for(s=[];t-->0;){n={};for(i in r)u=r[i],n[i]=o.isFunction(u)?u():u;s.push(new e(n))}return s},e.create=function(t,r,n,o){var s,u,a,l,c,h;for(u=e["new"](t,r,n),a=new i,l=function(e){return a.defer(function(t){return e.save(t)})},c=0,h=u.length;h>c;c++)s=u[c],l(s);return a.await(function(e){return o(e,u)})},e.value=function(e){return 0===arguments.length?void 0:function(){return e}},e.uniqueId=function(e){return 0===arguments.length?o.uniqueId():function(){return o.uniqueId(e)}},e.uniqueString=e.uniqueId,e.date=function(e,t){var r,n,i;return n=new Date,0===arguments.length?n:(1===arguments.length&&(i=[n,e],e=i[0],t=i[1]),r=e.getTime(),function(){var e;return e=new Date(r),r+=t,e})},e}()},function(e,t,r){var n,i,o,s,u=function(e,t){return function(){return e.apply(t,arguments)}};s=r(1),o=r(4),n=["$count","$exists","$zero","$one","$offset","$limit","$page","$sort","$white_list","$select","$include","$values","$ids","$or"],e.exports=i=function(){function e(t,r){this.relatedModelTypesInQuery=u(this.relatedModelTypesInQuery,this);var n,i,o,a,l,c;for(n in r)o=r[n],this[n]=o;for(i=e.parseQuery(t,this.model_type),this._find=i.find,this._cursor=i.cursor,c=["$white_list","$select","$values"],a=0,l=c.length;l>a;a++)n=c[a],this._cursor[n]&&!s.isArray(this._cursor[n])&&(this._cursor[n]=[this._cursor[n]])}return e.validateQuery=function(t,r,n){var i,o,u,a;a=[];for(o in t)if(u=t[o],s.isUndefined(u)||s.isObject(u)){if(i=r?""+r+"."+o:o,s.isUndefined(u))throw new Error("Unexpected undefined for query key '"+i+"' on "+(null!=n?n.model_name:void 0));a.push(s.isObject(u)?e.validateQuery(u,i,n):void 0)}return a},e.parseQuery=function(t,r){var n,i,o,u;if(t){if(s.isObject(t)){if(t.find||t.cursor)return{find:t.find||{},cursor:t.cursor||{}};try{e.validateQuery(t,null,r)}catch(a){throw n=a,new Error("Error: "+n+". Query: ",t)}o={find:{},cursor:{}};for(i in t)u=t[i],"$"!==i[0]?o.find[i]=u:o.cursor[i]=u;return o}return{find:{id:t},cursor:{$one:!0}}}return{find:{},cursor:{}}},e.prototype.offset=function(e){return this._cursor.$offset=e,this},e.prototype.limit=function(e){return this._cursor.$limit=e,this},e.prototype.sort=function(e){return this._cursor.$sort=e,this},e.prototype.whiteList=function(){var e;return e=s.flatten(arguments),this._cursor.$white_list=this._cursor.$white_list?s.intersection(this._cursor.$white_list,e):e,this},e.prototype.select=function(){var e;return e=s.flatten(arguments),this._cursor.$select=this._cursor.$select?s.intersection(this._cursor.$select,e):e,this},e.prototype.include=function(){var e;return e=s.flatten(arguments),this._cursor.$include=this._cursor.$include?s.intersection(this._cursor.$include,e):e,this},e.prototype.values=function(){var e;return e=s.flatten(arguments),this._cursor.$values=this._cursor.$values?s.intersection(this._cursor.$values,e):e,this},e.prototype.ids=function(){return this._cursor.$values=["id"],this},e.prototype.count=function(e){return this.execWithCursorQuery("$count","toJSON",e)},e.prototype.exists=function(e){return this.execWithCursorQuery("$exists","toJSON",e)},e.prototype.toModel=function(e){return this.execWithCursorQuery("$one","toModels",e)},e.prototype.toModels=function(e){return this._cursor.$values?e(new Error("Cannot call toModels on cursor with values for model "+this.model_type.model_name+". Values: "+JSONUtils.stringify(this._cursor.$values))):this.toJSON(function(t){return function(r,n){return r?e(r):t._cursor.$one&&!n?e(null,null):(s.isArray(n)||(n=[n]),t.prepareIncludes(n,function(r,n){var i,s,u,a;return a=(i=!(t._cursor.$select||t._cursor.$whitelist))?function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)s=n[e],r.push(o.updateOrNew(s,this.model_type));return r}.call(t):function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)s=n[e],r.push((u=new this.model_type(this.model_type.prototype.parse(s)),u.setPartial(!0),u));return r}.call(t),e(null,t._cursor.$one?a[0]:a)}))}}(this))},e.prototype.toJSON=function(e){var t,r;return r=s.extend({},s.pick(this._cursor,n),this._find),t=this.relatedModelTypesInQuery(),this.queryToJSON(e)},e.prototype.queryToJSON=function(){throw new Error("toJSON must be implemented by a concrete cursor for a Backbone Sync type")},e.prototype.hasCursorQuery=function(e){return this._cursor[e]||""===this._cursor[e]},e.prototype.execWithCursorQuery=function(e,t,r){var n;return n=this._cursor[e],this._cursor[e]=!0,this[t](function(t){return function(i,o){return s.isUndefined(n)?delete t._cursor[e]:t._cursor[e]=n,r(i,o)}}(this))},e.prototype.relatedModelTypesInQuery=function(){var e,t,r,n,i,o,s,u,a,l,c,h;t=[],r=[],l=this._find;for(e in l)s=l[e],e.indexOf(".")>0?(c=e.split("."),i=c[0],e=c[1],t.push(i)):(o=this.model_type.reverseRelation(e))&&o.join_table&&(r.push(o.model_type),r.push(o.join_table));for((null!=(h=this._cursor)?h.$include:void 0)&&(t=t.concat(this._cursor.$include)),u=0,a=t.length;a>u;u++)i=t[u],(n=this.model_type.relation(i))&&(r.push(n.reverse_model_type),n.join_table&&r.push(n.join_table));return r},e.prototype.selectResults=function(e){var t,r,n,i;return this._cursor.$one&&(e=e.slice(0,1)),this._cursor.$values?(r=this._cursor.$white_list?s.intersection(this._cursor.$values,this._cursor.$white_list):this._cursor.$values,1===this._cursor.$values.length?(i=this._cursor.$values[0],e=r.length?function(){var t,r,o;for(o=[],t=0,r=e.length;r>t;t++)n=e[t],o.push(n.hasOwnProperty(i)?n[i]:null);return o}():s.map(e,function(){return null})):e=function(){var t,o,s;for(s=[],t=0,o=e.length;o>t;t++)n=e[t],s.push(function(){var e,t,o;for(o=[],e=0,t=r.length;t>e;e++)i=r[e],n.hasOwnProperty(i)&&o.push(n[i]);return o}());return s}()):this._cursor.$select?(t=this._cursor.$white_list?s.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,e=function(){var r,i,o;for(o=[],r=0,i=e.length;i>r;r++)n=e[r],o.push(s.pick(n,t));return o}()):this._cursor.$white_list&&(e=function(){var t,r,i;for(i=[],t=0,r=e.length;r>t;t++)n=e[t],i.push(s.pick(n,this._cursor.$white_list));return i}.call(this)),this.hasCursorQuery("$page")?e:this._cursor.$one?e[0]||null:e},e.prototype.selectFromModels=function(e){var t,r,n;return this._cursor.$select?(t=this._cursor.$white_list?s.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,e=function(){var i,o,u;for(n=new this.model_type(s.pick(n.attributes,t)),n.setPartial(!0),u=[],i=0,o=e.length;o>i;i++)r=e[i],u.push(n);return u}.call(this)):this._cursor.$white_list&&(e=function(){var t,i,o;for(n=new this.model_type(s.pick(n.attributes,this._cursor.$white_list)),n.setPartial(!0),o=[],t=0,i=e.length;i>t;t++)r=e[t],o.push(n);return o}.call(this)),e},e.prototype.prepareIncludes=function(e,t){var r,n,i,o,u,a,l,c,h,p,f,d,y;if(!s.isArray(this._cursor.$include)||s.isEmpty(this._cursor.$include))return t(null,e);for(l=this.model_type.schema(),c={},r=function(){return function(e,t){var r;return r=e[t.prototype.idAttribute],c[r]||(t.cache?(c[r]=t.cache.get(r))||t.cache.set(r,c[r]=new t(e)):c[r]=new t(e)),c[r]}}(this),y=this._cursor.$include,h=0,f=y.length;f>h;h++)for(n=y[h],a=l.relation(n),c={},p=0,d=e.length;d>p;p++)o=e[p],s.isArray(u=o[n])?o[n]=function(){var e,t,n;for(n=[],e=0,t=u.length;t>e;e++)i=u[e],n.push(r(i,a.reverse_model_type));return n}():u&&(o[n]=r(u,a.reverse_model_type));return t(null,e)},e}()},function(e,t,r){var n,i,o,s,u,a,l,c,h,p={}.hasOwnProperty,f=function(e,t){function r(){this.constructor=e}for(var n in t)p.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};h=r(1),n=r(2),i=r(13),u=r(23),s=r(24),o=r(8),c=r(4),a={hasOne:"hasOne",has_one:"hasOne",HasOne:"hasOne",belongsTo:"belongsTo",belongs_to:"belongsTo",BelongsTo:"belongsTo",hasMany:"hasMany",has_many:"hasMany",HasMany:"hasMany"},e.exports=l=function(){function e(e){this.model_type=e,this.raw=h.clone(h.result(new this.model_type,"schema")||{}),this.fields={},this.relations={},this.virtual_accessors={}}return e.prototype.initialize=function(){var e,t,r,n,i;if(!this.is_initialized){this.is_initialized=!0,n=this.raw;for(t in n)e=n[t],this._parseField(t,e);i=this.relations;for(t in i)r=i[t],r.initialize()}},e.prototype.relation=function(e){return this.relations[e]||this.virtual_accessors[e]},e.prototype.reverseRelation=function(e){var t,r,n;n=this.relations;for(t in n)if(r=n[t],r.reverse_relation&&r.reverse_relation.join_key===e)return r.reverse_relation;return null},e.prototype.columns=function(){var e,t,r,n;e=h.keys(this.fields),h.find(e,function(e){return"id"===e})||e.push("id"),n=this.relations;for(t in n)r=n[t],"belongsTo"!==r.type||r.isVirtual()||r.isEmbedded()||e.push(r.foreign_key);return e},e.prototype.joinTables=function(){var e,t;return function(){var r,n;r=this.relations,n=[];for(e in r)t=r[e],!t.isVirtual()&&t.join_table&&n.push(t.join_table);return n}.call(this)},e.prototype.relatedModels=function(){var e,t,r,n;t=[],n=this.relations;for(e in n)r=n[e],t.push(r.reverse_model_type),r.join_table&&t.push(r.join_table);return t},e.prototype.allColumns=function(){return this.columns()},e.prototype.allRelations=function(){return this.relatedModels()},e.prototype.generateBelongsTo=function(e){var t,r;return t=i.conventions.attribute(e.model_name),(r=this.relations[t])?r:this.raw[t]?(r=this._parseField(t,this.raw[t]),r.initialize(),r):(r=this._parseField(t,this.raw[t]=["belongsTo",e,{manual_fetch:!0}]),r.initialize(),r)},e.joinTableURL=function(e){var t,r;return t=i.conventions.tableName(e.model_type.model_name),r=i.conventions.tableName(e.reverse_relation.model_type.model_name),t.localeCompare(r)<0?""+t+"_"+r:""+r+"_"+t},e.prototype.generateJoinTable=function(t){var r,s,u,a;u={},u[t.join_key]=["Integer",{indexed:!0}],u[t.reverse_relation.join_key]=["Integer",{indexed:!0}],a=e.joinTableURL(t),s=i.conventions.modelName(a,!0);try{r=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return f(r,e),r.prototype.model_name=s,r.prototype.urlRoot=""+new o(h.result(new t.model_type,"url")).format({exclude_table:!0})+"/"+a,r.prototype.schema=u,r.prototype.sync=t.model_type.createSync(r),r}(n.Model)}catch(l){r=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return f(r,e),r.prototype.model_name=s,r.prototype.urlRoot="/"+a,r.prototype.schema=u,r.prototype.sync=t.model_type.createSync(r),r}(n.Model)}return r},e.prototype._parseField=function(e,t){var r,n,i;if(r=this._fieldInfoToOptions(h.isFunction(t)?t():t),!r.type)return this.fields[e]=r;if(!(i=a[r.type])){if(!h.isString(r.type))throw new Error("Unexpected type name is not a string: "+JSONUtils.stringify(r));return this.fields[e]=r}return r.type=i,n=this.relations[e]="hasMany"===i?new s(this.model_type,e,r):new u(this.model_type,e,r),n.virtual_id_accessor&&(this.virtual_accessors[n.virtual_id_accessor]=n),"belongsTo"===i&&(this.virtual_accessors[n.foreign_key]=n),n},e.prototype._fieldInfoToOptions=function(e){var t;if(h.isString(e))return{type:e};if(!h.isArray(e))return e;if(t={},h.isString(e[0])&&(t.type=e[0],e=e.slice(1),0===e.length))return t;if(h.isFunction(e[0])&&(t.reverse_model_type=e[0],e=e.slice(1)),e.length>1)throw new Error("Unexpected field options array: "+JSONUtils.stringify(e));return 1===e.length&&h.extend(t,e[0]),t},e}()},function(e,t,r){var n;n=r(15),e.exports=new n({destroy:function(e,t){return t.destroy()}})},function(e,t,r){var n,i;i=r(1),e.exports=n=function(){function e(){}return e.conventions=i.clone(r(25)),e.set=function(t){return e.conventions=t},e.get=function(){return e.conventions},e}()},function(e,t,r){var n,i,o,s,u,a,l,c,h,p;p=r(1),n=r(2),l=r(7),s=r(19),c=r(11),h=r(4),o=r(5),a=r(16).ModelCache,i=1e3,u=function(){function e(e){var t;this.model_type=e,this.model_type.model_name=h.findOrGenerateModelName(this.model_type),this.schema=new c(this.model_type),this.store=(t=this.model_type).store||(t.store={})}return e.prototype.initialize=function(){return this.is_initialized?void 0:(this.is_initialized=!0,this.schema.initialize())},e.prototype.read=function(e,t){var r,n;return e.models?t.success(function(){var e,t;e=this.store,t=[];for(r in e)n=e[r],t.push(o.deepClone(n));return t}.call(this)):p.isUndefined(this.store[e.id])?t.error(new Error("Model not found with id: "+e.id)):t.success(o.deepClone(this.store[e.id]))},e.prototype.create=function(e,t){var r,n;return(r={})[this.model_type.prototype.idAttribute]=h.guid(),e.set(r),n=this.store[e.id]=e.toJSON(),t.success(o.deepClone(n))},e.prototype.update=function(e,t){var r;return this.store[e.id]=r=e.toJSON(),t.success(o.deepClone(r))},e.prototype["delete"]=function(e,t){return this.store[e.id]?(delete this.store[e.id],t.success()):t.error(new Error("Model not found"))},e.prototype.resetSchema=function(e,t){return this.destroy({},t)},e.prototype.cursor=function(e){return null==e&&(e={}),new s(e,p.pick(this,["model_type","store"]))},e.prototype.destroy=function(e,t){var r;return 1===arguments.length&&(r=[{},e],e=r[0],t=r[1]),this.model_type.each(p.extend({$each:{limit:i,json:!0}},e),function(e){return function(t,r){return h.patchRemoveByJSON(e.model_type,t,function(n){return n||delete e.store[t[e.model_type.prototype.idAttribute]],r(n)})}}(this),t)},e}(),e.exports=function(t){var r,n,i;return h.isCollection(new t)?(r=h.configureCollectionModelType(t,e.exports),t.prototype.sync=r.prototype.sync):(n=new u(t),t.prototype.sync=i=function(t,r,i){return null==i&&(i={}),n.initialize(),"createSync"===t?e.exports.apply(null,Array.prototype.slice.call(arguments,1)):"sync"===t?n:"isRemote"===t?!1:"schema"===t?n.schema:"tableName"===t?void 0:n[t]?n[t].apply(n,Array.prototype.slice.call(arguments,1)):void 0},h.configureModelType(t),a.configureSync(t,i))},e.exports.Sync=u,e.exports.Cursor=s},function(e,t,r){var n,i,o,s=function(e,t){return function(){return e.apply(t,arguments)}};o=r(1),n=r(20),e.exports=i=function(){function e(e){var t,r,i;null==e&&(e={}),this.forEach=s(this.forEach,this),this.reset=s(this.reset,this),this.destroy=s(this.destroy,this),this.get=s(this.get,this),this.set=s(this.set,this),r={};for(t in e)i=e[t],"destroy"===t?t="dispose":"max_age"===t&&(t="maxAge"),r[t]=i;this.cache=new n(r)}return e.prototype.set=function(e,t,r){return t._orm_never_cache?("function"==typeof r?r(null,t):void 0)||this:(this.cache.set(e,t),"function"==typeof r&&r(null,t),this)},e.prototype.get=function(e,t){var r;return r=this.cache.get(e),"function"==typeof t&&t(null,r),r},e.prototype.destroy=function(e,t){return this.cache.del(e),"function"==typeof t&&t(),this},e.prototype.del=e.prototype.destroy,e.prototype.reset=function(e){return this.cache.reset(),"function"==typeof e&&e(),this},e.prototype.forEach=function(e){return this.cache.forEach(e)},e}()},function(e,t,r){e.exports={ModelCache:new(r(27))}},function(e,t,r){function n(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function i(e,t,r){if(e&&l.isObject(e)&&e instanceof n)return e;var i=new n;return i.parse(e,t,r),i}function o(e){return l.isString(e)&&(e=i(e)),e instanceof n?e.format():n.prototype.format.call(e)}function s(e,t){return i(e,!1,!0).resolve(t)}function u(e,t){return e?i(e,!1,!0).resolveObject(t):t}var a={encode:function(e){return e}},l=r(1),c=r(26);t.parse=i,t.resolve=s,t.resolveObject=u,t.format=o,t.Url=n;var h=/^([a-z0-9.+-]+:)/i,p=/:[0-9]*$/,f=["<",">",'"',"`"," ","\r","\n","	"],d=["{","}","|","\\","^","`"].concat(f),y=["'"].concat(d),_=["%","/","?",";","#"].concat(y),m=["/","?","#"],g=255,v=/^[a-z0-9A-Z_-]{0,63}$/,w=/^([a-z0-9A-Z_-]{0,63})(.*)$/,b={javascript:!0,"javascript:":!0},$={javascript:!0,"javascript:":!0},k={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},x=r(18);n.prototype.parse=function(e,t,r){if(!l.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var n=e;n=c.trim(n);var i=h.exec(n);if(i){i=i[0];var o=i.toLowerCase();this.protocol=o,n=n.substr(i.length)}if(r||i||n.match(/^\/\/[^@\/]+@[^@\/]+/)){var s="//"===n.substr(0,2);!s||i&&$[i]||(n=n.substr(2),this.slashes=!0)}if(!$[i]&&(s||i&&!k[i])){for(var u=-1,p=0;p<m.length;p++){var f=n.indexOf(m[p]);-1!==f&&(-1===u||u>f)&&(u=f)}var d,O;O=-1===u?n.lastIndexOf("@"):n.lastIndexOf("@",u),-1!==O&&(d=n.slice(0,O),n=n.slice(O+1),this.auth=decodeURIComponent(d)),u=-1;for(var p=0;p<_.length;p++){var f=n.indexOf(_[p]);-1!==f&&(-1===u||u>f)&&(u=f)}-1===u&&(u=n.length),this.host=n.slice(0,u),n=n.slice(u),this.parseHost(),this.hostname=this.hostname||"";var E="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!E)for(var R=this.hostname.split(/\./),p=0,S=R.length;S>p;p++){var C=R[p];if(C&&!C.match(v)){for(var N="",j=0,M=C.length;M>j;j++)N+=C.charCodeAt(j)>127?"x":C[j];if(!N.match(v)){var A=R.slice(0,p),T=R.slice(p+1),J=C.match(w);J&&(A.push(J[1]),T.unshift(J[2])),T.length&&(n="/"+T.join(".")+n),this.hostname=A.join(".");break}}}if(this.hostname=this.hostname.length>g?"":this.hostname.toLowerCase(),!E){for(var z=this.hostname.split("."),L=[],p=0;p<z.length;++p){var I=z[p];L.push(I.match(/[^A-Za-z0-9_-]/)?"xn--"+a.encode(I):I)}this.hostname=L.join(".")}var q=this.port?":"+this.port:"",U=this.hostname||"";this.host=U+q,this.href+=this.host,E&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==n[0]&&(n="/"+n))}if(!b[o])for(var p=0,S=y.length;S>p;p++){var F=y[p],P=encodeURIComponent(F);P===F&&(P=escape(F)),n=n.split(F).join(P)}var B=n.indexOf("#");-1!==B&&(this.hash=n.substr(B),n=n.slice(0,B));var D=n.indexOf("?");if(-1!==D?(this.search=n.substr(D),this.query=n.substr(D+1),t&&(this.query=x.parse(this.query)),n=n.slice(0,D)):t&&(this.search="",this.query={}),n&&(this.pathname=n),k[o]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var q=this.pathname||"",I=this.search||"";
this.path=q+I}return this.href=this.format(),this},n.prototype.format=function(){var e=this.auth||"";e&&(e=encodeURIComponent(e),e=e.replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",i=!1,o="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&l.isObject(this.query)&&l.keys(this.query).length&&(o=x.stringify(this.query));var s=this.search||o&&"?"+o||"";return t&&":"!==c.substr(t,-1)&&(t+=":"),this.slashes||(!t||k[t])&&i!==!1?(i="//"+(i||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):i||(i=""),n&&"#"!==n.charAt(0)&&(n="#"+n),s&&"?"!==s.charAt(0)&&(s="?"+s),r=r.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),s=s.replace("#","%23"),t+i+r+s+n},n.prototype.resolve=function(e){return this.resolveObject(i(e,!1,!0)).format()},n.prototype.resolveObject=function(e){if(l.isString(e)){var t=new n;t.parse(e,!1,!0),e=t}var r=new n;if(c.forEach(l.keys(this),function(e){r[e]=this[e]},this),r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol)return c.forEach(l.keys(e),function(t){"protocol"!==t&&(r[t]=e[t])}),k[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r;if(e.protocol&&e.protocol!==r.protocol){if(!k[e.protocol])return c.forEach(l.keys(e),function(t){r[t]=e[t]}),r.href=r.format(),r;if(r.protocol=e.protocol,e.host||$[e.protocol])r.pathname=e.pathname;else{for(var i=(e.pathname||"").split("/");i.length&&!(e.host=i.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==i[0]&&i.unshift(""),i.length<2&&i.unshift(""),r.pathname=i.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var o=r.pathname||"",s=r.search||"";r.path=o+s}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var u=r.pathname&&"/"===r.pathname.charAt(0),a=e.host||e.pathname&&"/"===e.pathname.charAt(0),h=a||u||r.host&&e.pathname,p=h,f=r.pathname&&r.pathname.split("/")||[],i=e.pathname&&e.pathname.split("/")||[],d=r.protocol&&!k[r.protocol];if(d&&(r.hostname="",r.port=null,r.host&&(""===f[0]?f[0]=r.host:f.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===i[0]?i[0]=e.host:i.unshift(e.host)),e.host=null),h=h&&(""===i[0]||""===f[0])),a)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,f=i;else if(i.length)f||(f=[]),f.pop(),f=f.concat(i),r.search=e.search,r.query=e.query;else if(!l.isNull(e.search)&&!l.isUndefined(e.search)){if(d){r.hostname=r.host=f.shift();var y=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;y&&(r.auth=y.shift(),r.host=r.hostname=y.shift())}return r.search=e.search,r.query=e.query,l.isNull(r.pathname)&&l.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!f.length)return r.pathname=null,r.path=r.search?"/"+r.search:null,r.href=r.format(),r;for(var _=f.slice(-1)[0],m=(r.host||e.host)&&("."===_||".."===_)||""===_,g=0,v=f.length;v>=0;v--)_=f[v],"."==_?f.splice(v,1):".."===_?(f.splice(v,1),g++):g&&(f.splice(v,1),g--);if(!h&&!p)for(;g--;g)f.unshift("..");!h||""===f[0]||f[0]&&"/"===f[0].charAt(0)||f.unshift(""),m&&"/"!==c.substr(f.join("/"),-1)&&f.push("");var w=""===f[0]||f[0]&&"/"===f[0].charAt(0);if(d){r.hostname=r.host=w?"":f.length?f.shift():"";var y=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;y&&(r.auth=y.shift(),r.host=r.hostname=y.shift())}return h=h||r.host&&f.length,h&&!w&&f.unshift(""),f.length?r.pathname=f.join("/"):(r.pathname=null,r.path=null),l.isNull(r.pathname)&&l.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},n.prototype.parseHost=function(){var e=this.host,t=p.exec(e);t&&(t=t[0],":"!==t&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,r){function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var i=t,o=r(1);i.unescape=function(e){return decodeURIComponent(e)},i.escape=function(e){return encodeURIComponent(e)};var s=function(e){return o.isString(e)?e:o.isBoolean(e)?e?"true":"false":o.isNumber(e)&&isFinite(e)?e:""};i.stringify=i.encode=function(e,t,r,n){return t=t||"&",r=r||"=",o.isNull(e)&&(e=void 0),o.isObject(e)?o.map(o.keys(e),function(n){var u=i.escape(s(n))+r;return o.isArray(e[n])?o.map(e[n],function(e){return u+i.escape(s(e))}).join(t):u+i.escape(s(e[n]))}).join(t):n?i.escape(s(n))+r+i.escape(s(e)):""},i.parse=i.decode=function(e,t,r,s){t=t||"&",r=r||"=";var u={};if(!o.isString(e)||0===e.length)return u;var a=/\+/g;e=e.split(t);var l=1e3;s&&o.isNumber(s.maxKeys)&&(l=s.maxKeys);var c=e.length;l>0&&c>l&&(c=l);for(var h=0;c>h;++h){var p,f,d,y,_=e[h].replace(a,"%20"),m=_.indexOf(r);m>=0?(p=_.substr(0,m),f=_.substr(m+1)):(p=_,f="");try{d=decodeURIComponent(p),y=decodeURIComponent(f)}catch(g){d=i.unescape(p,!0),y=i.unescape(f,!0)}n(u,d)?o.isArray(u[d])?u[d].push(y):u[d]=[u[d],y]:u[d]=y}return u}},function(e,t,r){var n,i,o,s,u,a,l,c,h,p,f,d={}.hasOwnProperty,y=function(e,t){function r(){this.constructor=e}for(var n in t)d.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},_=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};f=r(1),l=r(7),c=r(4),u=r(5),i=r(6),n=r(10),o={$ne:function(e,t){return!f.isEqual(e,t)},$lt:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?i.isBefore(e,t):t>e},$lte:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?!i.isAfter(e,t):t>=e},$gt:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?i.isAfter(e,t):e>t},$gte:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?!i.isBefore(e,t):e>=t}},s=f.keys(o),p=function(e){return f.isArray(e)?e:f.isNull(e)?[]:e.$in?e.$in:[e]},h=function(e,t,r){return e[t]=e.hasOwnProperty(t)?{$in:f.intersection(p(e[t]),p(r))}:r},e.exports=a=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return y(t,e),t.prototype.queryToJSON=function(e){var r;return this.hasCursorQuery("$zero")?e(null,this.hasCursorQuery("$one")?null:[]):(r=this.hasCursorQuery("$exists"),this.buildFindQuery(function(n){return function(i,o){var s,a,h;return i?e(i):(s=[],a=f.keys(o),h=new l(1),h.defer(function(e){var t,i,c,h,p,d,y,m,g,v,w,b,$,k,x;w=[{},{}],c=w[0],y=w[1];for(p in o)g=o[p],(null!=g?g.$in:void 0)&&(delete o[p],c[p]=g.$in),(null!=g?g.$nin:void 0)&&(delete o[p],y[p]=g.$nin);if(b=[f.size(c),f.size(y)],h=b[0],m=b[1],a.length||h||m){if(n._cursor.$ids){$=n.store;for(i in $)d=$[i],f.contains(n._cursor.$ids,i)&&f.isEqual(f.pick(d,a),o)&&s.push(u.deepClone(d));return e()}t=new l,k=n.store,v=function(e){return t.defer(function(t){var i,a;return r&&s.length?t():(i=f.keys(o),(a=function(r,l){return r||!l?t(r):i.length?n._valueIsMatch(o,i.pop(),e,a):(s.push(u.deepClone(e)),t())})(null,!0))})};for(i in k)d=k[i],v(d);return t.await(function(t){return t?e(t):(h&&(s=f.filter(s,function(e){var t,r;for(p in c)if(t=c[p],r=e[p],_.call(t,r)>=0)return!0})),m&&(s=f.filter(s,function(e){var t,r;for(p in y)if(t=y[p],r=e[p],_.call(t,r)<0)return!0})),e())})}if(n._cursor.$ids){x=n.store;for(i in x)d=x[i],f.contains(n._cursor.$ids,i)&&s.push(u.deepClone(d))}else s=function(){var e,t;e=this.store,t=[];for(i in e)d=e[i],t.push(u.deepClone(d));return t}.call(n);return e()}),r||(h.defer(function(e){var t,r;return n._cursor.$sort&&(t=f.isArray(n._cursor.$sort)?n._cursor.$sort:[n._cursor.$sort],s.sort(function(e,r){return c.jsonFieldCompare(e,r,t)})),n._cursor.$offset&&(r=s.length-n._cursor.$offset,0>r&&(r=0),s=r?s.slice(n._cursor.$offset,n._cursor.$offset+r):[]),n._cursor.$one?s=s.slice(0,1):n._cursor.$limit&&(s=s.splice(0,Math.min(s.length,n._cursor.$limit))),e()}),h.defer(function(e){return n.fetchIncludes(s,e)})),void h.await(function(){var i;return n.hasCursorQuery("$count")?e(null,f.isArray(s)?s.length:s?1:0):r?e(null,f.isArray(s)?!!s.length:s):n.hasCursorQuery("$page")?(i=new t(n._find,f.extend(f.pick(n,["model_type","store"]))),i.count(function(t,r){return t?e(t):e(null,{offset:n._cursor.$offset||0,total_rows:r,rows:n.selectResults(s)})})):e(null,n.selectResults(s))}))}}(this)))},t.prototype.buildFindQuery=function(e){var t,r,n,i,o,s,a,c,p,f;n=new l,t={},p=this._find,c=function(e){return function(i,o,s){return n.defer(function(n){var u,a;return(a=e.model_type.relation(i))?a.join_table||"id"!==o?a.join_table||"belongsTo"===a.type?((u={$values:"id"})[o]=s,a.reverse_relation.model_type.cursor(u).toJSON(function(e,r){var i;return e?n(e):a.join_table?((i={})[a.reverse_relation.join_key]={$in:r},i.$values=a.foreign_key,a.join_table.cursor(i).toJSON(function(e,r){return e?n(e):(h(t,"id",{$in:r}),n())})):(h(t,a.foreign_key,{$in:r}),n())})):((u={})[o]=s,u.$values=a.foreign_key,a.reverse_model_type.cursor(u).toJSON(function(e,r){return e?n(e):(h(t,"id",{$in:r}),n())})):(h(t,a.foreign_key,s),n()):(h(t,r,s),n())})}}(this);for(r in p)if(s=p[r],r.indexOf(".")<0){if(!(o=this.model_type.reverseRelation(r))){h(t,r,s);continue}if(!o.embed&&!o.join_table){h(t,r,s);continue}!function(e){return function(r,i,o){return n.defer(function(n){var s;if(o.embed)throw Error("Embedded find is not yet supported. @_find: "+u.stringify(e._find));return(s={})[r]=i,s.$values=o.reverse_relation.join_key,o.join_table.cursor(s).toJSON(function(e,r){return e?n(e):(h(t,"id",{$in:r}),n())})})}}(this)(r,s,o)}else f=r.split("."),i=f[0],a=f[1],this.model_type.relationIsEmbedded(i)?h(t,r,s):c(i,a,s);return n.await(function(){return function(r){return e(r,t)}}(this))},t.prototype.fetchIncludes=function(e,t){var r,n,i,o,s,u,a,c,h,p;if(!this._cursor.$include)return t();for(i=new l(1),r=f.isArray(this._cursor.$include)?this._cursor.$include:[this._cursor.$include],a=0,h=r.length;h>a;a++)if(n=r[a],!this.model_type.relationIsEmbedded(n)){if(!(s=this.model_type.relation(n)))return t(new Error("Included relation '"+n+"' is not a relation"));for(u=function(){return function(e,t){return i.defer(function(r){return s.cursor(t,e).toJSON(function(n,i){return n?calback(n):(delete t[s.foriegn_key],t[e]=i,r())})})}}(this),c=0,p=e.length;p>c;c++)o=e[c],u(n,o)}return i.await(t)},t.prototype._valueIsMatch=function(e,t,r,n){var i,u,a;return i=t.split("."),u=this.model_type,(a=function(){return function(l,c){var h,p,d,y,_,m,g,v,w,b,$;if(l)return n(l);if(d=i.shift(),"id"===d&&(d=u.prototype.idAttribute),!i.length){for(g=!1,h=e[t],f.isArray(c)||(c=[c]),v=0,b=c.length;b>v;v++){if(r=c[v],y=r[d],f.isObject(h))for(w=0,$=s.length;$>w&&(_=s[w],!h.hasOwnProperty(_)||(g=!0,p=o[_](y,h[_])));w++);if(g){if(p)return n(null,p)}else if(p=f.isEqual(y,h))return n(null,p)}return n(null,!1)}return(m=u.relation(d))&&!m.embed?m.cursor(r,d).toJSON(a):a(null,r[d])}}(this))(null,r)},t}(n)},function(e){!function(){function t(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function r(){return 1}function n(e){return this instanceof n?("number"==typeof e&&(e={max:e}),e||(e={}),this._max=e.max,(!this._max||"number"!=typeof this._max||this._max<=0)&&(this._max=1/0),this._lengthCalculator=e.length||r,"function"!=typeof this._lengthCalculator&&(this._lengthCalculator=r),this._allowStale=e.stale||!1,this._maxAge=e.maxAge||null,this._dispose=e.dispose,void this.reset()):new n(e)}function i(e,t,r){var n=e._cache[t];return n&&(e._maxAge&&Date.now()-n.now>e._maxAge?(a(e,n),e._allowStale||(n=void 0)):r&&o(e,n),n&&(n=n.value)),n}function o(e,t){u(e,t),t.lu=e._mru++,e._lruList[t.lu]=t}function s(e){for(;e._lru<e._mru&&e._length>e._max;)a(e,e._lruList[e._lru])}function u(e,t){for(delete e._lruList[t.lu];e._lru<e._mru&&!e._lruList[e._lru];)e._lru++}function a(e,t){t&&(e._dispose&&e._dispose(t.key,t.value),e._length-=t.length,e._itemCount--,delete e._cache[t.key],u(e,t))}function l(e,t,r,n,i){this.key=e,this.value=t,this.lu=r,this.length=n,this.now=i}"object"==typeof e&&e.exports?e.exports=n:this.LRUCache=n,Object.defineProperty(n.prototype,"max",{set:function(e){(!e||"number"!=typeof e||0>=e)&&(e=1/0),this._max=e,this._length>this._max&&s(this)},get:function(){return this._max},enumerable:!0}),Object.defineProperty(n.prototype,"lengthCalculator",{set:function(e){if("function"!=typeof e){this._lengthCalculator=r,this._length=this._itemCount;for(var t in this._cache)this._cache[t].length=1}else{this._lengthCalculator=e,this._length=0;for(var t in this._cache)this._cache[t].length=this._lengthCalculator(this._cache[t].value),this._length+=this._cache[t].length}this._length>this._max&&s(this)},get:function(){return this._lengthCalculator},enumerable:!0}),Object.defineProperty(n.prototype,"length",{get:function(){return this._length},enumerable:!0}),Object.defineProperty(n.prototype,"itemCount",{get:function(){return this._itemCount},enumerable:!0}),n.prototype.forEach=function(e,t){t=t||this;for(var r=0,n=this._mru-1;n>=0&&r<this._itemCount;n--)if(this._lruList[n]){r++;var i=this._lruList[n];this._maxAge&&Date.now()-i.now>this._maxAge&&(a(this,i),this._allowStale||(i=void 0)),i&&e.call(t,i.value,i.key,this)}},n.prototype.keys=function(){for(var e=new Array(this._itemCount),t=0,r=this._mru-1;r>=0&&t<this._itemCount;r--)if(this._lruList[r]){var n=this._lruList[r];e[t++]=n.key}return e},n.prototype.values=function(){for(var e=new Array(this._itemCount),t=0,r=this._mru-1;r>=0&&t<this._itemCount;r--)if(this._lruList[r]){var n=this._lruList[r];e[t++]=n.value}return e},n.prototype.reset=function(){if(this._dispose&&this._cache)for(var e in this._cache)this._dispose(e,this._cache[e].value);this._cache=Object.create(null),this._lruList=Object.create(null),this._mru=0,this._lru=0,this._length=0,this._itemCount=0},n.prototype.dump=function(){return this._cache},n.prototype.dumpLru=function(){return this._lruList},n.prototype.set=function(e,r){if(t(this._cache,e))return this._dispose&&this._dispose(e,this._cache[e].value),this._maxAge&&(this._cache[e].now=Date.now()),this._cache[e].value=r,this.get(e),!0;var n=this._lengthCalculator(r),i=this._maxAge?Date.now():0,o=new l(e,r,this._mru++,n,i);return o.length>this._max?(this._dispose&&this._dispose(e,r),!1):(this._length+=o.length,this._lruList[o.lu]=this._cache[e]=o,this._itemCount++,this._length>this._max&&s(this),!0)},n.prototype.has=function(e){if(!t(this._cache,e))return!1;var r=this._cache[e];return this._maxAge&&Date.now()-r.now>this._maxAge?!1:!0},n.prototype.get=function(e){return i(this,e,!0)},n.prototype.peek=function(e){return i(this,e,!1)},n.prototype.pop=function(){var e=this._lruList[this._lru];return a(this,e),e||null},n.prototype.del=function(e){a(this,this._cache[e])}}()},function(e,t){var r,n;!function(t,i){r=[],n=i.apply(null,r),!(void 0!==n&&(e.exports=n))}(this,function(){var e=["equipment","information","rice","money","species","series","fish","sheep","moose","deer","news"],t=[[new RegExp("(m)en$","gi")],[new RegExp("(pe)ople$","gi")],[new RegExp("(child)ren$","gi")],[new RegExp("([ti])a$","gi")],[new RegExp("((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$","gi")],[new RegExp("(hive)s$","gi")],[new RegExp("(tive)s$","gi")],[new RegExp("(curve)s$","gi")],[new RegExp("([lr])ves$","gi")],[new RegExp("([^fo])ves$","gi")],[new RegExp("([^aeiouy]|qu)ies$","gi")],[new RegExp("(s)eries$","gi")],[new RegExp("(m)ovies$","gi")],[new RegExp("(x|ch|ss|sh)es$","gi")],[new RegExp("([m|l])ice$","gi")],[new RegExp("(bus)es$","gi")],[new RegExp("(o)es$","gi")],[new RegExp("(shoe)s$","gi")],[new RegExp("(cris|ax|test)es$","gi")],[new RegExp("(octop|vir)i$","gi")],[new RegExp("(alias|status)es$","gi")],[new RegExp("^(ox)en","gi")],[new RegExp("(vert|ind)ices$","gi")],[new RegExp("(matr)ices$","gi")],[new RegExp("(quiz)zes$","gi")],[new RegExp("(m)an$","gi"),"$1en"],[new RegExp("(pe)rson$","gi"),"$1ople"],[new RegExp("(child)$","gi"),"$1ren"],[new RegExp("^(ox)$","gi"),"$1en"],[new RegExp("(ax|test)is$","gi"),"$1es"],[new RegExp("(octop|vir)us$","gi"),"$1i"],[new RegExp("(alias|status)$","gi"),"$1es"],[new RegExp("(bu)s$","gi"),"$1ses"],[new RegExp("(buffal|tomat|potat)o$","gi"),"$1oes"],[new RegExp("([ti])um$","gi"),"$1a"],[new RegExp("sis$","gi"),"ses"],[new RegExp("(?:([^f])fe|([lr])f)$","gi"),"$1$2ves"],[new RegExp("(hive)$","gi"),"$1s"],[new RegExp("([^aeiouy]|qu)y$","gi"),"$1ies"],[new RegExp("(x|ch|ss|sh)$","gi"),"$1es"],[new RegExp("(matr|vert|ind)ix|ex$","gi"),"$1ices"],[new RegExp("([m|l])ouse$","gi"),"$1ice"],[new RegExp("(quiz)$","gi"),"$1zes"],[new RegExp("s$","gi"),"s"],[new RegExp("$","gi"),"s"]],r=[[new RegExp("(m)an$","gi")],[new RegExp("(pe)rson$","gi")],[new RegExp("(child)$","gi")],[new RegExp("^(ox)$","gi")],[new RegExp("(ax|test)is$","gi")],[new RegExp("(octop|vir)us$","gi")],[new RegExp("(alias|status)$","gi")],[new RegExp("(bu)s$","gi")],[new RegExp("(buffal|tomat|potat)o$","gi")],[new RegExp("([ti])um$","gi")],[new RegExp("sis$","gi")],[new RegExp("(?:([^f])fe|([lr])f)$","gi")],[new RegExp("(hive)$","gi")],[new RegExp("([^aeiouy]|qu)y$","gi")],[new RegExp("(x|ch|ss|sh)$","gi")],[new RegExp("(matr|vert|ind)ix|ex$","gi")],[new RegExp("([m|l])ouse$","gi")],[new RegExp("(quiz)$","gi")],[new RegExp("(m)en$","gi"),"$1an"],[new RegExp("(pe)ople$","gi"),"$1rson"],[new RegExp("(child)ren$","gi"),"$1"],[new RegExp("([ti])a$","gi"),"$1um"],[new RegExp("((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$","gi"),"$1$2sis"],[new RegExp("(hive)s$","gi"),"$1"],[new RegExp("(tive)s$","gi"),"$1"],[new RegExp("(curve)s$","gi"),"$1"],[new RegExp("([lr])ves$","gi"),"$1f"],[new RegExp("([^fo])ves$","gi"),"$1fe"],[new RegExp("(m)ovies$","gi"),"$1ovie"],[new RegExp("([^aeiouy]|qu)ies$","gi"),"$1y"],[new RegExp("(s)eries$","gi"),"$1eries"],[new RegExp("(x|ch|ss|sh)es$","gi"),"$1"],[new RegExp("([m|l])ice$","gi"),"$1ouse"],[new RegExp("(bus)es$","gi"),"$1"],[new RegExp("(o)es$","gi"),"$1"],[new RegExp("(shoe)s$","gi"),"$1"],[new RegExp("(cris|ax|test)es$","gi"),"$1is"],[new RegExp("(octop|vir)i$","gi"),"$1us"],[new RegExp("(alias|status)es$","gi"),"$1"],[new RegExp("^(ox)en","gi"),"$1"],[new RegExp("(vert|ind)ices$","gi"),"$1ex"],[new RegExp("(matr)ices$","gi"),"$1ix"],[new RegExp("(quiz)zes$","gi"),"$1"],[new RegExp("ss$","gi"),"ss"],[new RegExp("s$","gi"),""]],n=["and","or","nor","a","an","the","so","but","to","of","at","by","from","into","on","onto","off","out","in","over","with","for"],i=new RegExp("(_ids|_id)$","g"),o=new RegExp("_","g"),s=new RegExp("[ _]","g"),u=new RegExp("([A-Z])","g"),a=new RegExp("^_"),l={_apply_rules:function(e,t,r,n){if(n)e=n;else{var i=l.indexOf(r,e.toLowerCase())>-1;if(!i)for(var o=0,s=t.length;s>o;o++)if(e.match(t[o][0])){void 0!==t[o][1]&&(e=e.replace(t[o][0],t[o][1]));break}}return e},indexOf:function(e,t,r,n){r||(r=-1);for(var i=-1,o=r,s=e.length;s>o;o++)if(e[o]===t||n&&n(e[o],t)){i=o;break}return i},pluralize:function(r,n){return l._apply_rules(r,t,e,n)},singularize:function(t,n){return l._apply_rules(t,r,e,n)},camelize:function(e,t){for(var r,n,i,o,s=e.split("/"),u=0,a=s.length;a>u;u++){for(r=s[u].split("_"),n=0,i=r.length;i>n;n++)0!==n&&(r[n]=r[n].toLowerCase()),o=r[n].charAt(0),o=t&&0===u&&0===n?o.toLowerCase():o.toUpperCase(),r[n]=o+r[n].substring(1);s[u]=r.join("")}return s.join("::")},underscore:function(e,t){if(t&&e===e.toUpperCase())return e;for(var r=e.split("::"),n=0,i=r.length;i>n;n++)r[n]=r[n].replace(u,"_$1"),r[n]=r[n].replace(a,"");return r.join("/").toLowerCase()},humanize:function(e,t){return e=e.toLowerCase(),e=e.replace(i,""),e=e.replace(o," "),t||(e=l.capitalize(e)),e},capitalize:function(e){return e=e.toLowerCase(),e.substring(0,1).toUpperCase()+e.substring(1)},dasherize:function(e){return e.replace(s,"-")},titleize:function(e){e=e.toLowerCase().replace(o," ");for(var t,r,i,s=e.split(" "),u=0,a=s.length;a>u;u++){for(t=s[u].split("-"),r=0,i=t.length;i>r;r++)l.indexOf(n,t[r].toLowerCase())<0&&(t[r]=l.capitalize(t[r]));s[u]=t.join("-")}return e=s.join(" "),e=e.substring(0,1).toUpperCase()+e.substring(1)},demodulize:function(e){var t=e.split("::");return t[t.length-1]},tableize:function(e){return e=l.underscore(e),e=l.pluralize(e)},classify:function(e){return e=l.camelize(e),e=l.singularize(e)},foreign_key:function(e,t){return e=l.demodulize(e),e=l.underscore(e)+(t?"":"_")+"id"},ordinalize:function(e){for(var t=e.split(" "),r=0,n=t.length;n>r;r++){var i=parseInt(t[r],10);if(!isNaN(i)){var o=t[r].substring(t[r].length-2),s=t[r].substring(t[r].length-1),u="th";"11"!=o&&"12"!=o&&"13"!=o&&("1"===s?u="st":"2"===s?u="nd":"3"===s&&(u="rd")),t[r]+=u}}return t.join(" ")},transform:function(e,t){for(var r=0,n=t.length;n>r;r++){var i=t[r];this.hasOwnProperty(i)&&(e=this[i](e))}return e}};return l.version="1.3.8",l})},function(e,t,r){var n,i,o,s,u,a,l,c;c=r(1),n=r(2),s=r(7),u=r(4),o=r(29),a=r(30),l=r(31),i=r(8),r(32),e.exports=function(e){var t,r,n,i,h,p;if(t=function(){function e(){}return e}(),e.createSync=function(t){return e.prototype.sync("createSync",t)},e.resetSchema=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("resetSchema",t,r)},e.cursor=function(t){return null==t&&(t={}),e.prototype.sync("cursor",t)},e.destroy=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),c.isObject(t)||(t={id:t}),e.prototype.sync("destroy",t,r)},e.db=function(){return e.prototype.sync("db")},e.exists=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).exists(r)},e.count=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).count(r)},e.all=function(t){return e.prototype.sync("cursor",{}).toModels(t)},e.find=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).toModels(r)},e.findOne=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),t=c.isObject(t)?c.extend({$one:!0},t):{id:t,$one:!0},e.prototype.sync("cursor",t).toModels(r)},e.findOrCreate=function(t,r){var n;if(!c.isObject(t)||u.isModel(t)||u.isCollection(t))throw"findOrCreate requires object data";return n=c.extend({$one:!0},t),e.prototype.sync("cursor",n).toModels(function(n,i){return n?r(n):i?r(null,i):new e(t).save(r)})},e.findOneNearestDate=function(t,r,n,i){var o,s,u,a;if(!(s=r.key))throw new Error("Missing options key");return 2===arguments.length?(u=[{},n],n=u[0],i=u[1]):3===arguments.length?(a=[new Date,{},n],r=a[0],n=a[1],i=a[2]):n=c.clone(n),n.$one=!0,o=[function(){return function(r){return n[s]={$lte:t},e.cursor(n).sort("-"+s).toModels(r)}}(this),function(){return function(r){return n[s]={$gte:t},e.cursor(n).sort(s).toModels(r)}}(this)],r.reverse&&(o=[o[1],o[0]]),o[0](function(e,t){return e?i(e):t?i(null,t):o[1](i)})},e.each=function(t,r,n){var i;return 2===arguments.length&&(i=[{},t,r],t=i[0],r=i[1],n=i[2]),a(e,t,r,n)},e.eachC=function(t,r,n){var i;return 2===arguments.length&&(i=[{},t,r],t=i[0],r=i[1],n=i[2]),a(e,t,n,r)},e.stream=function(t){if(null==t&&(t={}),!c.isFunction(o))throw new Error('Stream is a large dependency so you need to manually include "stream.js" in the browser.');return new o(e,t)},e.interval=function(t,r,n){return l(e,t,r,n)},e.intervalC=function(t,r,n){return l(e,t,n,r)},e.prototype.modelName=function(){return e.model_name},e.prototype.cache=function(){return e.cache},e.prototype.schema=e.schema=function(){return e.prototype.sync("schema")},e.prototype.tableName=e.tableName=function(){return e.prototype.sync("tableName")},e.prototype.relation=e.relation=function(t){var r;return(r=e.prototype.sync("schema"))?r.relation(t):void 0},e.prototype.relationIsEmbedded=e.relationIsEmbedded=function(t){var r;return(r=e.relation(t))?!!r.embed:!1},e.prototype.reverseRelation=e.reverseRelation=function(t){var r;return(r=e.prototype.sync("schema"))?r.reverseRelation(t):void 0},e.prototype.isLoaded=function(e){return 0===arguments.length&&(e="__model__"),!u.orSet(this,"needs_load",{})[e]},e.prototype.setLoaded=function(e,t){var r,n;return 1===arguments.length&&(n=["__model__",e],e=n[0],t=n[1]),r=u.orSet(this,"needs_load",{}),t&&u.get(this,"is_initialized")?void delete r[e]:r[e]=!t},e.prototype.isLoadedExists=function(e){return 0===arguments.length&&(e="__model__"),u.orSet(this,"needs_load",{}).hasOwnProperty(e)},e.prototype.isPartial=function(){return!!u.get(this,"partial")},e.prototype.setPartial=function(e){return e?u.set(this,"partial",!0):u.unset(this,"partial")},e.prototype.addUnset=function(e){var t;return t=u.orSet(this,"unsets",[]),t.indexOf(e)<0?t.push(e):void 0},e.prototype.removeUnset=function(e){var t,r;if(r=u.get(this,"unsets",null))return(t=r.indexOf(e))>=0?r.splice(t,1):void 0},e.prototype.fetchRelated=function(e,t){var r,n;return 1===arguments.length&&(n=[null,e],e=n[0],t=n[1]),r=new s(1),r.defer(function(e){return function(t){return e.isLoaded()?t():e.fetch(t)}}(this)),r.defer(function(t){return function(r){var n,i,o,a,l,h;for(i=c.keys(u.orSet(t,"needs_load",{})),e&&!c.isArray(e)&&(e=[e]),c.isArray(e)&&(i=c.intersection(i,e)),o=new s,a=function(e){return o.defer(function(r){return t.get(e,r)})},l=0,h=i.length;h>l;l++)n=i[l],a(n);return o.await(r)}}(this)),r.await(t)},e.prototype.patchAdd=function(e,t,r){var n;return(n=this.relation(e))?t?n.patchAdd(this,t,r):r(new Error("patchAdd: missing relateds for '"+e+"'")):r(new Error("patchAdd: relation '"+e+"' unrecognized"))},e.prototype.patchRemove=function(t,r,n){var i,o,u,a,l;if(1===arguments.length){n=t,u=e.schema(),i=new s(1),l=u.relations,a=function(e){return function(t){return i.defer(function(r){return t.patchRemove(e,r)})}}(this);for(t in l)o=l[t],a(o);return i.await(n)}return(o=this.relation(t))?2===arguments.length?(n=r,o.patchRemove(this,n)):r?o.patchRemove(this,r,n):n(new Error("patchRemove: missing relateds for '"+t+"'")):n(new Error("patchRemove: relation '"+t+"' unrecognized"))},e.prototype.cursor=function(t,r){var n,i;if(null==r&&(r={}),e.schema&&(i=e.schema()),i&&(n=i.relation(t)))return n.cursor(this,t,r);throw new Error(""+i.model_name+"::cursor: Unexpected key: "+t+" is not a relation")},h=function(e,t){var r,n,i,o;return e.isNew()||!e.modelName?e.clone(t):(r=(i=t._cache)[o=e.modelName()]||(i[o]={}),(n=r[e.id])||(n=r[e.id]=e.clone(t)),n)},i={initialize:function(){var t,r,n,i,o,s;if(e.schema&&(i=e.schema())){s=i.relations;for(t in s)n=s[t],n.initializeModel(this);r=u.orSet(this,"needs_load",{});for(t in r)o=r[t],o||delete r[t];u.set(this,"is_initialized",!0)}return e.prototype._orm_original_fns.initialize.apply(this,arguments)},fetch:function(t){var r;if(c.isFunction(r=arguments[arguments.length-1]))switch(arguments.length){case 1:t=u.wrapOptions({},r);break;case 2:t=u.wrapOptions(t,r)}else t||(t={});return e.prototype._orm_original_fns.fetch.call(this,u.wrapOptions(t,function(e){return function(t,r,n,i){return t?"function"==typeof i.error?i.error(e,n,i):void 0:(e.setLoaded(!0),"function"==typeof i.success?i.success(e,n,i):void 0)}}(this)))},unset:function(t){var r;return this.addUnset(t),r=this.id,e.prototype._orm_original_fns.unset.apply(this,arguments),"id"===t&&e.cache&&r&&e.cache.get(r)===this?e.cache.destroy(r):void 0},set:function(t,r,n){var i,o,s,u,a;if(!e.schema||!(u=e.schema()))return e.prototype._orm_original_fns.set.apply(this,arguments);c.isString(t)?(i={})[t]=r:(i=t,n=r),a={},s={};for(t in i)r=i[t],(o=u.relation(t))?s[t]=o:a[t]=r;c.size(a)&&e.prototype._orm_original_fns.set.call(this,a,n);for(t in s)o=s[t],o.set(this,t,i[t],n);return this},get:function(t,r){var n,i,o;return e.schema&&(i=e.schema()),i&&(n=i.relation(t))?n.get(this,t,r):(o=e.prototype._orm_original_fns.get.call(this,t),r&&r(null,o),o)},toJSON:function(t){var r,n,i,o,s,a,l,h,p;if(null==t&&(t={}),e.schema&&(s=e.schema()),this._orm||(this._orm={}),this._orm.json>0)return this.id;for((l=this._orm).json||(l.json=0),this._orm.json++,r={},i=t.keys||this.whitelist||c.keys(this.attributes),h=0,p=i.length;p>h;h++)n=i[h],a=this.attributes[n],s&&(o=s.relation(n))?o.appendJSON(r,this):r[n]=u.isCollection(a)?c.map(a.models,function(e){return e?e.toJSON(t):null}):u.isModel(a)?a.toJSON(t):a;return--this._orm.json,r},save:function(t,r,n){var i,o,a;if(c.isFunction(o=arguments[arguments.length-1]))switch(arguments.length){case 1:i={},n=u.wrapOptions({},o);break;case 2:i=t,n=u.wrapOptions({},o);break;case 3:i=t,n=u.wrapOptions(r,o);break;case 4:(i={})[t]=r,n=u.wrapOptions(n,o)}else 0===arguments.length?(i={},n={}):null===t||c.isObject(t)?(i=t,n=r):(i={})[t]=r;return this.isLoaded()?(this._orm||(this._orm={}),this._orm.save>0?this.id?"function"==typeof n.success?n.success(this,{},n):void 0:"function"==typeof n.error?n.error(this,new Error("Model is in a save loop: "+e.model_name)):void 0:((a=this._orm).save||(a.save=0),this._orm.save++,this.set(i,n),i={},u.presaveBelongsToRelationships(this,function(r){return function(o){return o?"function"==typeof n.error?n.error(r,o):void 0:e.prototype._orm_original_fns.save.call(r,i,u.wrapOptions(n,function(n,i,o,a){var l,c,h,p,f;if(u.unset(r,"unsets"),--r._orm.save,n)return"function"==typeof a.error?a.error(r,o,a):void 0;if(l=new s(1),e.schema){h=e.schema(),f=h.relations,p=function(e){return l.defer(function(t){return e.save(r,t)})};for(t in f)c=f[t],p(c)}return l.await(function(t){var n;return t?"function"==typeof a.error?a.error(r,Error("Failed to save relations. "+t,a)):void 0:((n=e.cache)&&n.set(r.id,r),"function"==typeof a.success?a.success(r,o,a):void 0)})}))}}(this)))):"function"==typeof n.error?n.error(this,new Error("An unloaded model is trying to be saved: "+e.model_name)):void 0},destroy:function(t){var r,n,i,o;if(c.isFunction(n=arguments[arguments.length-1]))switch(arguments.length){case 1:t=u.wrapOptions({},n);break;case 2:t=u.wrapOptions(t,n)}if((r=this.cache())&&r.destroy(this.id),!e.schema||!(i=e.schema()))return e.prototype._orm_original_fns.destroy.call(this,t);if(this._orm||(this._orm={}),this._orm.destroy>0)throw new Error("Model is in a destroy loop: "+e.model_name);return(o=this._orm).destroy||(o.destroy=0),this._orm.destroy++,e.prototype._orm_original_fns.destroy.call(this,u.wrapOptions(t,function(e){return function(t,r,n,i){return--e._orm.destroy,t?"function"==typeof i.error?i.error(e,n,i):void 0:e.patchRemove(function(t){return t?"function"==typeof i.error?i.error(e,new Error("Failed to destroy relations. "+t,i)):void 0:"function"==typeof i.success?i.success(e,n,i):void 0})}}(this)))},clone:function(t){var r,n,i,o,s,a,l,p,f,d,y,_;if(!e.schema)return e.prototype._orm_original_fns.clone.apply(this,arguments);if(t||(t={}),t._cache||(t._cache={}),r=(l=t._cache)[y=this.modelName()]||(l[y]={}),this._orm||(this._orm={}),this._orm.clone>0)return this.id?r[this.id]:e.prototype._orm_original_fns.clone.apply(this,arguments);for((p=this._orm).clone||(p.clone=0),this._orm.clone++,this.id?(n=r[this.id])||(r[this.id]=n=new this.constructor):n=new this.constructor,this.attributes.id&&(n.id=this.attributes.id),o=t.keys||c.keys(this.attributes),f=0,d=o.length;d>f;f++)i=o[f],a=this.attributes[i],u.isCollection(a)?((null!=(_=n.attributes[i])?_.values:void 0)||(n.attributes[i]=new a.constructor),n.attributes[i].models=function(){var e,r,n,i;for(n=a.models,i=[],e=0,r=n.length;r>e;e++)s=n[e],i.push(h(s,t));return i}()):n.attributes[i]=u.isModel(a)?h(a,t):a;return--this._orm.clone,n}},!e.prototype._orm_original_fns){e.prototype._orm_original_fns={},p=[];for(n in i)r=i[n],e.prototype._orm_original_fns[n]=e.prototype[n],p.push(e.prototype[n]=r);return p}}},function(e,t,r){var n,i,o,s,u,a,l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};a=r(1),n=r(2),s=r(7),u=r(4),i=r(13),e.exports=o=function(e){function t(e,t,r){var n;this.model_type=e,this.key=t;for(t in r)n=r[t],this[t]=n;this.virtual_id_accessor||(this.virtual_id_accessor=i.conventions.foreignKey(this.key)),this.join_key||(this.join_key=this.foreign_key||i.conventions.foreignKey(this.model_type.model_name)),this.foreign_key||(this.foreign_key=i.conventions.foreignKey("belongsTo"===this.type?this.key:this.as||this.model_type.model_name))
}return c(t,e),t.prototype.initialize=function(){if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.")},t.prototype.initializeModel=function(e){return e.isLoadedExists(this.key)||e.setLoaded(this.key,this.isEmbedded()),this._bindBacklinks(e)},t.prototype.releaseModel=function(e){return this._unbindBacklinks(e),delete e._orm},t.prototype.set=function(e,t,r,i){var o,s,l,c,h;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("One.set: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(a.isArray(r))throw new Error("One.set: cannot set an array for attribute "+this.key+" on "+this.model_type.model_name);return a.isUndefined(r)&&(r=null),r===(h=e.get(this.key))?this:(o=u.isModel(r),l=u.dataId(r),c=u.dataId(h),u.orSet(e,"rel_dirty",{})[this.key]=!0,c===l&&e.isLoaded(this.key)||(o&&r.isLoaded()&&l!==r?e.setLoaded(this.key,!0):e.setLoaded(this.key,a.isNull(r))),r&&!o&&((s=c===l)||(r=u.updateOrNew(r,this.reverse_model_type))),s||n.Model.prototype.set.call(e,this.key,r,i),s?u.updateModel(h,r):null!==r||!this.reverse_relation||"hasOne"!==this.reverse_relation.type&&"belongsTo"!==this.reverse_relation.type||this.embed||this.reverse_relation.embed||e.isLoaded(this.key)&&h&&h.get(this.reverse_relation.key)===e&&h.set(this.reverse_relation.key,null),this)},t.prototype.get=function(e,t,r){var n,i,o;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("One.get: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return o=function(r){return function(){var n;return(n=e.attributes[r.key])?t===r.virtual_id_accessor?n.id:n:null}}(this),!r||this.isVirtual()||this.manual_fetch||(n=e.isLoaded(this.key))||this.cursor(e,t).toJSON(function(n){return function(i,s){var a,l;return i?r(i):(t!==n.virtual_id_accessor&&e.setLoaded(n.key,!0),a=e.get(n.key),a&&a.id===(null!=s?s.id:void 0)?u.updateModel(a,s):(l=s?u.updateOrNew(s,n.reverse_model_type):null,e.set(n.key,l)),r(null,o()))}}(this)),i=o(),r&&(n||this.manual_fetch)&&r(null,i),i},t.prototype.save=function(e,t){var r;return this._hasChanged(e)?(delete u.orSet(e,"rel_dirty",{})[this.key],(r=e.attributes[this.key])?this._saveRelated(e,[r],t):t()):t()},t.prototype.patchAdd=function(e,t,r){var n,i;return e.id?t?a.isArray(t)?r(new Error("One.patchAdd: should be provided with one model only for key: "+this.key)):(i=u.dataId(t))?(this.reverse_model_type.cache&&!u.isModel(t)&&(n=this.reverse_model_type.cache.get(i))&&(u.updateModel(n,t),t=n),e.set(this.key,t),"belongsTo"===this.type?this.model_type.cursor({id:e.id,$one:!0}).toJSON(function(t){return function(n,o){return n?r(n):o?(o[t.foreign_key]=i,e.save(o,r)):r(new Error("Failed to fetch model with id: "+e.id))}}(this)):this.cursor(e,this.key).toJSON(function(n){return function(o,a){var l;return o?r(o):a&&i===a[n.reverse_model_type.prototype.idAttribute]?r():(l=new s(1),a&&l.defer(function(t){return n.patchRemove(e,a,t)}),l.defer(function(r){var o,s;return u.isModel(t)?t.isLoaded()&&(s=t.toJSON()):i!==t&&(s=t),s?(s[n.reverse_relation.foreign_key]=e.id,u.modelJSONSave(s,n.reverse_model_type,r)):(o={$one:!0},o.id=i,n.reverse_model_type.cursor(o).toJSON(function(t,i){return t?r(t):i?(i[n.reverse_relation.foreign_key]=e.id,u.modelJSONSave(i,n.reverse_model_type,r)):r()}))}),l.await(r))}}(this))):r(new Error("One.patchAdd: cannot add a new model. Please save first.")):r(new Error("One.patchAdd: missing model for: "+this.key)):r(new Error("One.patchAdd: model has null id for: "+this.key))},t.prototype.patchRemove=function(e,t,r){var n,i,o,s,l;if(2===arguments.length&&(r=t,t=void 0),!e.id)return r(new Error("One.patchRemove: model has null id for: "+this.key));if(2===arguments.length)return this.reverse_relation?(u.isModel(e)&&delete u.orSet(e,"rel_dirty",{})[this.key],void this.cursor(e,this.key).toJSON(function(e){return function(t,n){return t?r(t):n?(n[e.reverse_relation.foreign_key]=null,u.modelJSONSave(n,e.reverse_model_type,r)):r()}}(this))):r();if(this.isEmbedded())return r(new Error("One.patchRemove: embedded relationships are not supported"));if(!t)return r(new Error("One.patchRemove: missing model for remove"));if(a.isArray(t)||(t=[t]),n=e.get(this.key))for(s=0,l=t.length;l>s;s++)if(i=t[s],u.dataIsSameModel(n,i)){e.set(this.key,null);break}return o=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)i=t[e],n.push(u.dataId(i));return n}(),"belongsTo"===this.type?this.model_type.cursor({id:e.id,$one:!0}).toJSON(function(e){return function(t,n){return t?r(t):n&&a.contains(o,n[e.foreign_key])?(n[e.foreign_key]=null,u.modelJSONSave(n,e.model_type,r)):r()}}(this)):this.cursor(e,this.key).toJSON(function(e){return function(t,n){return t?r(t):n&&a.contains(o,n[e.reverse_model_type.prototype.idAttribute])?(n[e.reverse_relation.foreign_key]=null,u.modelJSONSave(n,e.reverse_model_type,r)):r()}}(this))},t.prototype.appendJSON=function(e,t){var r,n;if(!this.isVirtual())return r=this.embed?this.key:this.foreign_key,(n=t.attributes[this.key])?this.embed?e[r]=n.toJSON():"belongsTo"===this.type?e[r]=n.id:void 0:void((this.embed||"belongsTo"===this.type)&&(e[r]=null))},t.prototype.cursor=function(e,t,r){var n;if(r=a.extend({$one:!0},r||{}),u.isModel(e))if("belongsTo"===this.type)(r.id=null!=(n=e.attributes[this.key])?n.id:void 0)||(r.$zero=!0,delete r.id);else{if(!e.id)throw new Error("Cannot create cursor for non-loaded model");r[this.reverse_relation.foreign_key]=e.id}else if("belongsTo"===this.type)(r.id=e[this.foreign_key])||(r.$zero=!0,delete r.id);else{if(!e.id)throw new Error("Cannot create cursor for non-loaded model");r[this.reverse_relation.foreign_key]=e.id}return t===this.virtual_id_accessor&&(r.$values=["id"]),this.reverse_model_type.cursor(r)},t.prototype._bindBacklinks=function(e){var t,r,n;if(this.reverse_relation)return t=u.set(e,"events",{}),n=function(t){return function(r){return t.reverse_relation.add?t.reverse_relation.add(r,e):r.set(t.reverse_relation.key,e)}}(this),t.change=function(e){return function(t){var r,i,o;return o=t.get(e.key),i=t.previous(e.key),u.dataId(o)!==u.dataId(i)?(i&&e.reverse_relation&&"belongsTo"!==e.reverse_relation.type&&(e.reverse_relation.remove?e.isVirtual()&&o||e.reverse_relation.remove(i,t):(r=i.get(e.reverse_relation.key),u.dataId(r)===t.id&&i.set(e.reverse_relation.key,null))),o?n(o):void 0):void 0}}(this),e.on("change:"+this.key,t.change),(r=e.get(this.key))?n(r):e.attributes[this.key]=null,e},t.prototype._unbindBacklinks=function(e){var t;(t=u.get(e,"events"))&&(u.unset(e,"events"),e.attributes[this.key]=null,e.off("change:"+this.key,t.change),t.change=null)},t.prototype._hasChanged=function(e){return!!u.orSet(e,"rel_dirty",{})[this.key]||e.hasChanged(this.key)},t}(r(28))},function(e,t,r){var n,i,o,s,u,a,l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};n=r(2),a=r(1),s=r(7),u=r(4),i=r(13),e.exports=o=function(e){function t(e,t,r){var o,s,u;this.model_type=e,this.key=t;for(t in r)u=r[t],this[t]=u;this.virtual_id_accessor||(this.virtual_id_accessor=i.conventions.foreignKey(this.key,!0)),this.join_key||(this.join_key=this.foreign_key||i.conventions.foreignKey(this.model_type.model_name)),this.foreign_key||(this.foreign_key=i.conventions.foreignKey(this.as||this.model_type.model_name)),this._adding_ids={},this.collection_type||(s=this.reverse_model_type,o=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return c(t,e),t.prototype.model=s,t}(n.Collection),this.collection_type=o)}return c(t,e),t.prototype.initialize=function(){var e;if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.");if("hasOne"===(null!=(e=this.reverse_relation)?e.type:void 0))throw new Error("The reverse of a hasMany relation should be `belongsTo`, not `hasOne` ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+").");return"hasMany"===this.reverse_relation.type?this.join_table=this.findOrGenerateJoinTable(this):void 0},t.prototype.initializeModel=function(e){return e.isLoadedExists(this.key)||e.setLoaded(this.key,!1),this._bindBacklinks(e)},t.prototype.releaseModel=function(e){return this._unbindBacklinks(e),delete e._orm},t.prototype.set=function(e,t,r){var n,i,o,s,l,c,h,p;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("Many.set: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(n=this._bindBacklinks(e),u.isCollection(r)&&(r=r.models),a.isUndefined(r)&&(r=[]),!a.isArray(r))throw new Error("HasMany.set: Unexpected type to set "+t+". Expecting array: "+JSONUtils.stringify(r));if(u.orSet(e,"rel_dirty",{})[this.key]=!0,e.setLoaded(this.key,a.all(r,function(e){return u.dataId(e)!==e})),s=function(){var e,t,o;for(o=[],e=0,t=r.length;t>e;e++)i=r[e],o.push((c=n.get(u.dataId(i)))?u.updateModel(c,i):u.updateOrNew(i,this.reverse_model_type));return o}.call(this),e.setLoaded(this.key,a.all(s,function(e){return e.isLoaded()})),l=a.clone(n.models),n.reset(s),"belongsTo"===this.reverse_relation.type)for(o=a.pluck(s,"id"),h=0,p=l.length;p>h;h++)c=l[h],a.contains(o,c.id)||c.set(this.foreign_key,null);return this},t.prototype.get=function(e,t,r){var n,i,o,s;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("Many.get: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return n=this._ensureCollection(e),s=function(e){return function(){var r,i,o,s,u;if(t===e.virtual_id_accessor){for(s=n.models,u=[],i=0,o=s.length;o>i;i++)r=s[i],u.push(r.id);return u}return n}}(this),!r||this.isVirtual()||this.manual_fetch||(i=e.isLoaded(this.key))||this.cursor(e,this.key).toJSON(function(t){return function(i,o){var a,l,c,h,p,f,d,y,_;if(i)return r(i);for(e.setLoaded(t.key,!0),p=0,d=o.length;d>p;p++)l=o[p],(c=n.get(l[t.reverse_model_type.prototype.idAttribute]))?c.set(l):n.add(c=u.updateOrNew(l,t.reverse_model_type));if(a=t.reverse_model_type.cache)for(_=n.models,f=0,y=_.length;y>f;f++)c=_[f],a.set(c.id,c);return h=s(),r(null,h.models?h.models:h)}}(this)),o=s(),r&&(i||this.manual_fetch)&&r(null,o.models?o.models:o),o},t.prototype.save=function(e,t){var r;return this._hasChanged(e)?(delete u.orSet(e,"rel_dirty",{})[this.key],r=this._ensureCollection(e),this._saveRelated(e,a.clone(r.models),t)):t()},t.prototype.appendJSON=function(e,t){var r,n;if(!this.isVirtual())return r=this._ensureCollection(t),n=this.embed?this.key:this.virtual_id_accessor,this.embed?e[n]=r.toJSON():void 0},t.prototype.add=function(e,t){var r,n,i,o;return t.id&&(r=this._adding_ids[t.id]=(this._adding_ids[t.id]||0)+1),n=this._ensureCollection(e),i=n.get(t.id),i!==t?(i&&n.remove(i),this.reverse_model_type.cache&&t.id&&this.reverse_model_type.cache.set(t.id,t),o=n.add(t,{silent:r>1}),t.id&&this._adding_ids[t.id]--,o):void 0},t.prototype.remove=function(e,t){var r,n;return r=this._ensureCollection(e),(n=r.get(t.id))?r.remove(n):void 0},t.prototype.patchAdd=function(e,t,r){var n,i,o,l,c,h,p,f,d,y,_,m,g;if(!e.id)return r(new Error("Many.patchAdd: model has null id for: "+this.key));if(!t)return r(new Error("Many.patchAdd: missing model for: "+this.key));if(a.isArray(t)||(t=[t]),n=this._ensureCollection(e),t=function(){var e,r,o;for(o=[],e=0,r=t.length;r>e;e++)i=t[e],o.push((f=n.get(u.dataId(i)))?u.updateModel(f,i):u.updateOrNew(i,this.reverse_model_type));return o}.call(this),p=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)c=t[e],n.push(u.dataId(c));return n}(),n.add(t),e.isLoaded(this.key))for(y=0,m=t.length;m>y;y++)if(c=t[y],!c.isLoaded()){e.setLoaded(this.key,!1);break}if(this.join_table){for(l=new s(1),d=function(t){return function(r){return l.defer(function(n){var i,o;return r?(i=function(n){var i;return(i={})[t.foreign_key]=e.id,i[t.reverse_relation.foreign_key]=r,t.join_table.exists(i,function(e,r){return e?n(e):r?n(new Error("Join already exists: "+JSON.stringify(i))):new t.join_table(i).save(n)})},"hasMany"===t.reverse_relation.type?i(n):((o={$one:!0})[t.reverse_relation.foreign_key]=r,t.join_table.cursor(o).toJSON(function(r,o){return r?n(r):o?o[t.foreign_key]===e.id?n():(o[t.foreign_key]=e.id,u.modelJSONSave(o,t.join_table,n)):i(n)}))):n(new Error("Many.patchAdd: cannot add an new model. Please save first."))})}}(this),_=0,g=p.length;g>_;_++)h=p[_],d(h);return l.await(r)}return o={id:{$in:p}},this.reverse_model_type.cursor(o).toJSON(function(t){return function(n,i){var o,a,c,h;for(l=new s(1),a=function(r){return l.defer(function(n){return r[t.reverse_relation.foreign_key]=e.id,u.modelJSONSave(r,t.reverse_model_type,n)})},c=0,h=i.length;h>c;c++)o=i[c],a(o);return l.await(r)}}(this))},t.prototype.patchRemove=function(e,t,r){var n,i,o,l,c,h,p,f,d,y,_,m,g,v,w,b;if(!e.id)return r(new Error("Many.patchRemove: model has null id for: "+this.key));if(2===arguments.length){if(r=t,!this.reverse_relation)return r();for(u.isModel(e)?(delete u.orSet(e,"rel_dirty",{})[this.key],i=this._ensureCollection(e),d=a.clone(i.models)):d=function(){var t,r,n,i;for(n=e[this.key]||[],i=[],t=0,r=n.length;r>t;t++)l=n[t],i.push(new this.reverse_model_type(l));return i}.call(this),y=0,g=d.length;g>y;y++)f=d[y],f.set(this.foreign_key,null),(n=f.cache())&&n.set(f.id,f);return this.join_table?((c={})[this.join_key]=e.id,this.join_table.destroy(c,r)):((c={})[this.reverse_relation.foreign_key]=e.id,void this.reverse_model_type.cursor(c).toJSON(function(e){return function(t,n){var i,o,a,l,c;if(t)return r(t);for(i=new s(1),a=function(t){return i.defer(function(r){return t[e.reverse_relation.foreign_key]=null,u.modelJSONSave(t,e.reverse_model_type,r)})},l=0,c=n.length;c>l;l++)o=n[l],a(o);return i.await(r)}}(this)))}if(this.isEmbedded())return r(new Error("Many.patchRemove: embedded relationships are not supported"));if(!t)return r(new Error("One.patchRemove: missing model for remove"));for(a.isArray(t)||(t=[t]),i=this._ensureCollection(e),_=0,v=t.length;v>_;_++)for(h=t[_],b=i.models,m=0,w=b.length;w>m;m++)if(o=b[m],u.dataIsSameModel(o,h)){i.remove(o);break}return p=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)h=t[e],n.push(u.dataId(h));return n}(),this.join_table?(c={},c[this.join_key]=e.id,c[this.reverse_relation.join_key]={$in:p},this.join_table.destroy(c,r)):(c={},c[this.reverse_relation.foreign_key]=e.id,c.id={$in:p},this.reverse_model_type.cursor(c).toJSON(function(e){return function(t,n){var i,o,a,l,c;if(t)return r(t);for(i=new s(1),a=function(t){return i.defer(function(r){return t[e.reverse_relation.foreign_key]=null,u.modelJSONSave(t,e.reverse_model_type,r)})},l=0,c=n.length;c>l;l++)o=n[l],a(o);return i.await(r)}}(this)))},t.prototype.cursor=function(e,t,r){var n;return n=u.isModel(e)?e.attributes:e,(r=a.clone(r||{}))[this.join_table?this.join_key:this.reverse_relation.foreign_key]=n[this.model_type.prototype.idAttribute],t===this.virtual_id_accessor&&(r.$values||(r.$values=[])).push("id"),this.reverse_model_type.cursor(r)},t.prototype._bindBacklinks=function(e){var t,r,n,i,o,s;if((t=e.attributes[this.key])instanceof this.collection_type)return t;if(t=e.attributes[this.key]=new this.collection_type,!this.reverse_relation)return t;for(r=u.set(t,"events",{}),r.add=function(t){return function(r){var n,i;return t.reverse_relation.add?t.reverse_relation.add(r,e):(n=r.get(t.reverse_relation.key),i=e.id&&u.dataId(n)===e.id,!i||i&&!n.isLoaded()?r.set(t.reverse_relation.key,e):void 0)}}(this),r.remove=function(t){return function(r){var n;return t.reverse_relation.remove?t.reverse_relation.remove(r,e):(n=r.get(t.reverse_relation.key),u.dataId(n)===e.id?r.set(t.reverse_relation.key,null):void 0)}}(this),r.reset=function(){return function(e,t){var n,i,o,s,u,l,c,h,p,f,d;if(o=e.models,s=t.previousModels||[],i=a.groupBy(s,function(e){return a.find(o,function(t){return t.id===e.id})?"kept":"removed"}),n=i.kept?a.select(o,function(e){return!a.find(i.kept,function(t){return t.id===e.id})}):o,i.removed)for(f=i.removed,l=0,h=f.length;h>l;l++)u=f[l],r.remove(u);for(d=[],c=0,p=n.length;p>c;c++)u=n[c],d.push(r.add(u));return d}}(this),s=["add","remove","reset"],i=0,o=s.length;o>i;i++)n=s[i],t.on(n,r[n]);return t},t.prototype._unbindBacklinks=function(e){var t,r,n,i,o,s;if(r=u.get(e,"events"))for(u.unset(e,"events"),t=e.attributes[this.key],t.models.splice(),r=a.clone(),s=["add","remove","reset"],i=0,o=s.length;o>i;i++)n=s[i],t.off(n,r[n]),r[n]=null},t.prototype._ensureCollection=function(e){return this._bindBacklinks(e)},t.prototype._hasChanged=function(e){return!!u.orSet(e,"rel_dirty",{})[this.key]||e.hasChanged(this.key)},t}(r(28))},function(e,t,r){var n;n=r(21),e.exports={modelName:function(e,t){return n[t?"pluralize":"singularize"](n.classify(e))},tableName:function(e){return n.pluralize(n.underscore(e))},attribute:function(e,t){return n[t?"pluralize":"singularize"](n.underscore(e))},foreignKey:function(e,t){return t?n.underscore(n.singularize(e))+"_ids":n.underscore(e)+"_id"}}},function(e,t){t.forEach=function(e,t,r){if(e.forEach)return e.forEach(t,r);for(var n=0;n<e.length;n++)t.call(r,e[n],n,e)},t.substr="b"!=="ab".substr(-1)?function(e,t,r){return 0>t&&(t=e.length+t),e.substr(t,r)}:function(e,t,r){return e.substr(t,r)},t.trim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}},function(e,t,r){var n,i,o,s,u,a;n=r(2),a=r(1),u=r(7),o=r(15),i=["max","max_age","destroy"],e.exports=s=function(){function e(){this.enabled=!1,this.caches={},this.options={modelTypes:{}},this.verbose=!1}return e.prototype.configure=function(e,t){return null==e&&(e={}),this.enabled=e.enabled,this.reset(function(r){return function(n){var i,o,s,u,l,c;if(n)return t(n);for(i in e)if(o=e[i],a.isObject(o)){(c=r.options)[i]||(c[i]={}),l=r.options[i];for(s in o)u=o[s],l[s]=u}else r.options[i]=o;return t()}}(this)),this},e.prototype.configureSync=function(e,t){var n;return e.prototype._orm_never_cache||!(n=this.getOrCreateCache(e.model_name))?t:(e.cache=n,r(33)(e,t))},e.prototype.reset=function(e){var t,r,n,i,o;r=new u,o=this.caches,i=function(e){return function(n){return delete e.caches[t],r.defer(function(e){return n.reset(e)})}}(this);for(t in o)n=o[t],i(n);return r.await(e)},e.prototype.getOrCreateCache=function(e){var t,r,n;if(!this.enabled)return null;if(!e)throw new Error("Missing model name for cache");return(t=this.caches[e])?t:(r=this.options.modelTypes[e])?this.caches[e]=("function"==typeof r.store?r.store():void 0)||new o(a.pick(r,i)):this.options.store||this.options.max||this.options.max_age?this.caches[e]=("function"==typeof(n=this.options).store?n.store():void 0)||new o(a.pick(this.options,i)):null},e}()},function(e,t,r){var n,i,o,s,u,a;a=r(1),n=r(2),o=r(7),u=r(4),i=r(13),e.exports=s=function(){function e(){}return e.prototype.isEmbedded=function(){return!!(this.embed||this.reverse_relation&&this.reverse_relation.embed)},e.prototype.isVirtual=function(){return!!(this.virtual||this.reverse_relation&&this.reverse_relation.virtual)},e.prototype.findOrGenerateJoinTable=function(){var e;return(e=this.join_table||this.reverse_relation.join_table)?e:this.model_type.schema().generateJoinTable(this)},e.prototype._findOrGenerateReverseRelation=function(){var e,t,r;return e=this.model_type,t=this.reverse_model_type,a.isFunction(t.schema)||(t.sync=e.createSync(t)),r=t.relation(this.as),r||(r=t.relation(i.conventions.attribute(e.model_name,!1))),r||(r=t.relation(i.conventions.attribute(e.model_name,!0))),r||"belongsTo"===this.type||(r=t.schema().generateBelongsTo(e)),r&&!r.reverse_relation&&(r.reverse_relation=this),r},e.prototype._saveRelated=function(e,t,r){return this.embed||!this.reverse_relation||"belongsTo"===this.type?r():this.isVirtual()?r():this.cursor(e,this.key).toJSON(function(n){return function(i,s){var l,c,h,p,f,d,y,_,m,g,v,w,b,$,k,x,O,E,R;if(i)return r(i);if(a.isArray(s)||(s=s?[s]:[]),p=new o(1),d=a.pluck(t,"id"),h=a.groupBy(s,function(e){return a.contains(d,e.id)?"kept":"removed"}),c=h.kept?a.difference(d,function(){var e,t,r,n;for(r=h.kept,n=[],e=0,t=r.length;t>e;e++)m=r[e],n.push(m.id);return n}()):d,h.removed)if(n.join_table)p.defer(function(e){var t,r;return t={},t[n.reverse_relation.join_key]={$in:function(){var e,t,n,i;for(n=h.removed,i=[],e=0,t=n.length;t>e;e++)r=n[e],i.push(r[this.reverse_model_type.prototype.idAttribute]);return i}.call(n)},n.join_table.destroy(t,e)});else for(R=h.removed,g=function(e){return p.defer(function(t){return e[n.reverse_relation.foreign_key]=null,u.modelJSONSave(e,n.reverse_model_type,t)})},b=0,x=R.length;x>b;b++)y=R[b],g(y);if(c.length)if(n.join_table)for(v=function(t){return p.defer(function(r){var i,o;return i={},i[n.foreign_key]=e.id,i[n.reverse_relation.foreign_key]=t,o=new n.join_table(i),o.save(r)})},$=0,O=c.length;O>$;$++)f=c[$],v(f);else for(w=function(e){return p.defer(function(t){return e.save(function(e,r){var i;return!e&&(i=n.reverse_model_type.cache)&&i.set(r.id,r),t(e)})})},k=0,E=c.length;E>k;k++)l=c[k],_=a.find(t,function(e){return e.id===l}),n.reverse_relation._hasChanged(_)&&w(_);return p.await(r)}}(this))},e}()},function(e,t,r){var n,i,o={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)o.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};try{i=r(3)}catch(u){}(null!=i?i.Readable:void 0)&&(e.exports=n=function(e){function t(e,r){this.model_type=e,this.query=null!=r?r:{},t.__super__.constructor.call(this,{objectMode:!0})}return s(t,e),t.prototype._read=function(){var e;if(!this.ended&&!this.started)return this.started=!0,e=function(e){return function(t){return e.ended=!0,t&&e.emit("error",t),e.push(null)}}(this),this.model_type.each(this.query,function(e){return function(t,r){return e.push(t),r()}}(this),e)},t}(i.Readable))},function(e,t,r){var n,i,o;o=r(1),i=r(7),n=null,e.exports=function(e,t,s,u){var a,l,c,h,p,f;return n||(n=r(10)),c=t.$each||{},a=c.json?"toJSON":"toModels",p=0,h=n.parseQuery(o.omit(t,"$each")),o.defaults(h.cursor,{$offset:0,$sort:"id"}),l=h.cursor.$limit||1/0,c.fetch&&(h.cursor.$limit=c.fetch),(f=function(){var t;return t=e.cursor(h),t[a].call(t,function(e,t){var r,n,o,a,d;if(e||!t)return u(new Error("Failed to get models. Error: "+e));if(!t.length)return u(null,p);for(n=new i(c.threads),o=function(e){return n.defer(function(t){return s(e,t)})},a=0,d=t.length;d>a&&(r=t[a],!(p++>=l));a++)o(r);return n.await(function(e){return e?u(e):p>=l||t.length<h.cursor.$limit||!h.cursor.$limit?u(null,p):(h.cursor.$offset+=h.cursor.$limit,f())})})})()}},function(e,t,r){var n,i,o,s,u;u=r(1),o=r(7),s=r(4),n=r(6),i=["milliseconds","seconds","minutes","hours","days","weeks","months","years"],e.exports=function(e,t,r,s){var a,l,c,h,p,f;if(h=t.$interval||{},!(l=h.key))throw new Error("missing option: key");if(!h.type)throw new Error("missing option: type");if(!u.contains(i,h.type))throw new Error("type is not recognized: "+h.type+", "+u.contains(i,h.type));return a=u.clone(h),a.range||(a.range={}),f=a.range,c=!1,p=new o(1),p.defer(function(r){var n;return(n=f.$gte||f.$gt)?(f.start=n,e.findOneNearestDate(n,{key:l,reverse:!0},t,function(e,t){return e?r(e):t?(a.first=t.get(l),r()):(c=!0,r())})):e.cursor(t).limit(1).sort(l).toModels(function(e,t){return e?r(e):t.length?(f.start=a.first=t[0].get(l),r()):(c=!0,r())})}),p.defer(function(r){var n;return c?r():(n=f.$lte||f.$lt)?(f.end=n,e.findOneNearestDate(n,{key:l},t,function(e,t){return e?r(e):t?(a.last=t.get(l),r()):(c=!0,r())})):e.cursor(t).limit(1).sort("-"+l).toModels(function(e,t){return e?r(e):t.length?(f.end=a.last=t[0].get(l),r()):(c=!0,r())})}),p.await(function(i){var o,p,d,y;if(i)return s(i);if(c)return s();if(y=f.start.getTime(),o=n.durationAsMilliseconds(u.isUndefined(h.length)?1:h.length,h.type),!o)throw Error("length_ms is invalid: "+o+" for range: "+JSONUtils.stringify(f));return t=u.omit(t,"$interval"),t.$sort=[l],p=0,a.index=0,(d=function(i){return n.isAfter(i,f.end)?s():(t[l]={$gte:i,$lte:a.last},e.findOne(t,function(e,n){var u;return e?s(e):n?(u=n.get(l),a.index=Math.floor((u.getTime()-y)/o),i=new Date(f.start.getTime()+a.index*o),a.start=i,u=new Date(i.getTime()+o),a.end=u,t[l]={$gte:i,$lt:u},r(t,a,function(e){return e?s(e):d(u)})):s()}))})(f.start)})}},function(e,t,r){var n,i,o,s,u,a,l;if(l=r(1),n=r(2),i=r(4),o=n.Collection,a={fetch:function(e){var t;if(l.isFunction(t=arguments[arguments.length-1]))switch(arguments.length){case 1:e=i.wrapOptions({},t);break;case 2:e=i.wrapOptions(e,t)}return o.prototype._orm_original_fns.fetch.call(this,i.wrapOptions(e,function(e){return function(t,r,n,i){return t?"function"==typeof i.error?i.error(e,n,i):void 0:"function"==typeof i.success?i.success(r,n,i):void 0}}(this)))},_prepareModel:function(e,t){var r,n,s;return!i.isModel(e)&&(r=i.dataId(e))?(this.model.cache&&(n=!!this.model.cache.get(r)),s=i.updateOrNew(e,this.model),n&&!s._validate(e,t)?(this.trigger("invalid",this,e,t),!1):s):o.prototype._orm_original_fns._prepareModel.call(this,e,t)}},!o.prototype._orm_original_fns){o.prototype._orm_original_fns={};for(u in a)s=a[u],o.prototype._orm_original_fns[u]=o.prototype[u],o.prototype[u]=s}},function(e,t,r){var n,i,o,s,u,a,l,c;c=r(1),n=r(34),u=r(11),a=r(4),l=a.bbCallback,o=1e3,s=100,i=function(){function e(e,t){this.model_type=e,this.wrapped_sync_fn=t}return e.prototype.initialize=function(){if(!this.is_initialized&&(this.is_initialized=!0,this.wrapped_sync_fn("initialize"),!this.model_type.model_name))throw new Error("Missing model_name for model")},e.prototype.read=function(e,t){var r;return!t.force&&(r=this.model_type.cache.get(e.id))?t.success(r.toJSON()):this.wrapped_sync_fn("read",e,t)},e.prototype.create=function(e,t){return this.wrapped_sync_fn("create",e,l(function(r){return function(n,i){var o,s;return n?t.error(n):((o={})[r.model_type.prototype.idAttribute]=i[r.model_type.prototype.idAttribute],e.set(o),(s=r.model_type.cache.get(e.id))?s!==e&&a.updateModel(s,e):r.model_type.cache.set(e.id,e),t.success(i))}}(this)))},e.prototype.update=function(e,t){return this.wrapped_sync_fn("update",e,l(function(r){return function(n,i){var o;return n?t.error(n):((o=r.model_type.cache.get(e.id))?o!==e&&a.updateModel(o,e):r.model_type.cache.set(e.id,e),t.success(i))}}(this)))},e.prototype["delete"]=function(e,t){return this.model_type.cache.destroy(e.id),this.wrapped_sync_fn("delete",e,l(function(){return function(e,r){return e?t.error(e):t.success(r)}}(this)))},e.prototype.resetSchema=function(e,t){return this.model_type.cache.reset(function(r){return function(n){return n?t(n):r.wrapped_sync_fn("resetSchema",e,t)}}(this))},e.prototype.cursor=function(e){return null==e&&(e={}),new n(e,c.pick(this,["model_type","wrapped_sync_fn"]))},e.prototype.destroy=function(e,t){return this.model_type.each(c.extend({$each:{limit:o,threads:s}},e),function(){return function(e,t){return e.destroy(t)}}(this),t)},e.prototype.connect=function(){return this.model_type.cache.reset(),this.wrapped_sync_fn("connect")},e}(),e.exports=function(e,t){var r,n;return r=new i(e,t),e.prototype.sync=n=function(e,n,i){return null==i&&(i={}),r.initialize(),"createSync"===e?t.apply(null,arguments):"sync"===e?r:r[e]?r[e].apply(r,Array.prototype.slice.call(arguments,1)):t.apply(t,Array.prototype.slice.call(arguments))},n}},function(e,t,r){var n,i,o={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)o.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};i=r(1),e.exports=n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return s(t,e),t.prototype.toJSON=function(e){return this.wrapped_sync_fn("cursor",i.extend({},this._find,this._cursor)).toJSON(e)},t}(r(10))}])});