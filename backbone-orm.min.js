(function(){var e={};(function(){"use strict";var t={},r={},n=function(e,t){return{}.hasOwnProperty.call(e,t)},o=function(e,t){var r,n,o=[];r=/^\.\.?(\/|$)/.test(t)?[e,t].join("/").split("/"):t.split("/");for(var i=0,s=r.length;s>i;i++)n=r[i],".."===n?o.pop():"."!==n&&""!==n&&o.push(n);return o.join("/")},i=function(e){return e.split("/").slice(0,-1).join("/")},s=function(t){var r=function(r){var n=i(t),s=o(n,r);return e.require(s,t)};return r.register=e.require.register,r.shim=e.require.shim,r},a=function(e,t){var n={id:e,exports:{}};return r[e]=n,t(n.exports,s(e),n),n.exports},u=function(e,i){var s=o(e,".");if(null==i&&(i="/"),n(r,s))return r[s].exports;if(n(t,s))return a(s,t[s]);var u=o(s,"./index");if(n(r,u))return r[u].exports;if(n(t,u))return a(u,t[u]);throw new Error('Cannot find module "'+e+'" from "'+i+'"')},l=function(e,r){if("object"==typeof e)for(var o in e)n(e,o)&&(t[o]=e[o]);else t[e]=r},c=Object.prototype.toString,h=function(e){return"[object Array]"===c.call(e)},f=function(t){if("undefined"!=typeof window){h(t)||(t=[t]);for(var r=function(t){var r;try{if(e.require(t.path))return}catch(n){}try{r="function"==typeof window.require?window.require(t.path):void 0}catch(n){}if(!r&&t.symbol){var o=t.symbol.split(".");r=window;for(var i=0,s=o.length;s>i&&(r=r[o[i]]);i++);}if(!r){if(t.optional)return;throw new Error("Missing dependency: "+t.path)}e.require.register(t.path,function(e,t,n){return n.exports=r}),t.alias&&e.require.register(t.alias,function(e,t,n){return n.exports=r})},n=0,o=t.length;o>n;n++)r(t[n])}};e.require=u,e.require.register=l,e.require.shim=f}).call(this);var t=e.require;t.register("connection_pool",function(e,t,r){var n;n=t("./cache/memory_store"),r.exports=new n({destroy:function(e,t){return t.destroy()}})}),t.register("cursor",function(e,t,r){var n,o,i,s,a,u=function(e,t){return function(){return e.apply(t,arguments)}};a=t("underscore"),i=t("./cache/singletons").QueryCache,s=t("./utils"),n=["$count","$exists","$zero","$one","$offset","$limit","$page","$sort","$white_list","$select","$include","$values","$ids"],r.exports=o=function(){function e(t,r){this.relatedModelTypesInQuery=u(this.relatedModelTypesInQuery,this);var n,o,i,s,l,c;for(n in r)i=r[n],this[n]=i;for(o=e.parseQuery(t,this.model_type),this._find=o.find,this._cursor=o.cursor,c=["$white_list","$select","$values"],s=0,l=c.length;l>s;s++)n=c[s],this._cursor[n]&&!a.isArray(this._cursor[n])&&(this._cursor[n]=[this._cursor[n]])}return e.validateQuery=function(t,r,n){var o,i,s,u;u=[];for(i in t)if(s=t[i],a.isUndefined(s)||a.isObject(s)){if(o=r?""+r+"."+i:i,a.isUndefined(s))throw new Error("Unexpected undefined for query key '"+o+"' on "+(null!=n?n.model_name:void 0));a.isObject(s)?u.push(e.validateQuery(s,o,n)):u.push(void 0)}return u},e.parseQuery=function(t,r){var n,o,i,s;if(t){if(a.isObject(t)){if(t.find||t.cursor)return{find:t.find||{},cursor:t.cursor||{}};try{e.validateQuery(t,null,r)}catch(u){throw n=u,new Error("Error: "+n+". Query: ",t)}i={find:{},cursor:{}};for(o in t)s=t[o],"$"!==o[0]?i.find[o]=s:i.cursor[o]=s;return i}return{find:{id:t},cursor:{$one:!0}}}return{find:{},cursor:{}}},e.prototype.offset=function(e){return this._cursor.$offset=e,this},e.prototype.limit=function(e){return this._cursor.$limit=e,this},e.prototype.sort=function(e){return this._cursor.$sort=e,this},e.prototype.whiteList=function(){var e;return e=a.flatten(arguments),this._cursor.$white_list=this._cursor.$white_list?a.intersection(this._cursor.$white_list,e):e,this},e.prototype.select=function(){var e;return e=a.flatten(arguments),this._cursor.$select=this._cursor.$select?a.intersection(this._cursor.$select,e):e,this},e.prototype.include=function(){var e;return e=a.flatten(arguments),this._cursor.$include=this._cursor.$include?a.intersection(this._cursor.$include,e):e,this},e.prototype.values=function(){var e;return e=a.flatten(arguments),this._cursor.$values=this._cursor.$values?a.intersection(this._cursor.$values,e):e,this},e.prototype.ids=function(){return this._cursor.$values=["id"],this},e.prototype.count=function(e){return this.execWithCursorQuery("$count","toJSON",e)},e.prototype.exists=function(e){return this.execWithCursorQuery("$exists","toJSON",e)},e.prototype.toModel=function(e){return this.execWithCursorQuery("$one","toModels",e)},e.prototype.toModels=function(e){var t=this;return this._cursor.$values?e(new Error("Cannot call toModels on cursor with values for model "+this.model_type.model_name+". Values: "+s.inspect(this._cursor.$values))):this.toJSON(function(r,n){return r?e(r):t._cursor.$one&&!n?e(null,null):(a.isArray(n)||(n=[n]),t.prepareIncludes(n,function(r,n){var o,i,a,u;return u=(o=!(t._cursor.$select||t._cursor.$whitelist))?function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(s.updateOrNew(i,this.model_type));return r}.call(t):function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push((a=new this.model_type(this.model_type.prototype.parse(i)),a.setPartial(!0),a));return r}.call(t),e(null,t._cursor.$one?u[0]:u)}))})},e.prototype.toJSON=function(e){var t,r=this;return t=a.extend({},a.pick(this._cursor,n),this._find),i.get(this.model_type,t,function(n,o){var s;return n?e(n):a.isUndefined(o)?(s=r.relatedModelTypesInQuery(),r.queryToJSON(function(n,o){return n?e(n):a.isNull(o)?e(null,o):i.set(r.model_type,t,s,o,function(t){return t&&console.log("Error setting query cache: "+t),e(null,o)})})):e(null,o)})},e.prototype.queryToJSON=function(){throw new Error("toJSON must be implemented by a concrete cursor for a Backbone Sync type")},e.prototype.hasCursorQuery=function(e){return this._cursor[e]||""===this._cursor[e]},e.prototype.execWithCursorQuery=function(e,t,r){var n,o=this;return n=this._cursor[e],this._cursor[e]=!0,this[t](function(t,i){return a.isUndefined(n)?delete o._cursor[e]:o._cursor[e]=n,r(t,i)})},e.prototype.relatedModelTypesInQuery=function(){var e,t,r,n,o,i,s,a,u,l,c,h;t=[],r=[],l=this._find;for(e in l)s=l[e],e.indexOf(".")>0?(c=e.split("."),o=c[0],e=c[1],t.push(o)):(i=this.model_type.reverseRelation(e))&&i.join_table&&(r.push(i.model_type),r.push(i.join_table));for((null!=(h=this._cursor)?h.$include:void 0)&&(t=t.concat(this._cursor.$include)),a=0,u=t.length;u>a;a++)o=t[a],(n=this.model_type.relation(o))&&(r.push(n.reverse_model_type),n.join_table&&r.push(n.join_table));return r},e.prototype.selectResults=function(e){var t,r,n,o;return this._cursor.$values?(r=this._cursor.$white_list?a.intersection(this._cursor.$values,this._cursor.$white_list):this._cursor.$values,1===this._cursor.$values.length?(o=this._cursor.$values[0],e=r.length?function(){var t,r,i;for(i=[],t=0,r=e.length;r>t;t++)n=e[t],i.push(n.hasOwnProperty(o)?n[o]:null);return i}():a.map(e,function(){return null})):e=function(){var t,i,s;for(s=[],t=0,i=e.length;i>t;t++)n=e[t],s.push(function(){var e,t,i;for(i=[],e=0,t=r.length;t>e;e++)o=r[e],n.hasOwnProperty(o)&&i.push(n[o]);return i}());return s}()):this._cursor.$select?(t=this._cursor.$white_list?a.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,e=function(){var r,o,i;for(i=[],r=0,o=e.length;o>r;r++)n=e[r],i.push(a.pick(n,t));return i}()):this._cursor.$white_list&&(e=function(){var t,r,o;for(o=[],t=0,r=e.length;r>t;t++)n=e[t],o.push(a.pick(n,this._cursor.$white_list));return o}.call(this)),this._cursor.$one?e[0]||null:e},e.prototype.selectFromModels=function(e){var t,r,n;return this._cursor.$select?(t=this._cursor.$white_list?a.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,e=function(){var o,i,s;for(n=new this.model_type(a.pick(n.attributes,t)),n.setPartial(!0),s=[],o=0,i=e.length;i>o;o++)r=e[o],s.push(n);return s}.call(this)):this._cursor.$white_list&&(e=function(){var t,o,i;for(n=new this.model_type(a.pick(n.attributes,this._cursor.$white_list)),n.setPartial(!0),i=[],t=0,o=e.length;o>t;t++)r=e[t],i.push(n);return i}.call(this)),e},e.prototype.prepareIncludes=function(e,t){var r,n,o,i,s,u,l,c,h,f,p,d,y;if(!a.isArray(this._cursor.$include)||a.isEmpty(this._cursor.$include))return t(null,e);for(l=this.model_type.schema(),c={},r=function(e,t){var r;return r=e[t.prototype.idAttribute],c[r]||(t.cache?(c[r]=t.cache.get(r))||t.cache.set(r,c[r]=new t(e)):c[r]=new t(e)),c[r]},y=this._cursor.$include,h=0,p=y.length;p>h;h++)for(n=y[h],u=l.relation(n),c={},f=0,d=e.length;d>f;f++)i=e[f],a.isArray(s=i[n])?i[n]=function(){var e,t,n;for(n=[],e=0,t=s.length;t>e;e++)o=s[e],n.push(r(o,u.reverse_model_type));return n}():s&&(i[n]=r(s,u.reverse_model_type));return t(null,e)},e}.call(this)}),t.register("database_url",function(e,t,r){var n,o,i,s,a;a=t("underscore"),s=t("inflection"),i=t("url"),o=["protocol","slashes","auth","host","hostname","port","search","query","hash","href"],r.exports=n=function(){function e(e,t,r){var n,s,u,l,c,h,f,p,d,y,_,m,v,g,b,w,k,O;if(_=i.parse(e,t,r),f=_.pathname.split(","),f.length>1){for(d=a.pick(_,"protocol","auth","slashes"),d.host="{1}",d.pathname="{2}",y=i.format(d),y=y.replace("{1}/{2}",""),p=_.pathname.split("/"),_.pathname="/"+p[p.length-2]+"/"+p[p.length-1],l=e.replace(y,""),l=l.substring(0,l.indexOf(_.pathname)),u=l.split(","),O=["host","hostname","port"],m=0,b=O.length;b>m;m++)h=O[m],delete _[h];for(this.hosts=[],v=0,w=u.length;w>v;v++)n=u[v],c=n.split(":"),this.hosts.push(1===c.length?{host:c[0],hostname:c[0]}:{host:c[0],hostname:""+c[0]+":"+c[1],port:c[1]})}for(s=_.pathname.split("/"),this.table=s.pop(),this.database=s[s.length-1],g=0,k=o.length;k>g;g++)h=o[g],_.hasOwnProperty(h)&&(this[h]=_[h])}return e.prototype.format=function(e){var t,r,n;return null==e&&(e={}),n=a.pick(this,o),n.pathname="",this.hosts&&(t=a.map(this.hosts,function(e){return""+e.host+(e.port?":"+e.port:"")}),n.pathname+=t.join(","),n.host="{1}"),this.database&&(n.pathname+="/"+this.database),this.table&&!e.exclude_table&&(n.pathname+="/"+this.table),(e.exclude_search||e.exclude_query)&&(delete n.search,delete n.query),r=i.format(n),this.hosts&&(r=r.replace("{1}/"+n.pathname,n.pathname)),r},e.prototype.parseAuth=function(){var e,t;return this.auth?(e=this.auth.split(":"),t={user:e[0]},t.password=e.length>1?e[1]:null,t):null},e.prototype.modelName=function(){return this.table?s.classify(s.singularize(this.table)):null},e}()}),t.register("index",function(e,t,r){var n;"undefined"!=typeof window&&null!==window&&t.shim&&t.shim([{symbol:"_",path:"lodash",alias:"underscore",optional:!0},{symbol:"_",path:"underscore"},{symbol:"Backbone",path:"backbone"},{symbol:"moment",path:"moment"},{symbol:"inflection",path:"inflection"},{symbol:"stream",path:"stream",optional:!0}]),r.exports={sync:t("./memory/sync"),Utils:t("./utils"),JSONUtils:t("./json_utils"),Queue:t("./queue"),DatabaseURL:t("./database_url"),modules:{url:t("url"),querystring:t("querystring"),"lru-cache":t("lru-cache"),underscore:t("underscore"),backbone:t("backbone"),moment:t("moment"),inflection:t("inflection")},Cursor:t("./cursor"),Schema:t("./schema"),ConnectionPool:t("./connection_pool"),CacheSingletons:t("./cache/singletons")};try{r.exports.modules.stream=t("stream")}catch(o){n=o}}),t.register("json_utils",function(e,t,r){var n,o,i,s;s=t("underscore"),i=t("moment"),o=t("./queue"),r.exports=n=function(){function e(){}return e.parseParams=function(e){var t,r,n;r={};for(t in e)n=e[t],r[t]=JSON.parse(n);return r},e.parse=function(t){var r,n,o,a,u,l;if(s.isNull(t)||"null"===t)return null;if(s.isDate(t))return t;if(s.isArray(t))return s.map(t,e.parse);if(s.isObject(t)){u={};for(o in t)l=t[o],u[o]=e.parse(l);return u}if(s.isString(t)){if(t.length>=20&&"Z"===t[t.length-1])return r=i.utc(t),r&&r.isValid()?r.toDate():t;if("true"===t)return!0;if("false"===t)return!1;if(a=/^\"(.*)\"$/.exec(t))return a[0];try{if(t=JSON.parse(t))return e.parse(t)}catch(c){n=c}}return t},e.toQuery=function(t,r){var n,o,i;if(null==r&&(r=0),s.isNull(t))return"null";if(s.isArray(t))return JSON.stringify(t);if(s.isDate(t)||t.toJSON)return t.toJSON();if(s.isObject(t)){if(r>0)return JSON.stringify(t);o={};for(n in t)i=t[n],o[n]=e.toQuery(i,1);return o}return t},e.renderTemplate=function(t,r,n,i){var a,u,l,c,h,f;if(3===arguments.length&&(i=n,n={}),s.isArray(t)){for(l=[],u=new o(1),c=function(t){return u.defer(function(o){return e.renderTemplate(t,r,n,function(e,t){return e?o(e):(l.push(t),o())})})},h=0,f=t.length;f>h;h++)a=t[h],c(a);return u.await(function(e){return i(e,e?void 0:l)})}return t?s.isString(r)?e.renderKey(t,r,n,i):s.isArray(r)?e.renderKeys(t,r,n,i):s.isFunction(r)?r(t,n,i):e.renderDSL(t,r,n,i):i(null,null)},e.renderDSL=function(t,r,n,i){var a,u,l,c,h;3===arguments.length&&(i=n,n={}),l=new o,c={},h=function(r,o){return l.defer(function(i){var a,u,l,h,f;return a=o.key||r,(h=t.relation(a))?(o.query?(l=o.query,f=o.template):o.$count?(l=s.clone(o),delete l.key):s.isFunction(o)?f=o:o.template?s.isObject(o.template)&&!s.isFunction(o.template)?l=o.template:(f=o.template,l=s.clone(o),delete l.key,delete l.template,0===s.size(l)&&(l=null)):(f=s.clone(o),delete f.key),f?l?h.cursor(t,a,l).toModels(function(t,o){return t?i(t):e.renderTemplate(o,f,n,function(e,t){return c[r]=t,i(e)})}):t.get(a,function(t,o){return t?i(t):e.renderTemplate(o,f,n,function(e,t){return c[r]=t,i(e)})}):h.cursor(t,a,l).toJSON(function(e,t){return c[r]=t,i(e)})):(r.length>1&&"_"===r[r.length-1]&&(r=r.slice(0,+(r.length-2)+1||9e9)),"$select"===r?s.isString(o)?e.renderKey(t,o,n,function(e,t){return c[o]=t,i(e)}):e.renderKeys(t,o,n,function(e,t){return s.extend(c,t),i(e)}):s.isString(o)?e.renderKey(t,o,n,function(e,t){return c[r]=t,i(e)}):s.isFunction(o)?o(t,n,function(e,t){return c[r]=t,i(e)}):s.isString(o.method)?(u=s.isArray(o.args)?o.args.slice():o.args?[o.args]:[],u.push(function(e,t){return c[r]=t,i()}),t[o.method].apply(t,u)):(console.trace("Unknown DSL action: "+r+": ",o),i(new Error("Unknown DSL action: "+r+": ",o))))})};for(u in r)a=r[u],h(u,a);return l.await(function(e){return i(e,e?void 0:c)})},e.renderKeys=function(t,r,n,i){var s,a,u,l,c,h;for(3===arguments.length&&(i=n,n={}),u={},a=new o,l=function(r){return a.defer(function(o){return e.renderKey(t,r,n,function(e,t){return e?o(e):(u[r]=t,o())})})},c=0,h=r.length;h>c;c++)s=r[c],l(s);return a.await(function(e){return i(e,e?void 0:u)})},e.renderKey=function(e,t,r,n){return 3===arguments.length&&(n=r,r={}),e.get(t,function(r,o){var i;if(r)return n(r);if(e.relation(t)){if(s.isArray(o))return n(null,function(){var e,t,r;for(r=[],e=0,t=o.length;t>e;e++)i=o[e],r.push(i.toJSON());return r}());if(o&&o.toJSON)return n(null,o=o.toJSON())}return n(null,o)})},e.renderRelated=function(t,r,n,i,a){var u,l,c,h,f,p;if(4===arguments.length&&(a=i,i={}),s.isArray(t)){for(c=[],l=new o,h=function(t){return l.defer(function(o){return t.get(r,function(t,r){return t&&o(t),e.renderTemplate(r,n,i,function(e,t){return e?o(e):(c.push(t),o())})})})},f=0,p=t.length;p>f;f++)u=t[f],h(u);return l.await(function(e){return a(e,e?void 0:c)})}return t.get(r,function(t,r){return t&&a(t),e.renderTemplate(r,n,i,a)})},e.deepClone=function(t,r){var n,o;if(!t||"object"!=typeof t)return t;if(s.isString(t))return String.prototype.slice.call(t);if(s.isDate(t))return new Date(t.valueOf());if(s.isFunction(t.clone))return t.clone();if(s.isArray(t))n=Array.prototype.slice.call(t);else{if(t.constructor!=={}.constructor)return t;n=s.extend({},t)}if(!s.isUndefined(r)&&r>0)for(o in n)n[o]=e.deepClone(n[o],r-1);return n},e}.call(this)}),t.register("queue",function(e,t,r){var n,o=function(e,t){return function(){return e.apply(t,arguments)}};r.exports=n=function(){function e(e){this.parallelism=e,this._doneTask=o(this._doneTask,this),this.parallelism||(this.parallelism=1/0),this.tasks=[],this.running_count=0,this.error=null,this.await_callback=null}return e.prototype.defer=function(e){return this.tasks.push(e),this._runTasks()},e.prototype.await=function(e){if(this.await_callback)throw new Error("Awaiting callback was added twice: "+e);return this.await_callback=e,!this.error&&this.tasks.length+this.running_count?void 0:this._callAwaiting()},e.prototype._doneTask=function(e){return this.running_count--,this.error||(this.error=e),this._runTasks()},e.prototype._runTasks=function(){var e;if(this.error||!(this.tasks.length+this.running_count))return this._callAwaiting();for(;this.running_count<this.parallelism;){if(!this.tasks.length)return;e=this.tasks.shift(),this.running_count++,e(this._doneTask)}},e.prototype._callAwaiting=function(){return!this.await_called&&this.await_callback?(this.await_called=!0,this.await_callback(this.error)):void 0},e}()}),t.register("schema",function(e,t,r){var n,o,i,s,a,u,l,c,h,f={}.hasOwnProperty,p=function(e,t){function r(){this.constructor=e}for(var n in t)f.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};h=t("underscore"),n=t("backbone"),c=t("inflection"),s=t("./relations/one"),i=t("./relations/many"),o=t("./database_url"),l=t("./utils"),a={hasOne:"hasOne",has_one:"hasOne",HasOne:"hasOne",belongsTo:"belongsTo",belongs_to:"belongsTo",BelongsTo:"belongsTo",hasMany:"hasMany",has_many:"hasMany",HasMany:"hasMany"},r.exports=u=function(){function e(e){this.model_type=e,this.raw=h.clone(h.result(new this.model_type,"schema")||{}),this.fields={},this.relations={},this.virtual_accessors={}}return e.prototype.initialize=function(){var e,t,r,n,o;if(!this.is_initialized){this.is_initialized=!0,n=this.raw;for(t in n)e=n[t],this._parseField(t,e);o=this.relations;for(t in o)r=o[t],r.initialize()}},e.prototype.relation=function(e){return this.relations[e]||this.virtual_accessors[e]},e.prototype.reverseRelation=function(e){var t,r,n;n=this.relations;for(t in n)if(r=n[t],r.reverse_relation&&r.reverse_relation.join_key===e)return r.reverse_relation;return null},e.prototype.allRelations=function(){var e,t,r,n;t=[],n=this.relations;for(e in n)r=n[e],t.push(r.reverse_model_type),r.join_table&&t.push(r.join_table);return t},e.prototype.generateBelongsTo=function(e){var t,r;return t=c.underscore(e.model_name),(r=this.relations[t])?r:this.raw[t]?(r=this._parseField(t,this.raw[t]),r.initialize(),r):(r=this._parseField(t,this.raw[t]=["belongsTo",e,{manual_fetch:!0}]),r.initialize(),r)},e.joinTableURL=function(e){var t,r;return t=c.pluralize(c.underscore(e.model_type.model_name)),r=c.pluralize(c.underscore(e.reverse_relation.model_type.model_name)),t.localeCompare(r)<0?""+t+"_"+r:""+r+"_"+t},e.prototype.generateJoinTable=function(t){var r,i,s,a,u,l;s={},s[t.join_key]=["Integer",{indexed:!0}],s[t.reverse_relation.join_key]=["Integer",{indexed:!0}],a=e.joinTableURL(t),i=c.pluralize(c.classify(a));try{r=function(e){function r(){return u=r.__super__.constructor.apply(this,arguments)}return p(r,e),r.prototype.model_name=i,r.prototype.urlRoot=""+new o(h.result(t.model_type.prototype,"url")).format({exclude_table:!0})+"/"+a,r.prototype.schema=s,r.prototype.sync=t.model_type.createSync(r),r}(n.Model)}catch(f){r=function(e){function r(){return l=r.__super__.constructor.apply(this,arguments)}return p(r,e),r.prototype.model_name=i,r.prototype.urlRoot="/"+a,r.prototype.schema=s,r.prototype.sync=t.model_type.createSync(r),r}(n.Model)}return r},e.prototype.allColumns=function(){var e,t,r,n;e=h.keys(this.fields),n=this.relations;for(t in n)r=n[t],"belongsTo"===r.type&&e.push(r.foreign_key);return e},e.prototype._parseField=function(e,t){var r,n,o;if(r=this._fieldInfoToOptions(h.isFunction(t)?t():t),!r.type)return this.fields[e]=r;if(!(o=a[r.type])){if(!h.isString(r.type))throw new Error("Unexpected type name is not a string: "+l.inspect(r));return this.fields[e]=r}return r.type=o,n=this.relations[e]="hasMany"===o?new i(this.model_type,e,r):new s(this.model_type,e,r),n.virtual_id_accessor&&(this.virtual_accessors[n.virtual_id_accessor]=n),"belongsTo"===o&&(this.virtual_accessors[n.foreign_key]=n),n},e.prototype._fieldInfoToOptions=function(e){var t;if(h.isString(e))return{type:e};if(!h.isArray(e))return e;if(t={},h.isString(e[0])&&(t.type=e[0],e=e.slice(1),0===e.length))return t;if(h.isFunction(e[0])&&(t.reverse_model_type=e[0],e=e.slice(1)),e.length>1)throw new Error("Unexpected field options array: "+l.inspect(e));return 1===e.length&&h.extend(t,e[0]),t},e}()}),t.register("utils",function(e,t,r){var n,o,i,s,a,u,l,c,h,f,p={}.hasOwnProperty,d=function(e,t){function r(){this.constructor=e}for(var n in t)p.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};u=t("url"),o=t("./database_url"),n=t("backbone"),f=t("underscore"),c=t("inflection"),s=t("./queue"),i=t("./json_utils"),h=null,a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},r.exports=l=function(){function e(){}return e.resetSchemas=function(e,t,r){var n,o,i,a,u,l,c,h,f;for(2===arguments.length&&(f=[{},t],t=f[0],r=f[1]),u=0,c=e.length;c>u;u++)o=e[u],o.schema();for(n=[],i=new s(1),a=function(e){return i.defer(function(r){return e.resetSchema(t,function(t){return t&&(n.push(e.model_name),console.log("Error when dropping schema for "+e.model_name+". "+t)),r()})})},l=0,h=e.length;h>l;l++)o=e[l],a(o);return i.await(function(){return t.verbose&&console.log(""+(e.length-n.length)+" schemas dropped."),n.length?r(new Error("Failed to migrate schemas: "+n.join(", "))):r()})},e.guid=function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},e.inspect=function(e){var t;try{return JSON.stringify(e)}catch(r){return t=r,"inspect: "+t}},e.bbCallback=function(e){return{success:function(t,r,n){return e(null,t,r,n)},error:function(t,r,n){return e(r||new Error("Backbone call failed"),t,r,n)}}},e.wrapOptions=function(t,r){return null==t&&(t={}),f.isFunction(t)&&(t=e.bbCallback(t)),f.defaults(e.bbCallback(function(e,n,o){return r(e,n,o,t)}),t)},e.isModel=function(e){return e&&e.attributes&&(e instanceof n.Model||e.parse&&e.fetch)},e.isCollection=function(e){return e&&e.models&&(e instanceof n.Collection||e.reset&&e.fetch)},e.get=function(e,t,r){return e._orm||(e._orm={}),e._orm.hasOwnProperty(t)?e._orm[t]:r},e.set=function(e,t,r){return e._orm||(e._orm={}),e._orm[t]=r,e._orm[t]},e.orSet=function(e,t,r){return e._orm||(e._orm={}),e._orm.hasOwnProperty(t)||(e._orm[t]=r),e._orm[t]},e.unset=function(e,t){return e._orm||(e._orm={}),delete e._orm[t]},e.findOrGenerateModelName=function(e){var t,r;if(e.prototype.model_name)return e.prototype.model_name;if((r=f.result(e.prototype,"url"))&&(t=new o(r).modelName()))return t;if(e.name)return e.name;throw"Could not find or generate model name for "+e},e.configureCollectionModelType=function(e,t){var r,o,i,s;return o=function(){var t,r;return t=f.result(this.collection||e.prototype,"url"),this.isNew()||(r=u.parse(t),r.pathname=""+r.pathname+"/encodeURIComponent(@id)",t=u.format(r)),t},i=e.prototype.model,i&&i!==n.Model?(i.prototype.sync===n.Model.prototype.sync&&(i.prototype.url=o,i.prototype.sync=t(i)),i):(r=function(e){function r(){return s=r.__super__.constructor.apply(this,arguments)}return d(r,e),r.prototype.url=o,r.prototype.sync=t(r),r}(n.Model),e.prototype.model=r)},e.configureModelType=function(e){return h||(h=t("./extensions/model")),h(e)},e.patchRemoveByJSON=function(e,t,r){var n,o,i,a,u,l,c;if(!(a=e.schema()))return r();for(o=new s(1),u=function(e){return o.defer(function(r){return e.patchRemove(t,r)})},i=l=0,c=a.length;c>l;i=++l)n=a[i],u(i);return o.await(r)},e.presaveBelongsToRelationships=function(e,t){var r,n,o,i,a,u,l,c,h,f,p;if(!e.schema)return t();n=new s(1),u=e.schema(),p=u.relations;for(r in p)if(a=p[r],"belongsTo"===a.type&&!a.isVirtual()&&(l=e.get(r)))for(i=l.models?l.models:[l],c=function(e){return n.defer(function(t){return e.save(t)})},h=0,f=i.length;f>h;h++)o=i[h],o.id||c(o);return n.await(t)},e.dataId=function(e){return f.isObject(e)?e.id:e},e.dataIsSameModel=function(t,r){return e.dataId(t)||e.dataId(r)?e.dataId(t)===e.dataId(r):f.isEqual(t,r)},e.dataToModel=function(t,r){var n,o,i;return t?f.isArray(t)?function(){var n,i,s;for(s=[],n=0,i=t.length;i>n;n++)o=t[n],s.push(e.dataToModel(o,r));return s}():(e.isModel(t)?i=t:e.dataId(t)!==t?i=new r(r.prototype.parse(t)):((n={})[r.prototype.idAttribute]=t,i=new r(n),i.setLoaded(!1)),i):null},e.updateModel=function(t,r){return!r||t===r||r._orm_needs_load?t:(e.isModel(r)&&(r=r.toJSON()),e.dataId(r)!==r&&(t.setLoaded(!0),t.set(r)),t)},e.updateOrNew=function(t,r){var n,o,i;return(n=r.cache)&&(o=e.dataId(t))&&(i=n.get(o))&&e.updateModel(i,t),i||(i=e.isModel(t)?t:e.dataToModel(t,r),i&&n&&n.set(i.id,i)),i},e.modelJSONSave=function(t,r,o){var i;return i=new n.Model(t),i._orm_never_cache=!0,i.urlRoot=function(){var e,t;try{t=f.result(r.prototype,"url")}catch(n){e=n}return t},r.prototype.sync("update",i,e.bbCallback(o))},e.isSorted=function(e,t){var r,n,o,i;for(t=f.uniq(t),o=0,i=e.length;i>o;o++){if(n=e[o],r&&1===this.fieldCompare(r,n,t))return!1;r=n}return!0},e.fieldCompare=function(e,t,r){var n,o;return o=r[0],f.isArray(o)&&(o=o[0]),"-"===o.charAt(0)&&(o=o.substr(1),n=!0),e.get(o)===t.get(o)?r.length>1?this.fieldCompare(e,t,r.splice(1)):0:n?e.get(o)<t.get(o)?1:-1:e.get(o)>t.get(o)?1:-1},e.jsonFieldCompare=function(e,t,r){var n,o;return o=r[0],f.isArray(o)&&(o=o[0]),"-"===o.charAt(0)&&(o=o.substr(1),n=!0),e[o]===t[o]?r.length>1?this.jsonFieldCompare(e,t,r.splice(1)):0:n?JSON.stringify(e[o])<JSON.stringify(t[o])?1:-1:JSON.stringify(e[o])>JSON.stringify(t[o])?1:-1},e}()}),t.register("_shims",function(e){function t(e){return"[object Array]"===a.call(e)}function r(e,t){var r;if(null===e)r={__proto__:null};else{if("object"!=typeof e)throw new TypeError("typeof prototype["+typeof e+"] != 'object'");var n=function(){};n.prototype=e,r=new n,r.__proto__=e}return"undefined"!=typeof t&&Object.defineProperties&&Object.defineProperties(r,t),r}function n(e){return"object"!=typeof e&&"function"!=typeof e||null===e}function o(e){if(n(e))throw new TypeError("Object.keys called on a non-object");var t=[];for(var r in e)u.call(e,r)&&t.push(r);return t}function i(t){if(n(t))throw new TypeError("Object.getOwnPropertyNames called on a non-object");var r=o(t);return e.isArray(t)&&-1===e.indexOf(t,"length")&&r.push("length"),r}function s(e,t){return{value:e[t]}}var a=Object.prototype.toString,u=Object.prototype.hasOwnProperty;e.isArray="function"==typeof Array.isArray?Array.isArray:t,e.indexOf=function(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0;r<e.length;r++)if(t===e[r])return r;return-1},e.filter=function(e,t){if(e.filter)return e.filter(t);for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r},e.forEach=function(e,t,r){if(e.forEach)return e.forEach(t,r);for(var n=0;n<e.length;n++)t.call(r,e[n],n,e)},e.map=function(e,t){if(e.map)return e.map(t);for(var r=new Array(e.length),n=0;n<e.length;n++)r[n]=t(e[n],n,e);return r},e.reduce=function(e,t,r){if(e.reduce)return e.reduce(t,r);var n,o=!1;2<arguments.length&&(n=r,o=!0);for(var i=0,s=e.length;s>i;++i)e.hasOwnProperty(i)&&(o?n=t(n,e[i],i,e):(n=e[i],o=!0));return n},e.substr="b"!=="ab".substr(-1)?function(e,t,r){return 0>t&&(t=e.length+t),e.substr(t,r)}:function(e,t,r){return e.substr(t,r)},e.trim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},e.bind=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();if(t.bind)return t.bind.apply(t,e);var r=e.shift();return function(){t.apply(r,e.concat([Array.prototype.slice.call(arguments)]))}},e.create="function"==typeof Object.create?Object.create:r;var l="function"==typeof Object.keys?Object.keys:o,c="function"==typeof Object.getOwnPropertyNames?Object.getOwnPropertyNames:i;if((new Error).hasOwnProperty("description")){var h=function(t,r){return"[object Error]"===a.call(t)&&(r=e.filter(r,function(e){return"description"!==e&&"number"!==e&&"message"!==e})),r};e.keys=function(e){return h(e,l(e))},e.getOwnPropertyNames=function(e){return h(e,c(e))}}else e.keys=l,e.getOwnPropertyNames=c;if("function"==typeof Object.getOwnPropertyDescriptor)try{Object.getOwnPropertyDescriptor({a:1},"a"),e.getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor}catch(f){e.getOwnPropertyDescriptor=function(e,t){try{return Object.getOwnPropertyDescriptor(e,t)}catch(r){return s(e,t)}}}else e.getOwnPropertyDescriptor=s}),t.register("lru-cache",function(e,t,r){!function(){function e(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function t(){return 1}function n(r){function i(e,t){var r=y[e];return r&&(p&&Date.now()-r.now>p?(l(r),f||(r=void 0)):t&&s(r),r&&(r=r.value)),r}function s(e){u(e),e.lu=m++,_[e.lu]=e}function a(){for(;m>v&&g>c;)l(_[v])}function u(e){for(delete _[e.lu];m>v&&!_[v];)v++}function l(e){e&&(d&&d(e.key,e.value),g-=e.length,b--,delete y[e.key],u(e))}if(!(this instanceof n))return new n(r);var c;"number"==typeof r&&(c=r,r={max:c}),r||(r={}),c=r.max;var h=r.length||t;"function"!=typeof h&&(h=t),(!c||"number"!=typeof c||0>=c)&&(c=1/0);var f=r.stale||!1,p=r.maxAge||null,d=r.dispose,y=Object.create(null),_=Object.create(null),m=0,v=0,g=0,b=0;Object.defineProperty(this,"max",{set:function(e){(!e||"number"!=typeof e||0>=e)&&(e=1/0),c=e,g>c&&a()},get:function(){return c},enumerable:!0}),Object.defineProperty(this,"lengthCalculator",{set:function(e){if("function"!=typeof e){h=t,g=b;for(var r in y)y[r].length=1}else{h=e,g=0;for(var r in y)y[r].length=h(y[r].value),g+=y[r].length}g>c&&a()},get:function(){return h},enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return g},enumerable:!0}),Object.defineProperty(this,"itemCount",{get:function(){return b},enumerable:!0}),this.forEach=function(e,t){t=t||this;for(var r=0,n=m-1;n>=0&&b>r;n--)if(_[n]){r++;var o=_[n];p&&Date.now()-o.now>p&&(l(o),f||(o=void 0)),o&&e.call(t,o.value,o.key,this)}},this.keys=function(){for(var e=new Array(b),t=0,r=m-1;r>=0&&b>t;r--)if(_[r]){var n=_[r];e[t++]=n.key}return e},this.values=function(){for(var e=new Array(b),t=0,r=m-1;r>=0&&b>t;r--)if(_[r]){var n=_[r];e[t++]=n.value}return e},this.reset=function(){if(d)for(var e in y)d(e,y[e].value);y={},_={},v=0,m=0,g=0,b=0},this.dump=function(){return y},this.dumpLru=function(){return _},this.set=function(t,r){if(e(y,t))return d&&d(t,y[t].value),p&&(y[t].now=Date.now()),y[t].value=r,this.get(t),!0;var n=h(r),i=p?Date.now():0,s=new o(t,r,m++,n,i);return s.length>c?(d&&d(t,r),!1):(g+=s.length,_[s.lu]=y[t]=s,b++,g>c&&a(),!0)},this.has=function(t){if(!e(y,t))return!1;var r=y[t];return p&&Date.now()-r.now>p?!1:!0},this.get=function(e){return i(e,!0)},this.peek=function(e){return i(e,!1)},this.del=function(e){l(y[e])}}function o(e,t,r,n,o){this.key=e,this.value=t,this.lu=r,this.length=n,this.now=o}"object"==typeof r&&r.exports?r.exports=n:this.LRUCache=n}()}),t.register("querystring",function(e,t){function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var n=e,o=t("util"),i=t("_shims");n.unescape=function(e){return decodeURIComponent(e)},n.escape=function(e){return encodeURIComponent(e)};var s=function(e){return o.isString(e)?e:o.isBoolean(e)?e?"true":"false":o.isNumber(e)?isFinite(e)?e:"":""};n.stringify=n.encode=function(e,t,r,a){return t=t||"&",r=r||"=",o.isNull(e)&&(e=void 0),o.isObject(e)?i.map(i.keys(e),function(a){var u=n.escape(s(a))+r;return o.isArray(e[a])?i.map(e[a],function(e){return u+n.escape(s(e))}).join(t):u+n.escape(s(e[a]))}).join(t):a?n.escape(s(a))+r+n.escape(s(e)):""},n.parse=n.decode=function(e,t,i,s){t=t||"&",i=i||"=";var a={};if(!o.isString(e)||0===e.length)return a;var u=/\+/g;e=e.split(t);var l=1e3;s&&o.isNumber(s.maxKeys)&&(l=s.maxKeys);var c=e.length;l>0&&c>l&&(c=l);for(var h=0;c>h;++h){var f,p,d,y,_=e[h].replace(u,"%20"),m=_.indexOf(i);m>=0?(f=_.substr(0,m),p=_.substr(m+1)):(f=_,p="");try{d=decodeURIComponent(f),y=decodeURIComponent(p)}catch(v){d=n.unescape(f,!0),y=n.unescape(p,!0)}r(a,d)?o.isArray(a[d])?a[d].push(y):a[d]=[a[d],y]:a[d]=y}return a}}),t.register("url",function(e,t){function r(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function n(e,t,n){if(e&&u.isObject(e)&&e instanceof r)return e;var o=new r;return o.parse(e,t,n),o}function o(e){return u.isString(e)&&(e=n(e)),e instanceof r?e.format():r.prototype.format.call(e)}function i(e,t){return n(e,!1,!0).resolve(t)
}function s(e,t){return e?n(e,!1,!0).resolveObject(t):t}var a={encode:function(e){return e}},u=t("util"),l=t("_shims");e.parse=n,e.resolve=i,e.resolveObject=s,e.format=o,e.Url=r;var c=/^([a-z0-9.+-]+:)/i,h=/:[0-9]*$/,f=["<",">",'"',"`"," ","\r","\n","	"],p=["{","}","|","\\","^","`"].concat(f),d=["'"].concat(p),y=["%","/","?",";","#"].concat(d),_=["/","?","#"],m=255,v=/^[a-z0-9A-Z_-]{0,63}$/,g=/^([a-z0-9A-Z_-]{0,63})(.*)$/,b={javascript:!0,"javascript:":!0},w={javascript:!0,"javascript:":!0},k={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},O=t("querystring");r.prototype.parse=function(e,t,r){if(!u.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var n=e;n=l.trim(n);var o=c.exec(n);if(o){o=o[0];var i=o.toLowerCase();this.protocol=i,n=n.substr(o.length)}if(r||o||n.match(/^\/\/[^@\/]+@[^@\/]+/)){var s="//"===n.substr(0,2);!s||o&&w[o]||(n=n.substr(2),this.slashes=!0)}if(!w[o]&&(s||o&&!k[o])){for(var h=-1,f=0;f<_.length;f++){var p=n.indexOf(_[f]);-1!==p&&(-1===h||h>p)&&(h=p)}var $,S;S=-1===h?n.lastIndexOf("@"):n.lastIndexOf("@",h),-1!==S&&($=n.slice(0,S),n=n.slice(S+1),this.auth=decodeURIComponent($)),h=-1;for(var f=0;f<y.length;f++){var p=n.indexOf(y[f]);-1!==p&&(-1===h||h>p)&&(h=p)}-1===h&&(h=n.length),this.host=n.slice(0,h),n=n.slice(h),this.parseHost(),this.hostname=this.hostname||"";var j="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!j)for(var M=this.hostname.split(/\./),f=0,x=M.length;x>f;f++){var N=M[f];if(N&&!N.match(v)){for(var C="",E=0,A=N.length;A>E;E++)C+=N.charCodeAt(E)>127?"x":N[E];if(!C.match(v)){var T=M.slice(0,f),J=M.slice(f+1),q=N.match(g);q&&(T.push(q[1]),J.unshift(q[2])),J.length&&(n="/"+J.join(".")+n),this.hostname=T.join(".");break}}}if(this.hostname=this.hostname.length>m?"":this.hostname.toLowerCase(),!j){for(var R=this.hostname.split("."),I=[],f=0;f<R.length;++f){var z=R[f];I.push(z.match(/[^A-Za-z0-9_-]/)?"xn--"+a.encode(z):z)}this.hostname=I.join(".")}var P=this.port?":"+this.port:"",L=this.hostname||"";this.host=L+P,this.href+=this.host,j&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==n[0]&&(n="/"+n))}if(!b[i])for(var f=0,x=d.length;x>f;f++){var F=d[f],U=encodeURIComponent(F);U===F&&(U=escape(F)),n=n.split(F).join(U)}var D=n.indexOf("#");-1!==D&&(this.hash=n.substr(D),n=n.slice(0,D));var Q=n.indexOf("?");if(-1!==Q?(this.search=n.substr(Q),this.query=n.substr(Q+1),t&&(this.query=O.parse(this.query)),n=n.slice(0,Q)):t&&(this.search="",this.query={}),n&&(this.pathname=n),k[i]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var P=this.pathname||"",z=this.search||"";this.path=P+z}return this.href=this.format(),this},r.prototype.format=function(){var e=this.auth||"";e&&(e=encodeURIComponent(e),e=e.replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",o=!1,i="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&u.isObject(this.query)&&l.keys(this.query).length&&(i=O.stringify(this.query));var s=this.search||i&&"?"+i||"";return t&&":"!==l.substr(t,-1)&&(t+=":"),this.slashes||(!t||k[t])&&o!==!1?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),n&&"#"!==n.charAt(0)&&(n="#"+n),s&&"?"!==s.charAt(0)&&(s="?"+s),r=r.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),s=s.replace("#","%23"),t+o+r+s+n},r.prototype.resolve=function(e){return this.resolveObject(n(e,!1,!0)).format()},r.prototype.resolveObject=function(e){if(u.isString(e)){var t=new r;t.parse(e,!1,!0),e=t}var n=new r;if(l.forEach(l.keys(this),function(e){n[e]=this[e]},this),n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol)return l.forEach(l.keys(e),function(t){"protocol"!==t&&(n[t]=e[t])}),k[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n;if(e.protocol&&e.protocol!==n.protocol){if(!k[e.protocol])return l.forEach(l.keys(e),function(t){n[t]=e[t]}),n.href=n.format(),n;if(n.protocol=e.protocol,e.host||w[e.protocol])n.pathname=e.pathname;else{for(var o=(e.pathname||"").split("/");o.length&&!(e.host=o.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==o[0]&&o.unshift(""),o.length<2&&o.unshift(""),n.pathname=o.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var i=n.pathname||"",s=n.search||"";n.path=i+s}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var a=n.pathname&&"/"===n.pathname.charAt(0),c=e.host||e.pathname&&"/"===e.pathname.charAt(0),h=c||a||n.host&&e.pathname,f=h,p=n.pathname&&n.pathname.split("/")||[],o=e.pathname&&e.pathname.split("/")||[],d=n.protocol&&!k[n.protocol];if(d&&(n.hostname="",n.port=null,n.host&&(""===p[0]?p[0]=n.host:p.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===o[0]?o[0]=e.host:o.unshift(e.host)),e.host=null),h=h&&(""===o[0]||""===p[0])),c)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,p=o;else if(o.length)p||(p=[]),p.pop(),p=p.concat(o),n.search=e.search,n.query=e.query;else if(!u.isNullOrUndefined(e.search)){if(d){n.hostname=n.host=p.shift();var y=n.host&&n.host.indexOf("@")>0?n.host.split("@"):!1;y&&(n.auth=y.shift(),n.host=n.hostname=y.shift())}return n.search=e.search,n.query=e.query,u.isNull(n.pathname)&&u.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!p.length)return n.pathname=null,n.path=n.search?"/"+n.search:null,n.href=n.format(),n;for(var _=p.slice(-1)[0],m=(n.host||e.host)&&("."===_||".."===_)||""===_,v=0,g=p.length;g>=0;g--)_=p[g],"."==_?p.splice(g,1):".."===_?(p.splice(g,1),v++):v&&(p.splice(g,1),v--);if(!h&&!f)for(;v--;v)p.unshift("..");!h||""===p[0]||p[0]&&"/"===p[0].charAt(0)||p.unshift(""),m&&"/"!==l.substr(p.join("/"),-1)&&p.push("");var b=""===p[0]||p[0]&&"/"===p[0].charAt(0);if(d){n.hostname=n.host=b?"":p.length?p.shift():"";var y=n.host&&n.host.indexOf("@")>0?n.host.split("@"):!1;y&&(n.auth=y.shift(),n.host=n.hostname=y.shift())}return h=h||n.host&&p.length,h&&!b&&p.unshift(""),p.length?n.pathname=p.join("/"):(n.pathname=null,n.path=null),u.isNull(n.pathname)&&u.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},r.prototype.parseHost=function(){var e=this.host,t=h.exec(e);t&&(t=t[0],":"!==t&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}}),t.register("util",function(e,t){function r(e){return l.isArray(e)}function n(e){return"boolean"==typeof e}function o(e){return null===e}function i(e){return null==e}function s(e){return"number"==typeof e}function a(e){return"string"==typeof e}function u(e){return"object"==typeof e&&e}var l=t("_shims");e.isArray=r,e.isBoolean=n,e.isNull=o,e.isNullOrUndefined=i,e.isNumber=s,e.isString=a,e.isObject=u}),t.register("cache/cursor",function(e,t,r){var n,o,i,s={}.hasOwnProperty,a=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};o=t("underscore"),r.exports=n=function(e){function t(){return i=t.__super__.constructor.apply(this,arguments)}return a(t,e),t.prototype.toJSON=function(e){return this.wrapped_sync_fn("cursor",o.extend({},this._find,this._cursor)).toJSON(e)},t}(t("../cursor"))}),t.register("cache/memory_store",function(e,t,r){var n,o,i,s,a=function(e,t){return function(){return e.apply(t,arguments)}};s=t("underscore"),n=t("lru-cache"),i=t("inflection"),r.exports=o=function(){function e(e){var t,r,o;null==e&&(e={}),this.forEach=a(this.forEach,this),this.reset=a(this.reset,this),this.destroy=a(this.destroy,this),this.get=a(this.get,this),this.set=a(this.set,this),r={};for(t in e)o=e[t],"destroy"===t?r.dispose=o:r[this._normalizeKey(t)]=o;this.cache=new n(r)}return e.prototype.set=function(e,t,r){return t._orm_never_cache?("function"==typeof r?r(null,t):void 0)||this:(this.cache.set(e,t),"function"==typeof r&&r(null,t),this)},e.prototype.get=function(e,t){var r;return r=this.cache.get(e),"function"==typeof t&&t(null,r),r},e.prototype.destroy=function(e,t){return this.cache.del(e),"function"==typeof t&&t(),this},e.prototype.reset=function(e){return this.cache.reset(),"function"==typeof e&&e(),this},e.prototype._normalizeKey=function(e){return e=i.underscore(e),e.indexOf("_")<0?e.toLowerCase():i.camelize(e)},e.prototype.forEach=function(e){return this.cache.forEach(e)},e}()}),t.register("cache/model_cache",function(e,t,r){var n,o,i,s,a,u;n=t("backbone"),u=t("underscore"),a=t("../queue"),i=t("./memory_store"),o=["max","max_age","destroy"],r.exports=s=function(){function e(){this.enabled=!1,this.caches={},this.options={modelTypes:{}},this.verbose=!1}return e.prototype.configure=function(e){var t,r,n,o,i,s;null==e&&(e={}),this.enabled=e.enabled,this.reset(function(){});for(t in e)if(r=e[t],u.isObject(r)){(s=this.options)[t]||(s[t]={}),i=this.options[t];for(n in r)o=r[n],i[n]=o}else this.options[t]=r;return this},e.prototype.configureSync=function(e,r){var n;return e.prototype._orm_never_cache||!(n=this.getOrCreateCache(e.model_name))?r:(e.cache=n,t("./sync")(e,r))},e.prototype.reset=function(e){var t,r,n,o,i;r=new a,i=this.caches,o=function(e){return r.defer(function(t){return e.reset(t)})};for(t in i)n=i[t],o(n);return r.await(e)},e.prototype.hardReset=function(){var e,t,r;this.reset(function(){}),r=this.caches;for(e in r)t=r[e],delete this.caches[e];return this},e.prototype.getOrCreateCache=function(e){var t,r,n;if(!this.enabled)return null;if(!e)throw new Error("Missing model name for cache");return(t=this.caches[e])?t:(r=this.options.modelTypes[e])?this.caches[e]=("function"==typeof r.store?r.store():void 0)||new i(u.pick(r,o)):this.options.store||this.options.max||this.options.max_age?this.caches[e]=("function"==typeof(n=this.options).store?n.store():void 0)||new i(u.pick(this.options,o)):null},e}()}),t.register("cache/query_cache",function(e,t,r){var n,o,i,s,a,u,l,c=function(e,t){return function(){return e.apply(t,arguments)}};l=t("underscore"),u=t("inflection"),a=t("../queue"),o=t("../json_utils"),i=t("./memory_store"),n=2,r.exports=s=function(){function e(){this.storeKeyForModelTypes=c(this.storeKeyForModelTypes,this),this.getKeysForModelTypes=c(this.getKeysForModelTypes,this),this.clearMetaForModelTypes=c(this.clearMetaForModelTypes,this),this.clearModelTypes=c(this.clearModelTypes,this),this.reset=c(this.reset,this),this.hardReset=c(this.hardReset,this),this.getMeta=c(this.getMeta,this),this.getKey=c(this.getKey,this),this.get=c(this.get,this),this.set=c(this.set,this),this.configure=c(this.configure,this),this.enabled=!1}return e.prototype.configure=function(e){return null==e&&(e={}),this.enabled=e.enabled,this.verbose=e.verbose,this.hits=this.misses=this.clears=0,this.store=e.store||new i,this},e.prototype.cacheKey=function(e,t){return""+e.model_id+"_"+JSON.stringify(t)},e.prototype.cacheKeyMeta=function(e){return"meta_"+e.model_id},e.prototype.set=function(e,t,r,i,s){var a,u,l,c=this;return this.enabled?(this.verbose&&console.log("QueryCache:set",e.model_name,function(){var e,t,n;for(n=[],e=0,t=r.length;t>e;e++)u=r[e],n.push(u.model_name);return n}(),this.cacheKey(e,t),JSON.stringify(i),"\n-----------"),l=[e].concat(r||[]),a=this.cacheKey(e,t),this.store.set(a,o.deepClone(i,n),function(e){return e?s(e):c.storeKeyForModelTypes(l,a,s)})):s()},e.prototype.get=function(e,t,r){return this.enabled?this.getKey(this.cacheKey(e,t),r):r()},e.prototype.getKey=function(e,t){var r=this;return this.enabled?this.store.get(e,function(i,s){return i?t(i):l.isUndefined(s)||l.isNull(s)?(r.misses++,r.verbose&&console.log("QueryCache:miss",e,s,"\n-----------"),t()):(r.hits++,r.verbose&&console.log("QueryCache:hit",e,s,"\n-----------"),t(null,o.deepClone(s,n)))}):t()},e.prototype.getMeta=function(e,t){return this.enabled?this.store.get(this.cacheKeyMeta(e),t):t()},e.prototype.hardReset=function(e){return this.enabled?(this.verbose&&console.log("QueryCache:hardReset"),this.hits=this.misses=this.clears=0,this.store?this.store.reset(e):e()):e()},e.prototype.reset=function(e,t){var r,n,o,i;if(1===arguments.length)return this.hardReset(e);if(!this.enabled)return t();for(l.isArray(e)||(e=[e]),n=[],o=0,i=e.length;i>o;o++)r=e[o],n=n.concat(r.schema().allRelations());return e=e.concat(n),this.clearModelTypes(e,t)},e.prototype.clearModelTypes=function(e,t){var r=this;return e.length?this.getKeysForModelTypes(e,function(n,o){var i,s,u,c,h,f;if(n)return t(n);for(s=new a,s.defer(function(t){return r.clearMetaForModelTypes(e,t)}),f=l.uniq(o),u=function(e){return s.defer(function(t){return r.verbose&&console.log("QueryCache:cleared",e,"\n-----------"),r.clears++,r.store.destroy(e,t)})},c=0,h=f.length;h>c;c++)i=f[c],u(i);return s.await(t)}):t()},e.prototype.clearMetaForModelTypes=function(e,t){var r,n,o,i,s,u=this;for(n=new a,o=function(e){return n.defer(function(t){return u.verbose&&console.log("QueryCache:meta cleared",e.model_name,"\n-----------"),u.store.destroy(u.cacheKeyMeta(e),t)})},i=0,s=e.length;s>i;i++)r=e[i],o(r);return n.await(t)},e.prototype.getKeysForModelTypes=function(e,t){var r,n,o,i,s,u,l=this;for(r=[],o=new a(1),i=function(e){return o.defer(function(t){return l.getMeta(e,function(e,n){return e||!n?t(e):(r=r.concat(n),t())})})},s=0,u=e.length;u>s;s++)n=e[s],i(n);return o.await(function(e){return t(e,r)})},e.prototype.storeKeyForModelTypes=function(e,t,r){var n,o,i,s,u,c=this;for(o=new a(1),i=function(e){return o.defer(function(r){var n;return n=c.cacheKeyMeta(e),c.store.get(n,function(e,o){return e?r(e):((o||(o=[])).push(t),c.store.set(n,l.uniq(o),r))})})},s=0,u=e.length;u>s;s++)n=e[s],i(n);return o.await(r)},e}()}),t.register("cache/singletons",function(e,t,r){var n;r.exports={ModelCache:new(t("./model_cache")),QueryCache:new(t("./query_cache"))};try{r.exports.ModelTypeID=new(t("../node/model_type_id"))}catch(o){n=o}}),t.register("cache/sync",function(e,t,r){var n,o,i,s,a,u,l,c;c=t("underscore"),n=t("./cursor"),a=t("../schema"),u=t("../utils"),l=u.bbCallback,i=1e3,s=100,o=function(){function e(e,t){this.model_type=e,this.wrapped_sync_fn=t}return e.prototype.initialize=function(){if(!this.is_initialized&&(this.is_initialized=!0,this.wrapped_sync_fn("initialize"),!this.model_type.model_name))throw new Error("Missing model_name for model")},e.prototype.read=function(e,t){var r;return!t.force&&(r=this.model_type.cache.get(e.id))?t.success(r.toJSON()):this.wrapped_sync_fn("read",e,t)},e.prototype.create=function(e,t){var r=this;return this.wrapped_sync_fn("create",e,l(function(n,o){var i,s;return n?t.error(n):((i={})[r.model_type.prototype.idAttribute]=o[r.model_type.prototype.idAttribute],e.set(i),(s=r.model_type.cache.get(e.id))?s!==e&&u.updateModel(s,e):r.model_type.cache.set(e.id,e),t.success(o))}))},e.prototype.update=function(e,t){var r=this;return this.wrapped_sync_fn("update",e,l(function(n,o){var i;return n?t.error(n):((i=r.model_type.cache.get(e.id))?i!==e&&u.updateModel(i,e):r.model_type.cache.set(e.id,e),t.success(o))}))},e.prototype["delete"]=function(e,t){return this.model_type.cache.destroy(e.id),this.wrapped_sync_fn("delete",e,l(function(e,r){return e?t.error(e):t.success(r)}))},e.prototype.resetSchema=function(e,t){var r=this;return this.model_type.cache.reset(function(n){return n?t(n):r.wrapped_sync_fn("resetSchema",e,t)})},e.prototype.cursor=function(e){return null==e&&(e={}),new n(e,c.pick(this,["model_type","wrapped_sync_fn"]))},e.prototype.destroy=function(e,t){return this.model_type.each(c.extend({$each:{limit:i,threads:s}},e),function(e,t){return e.destroy(t)},t)},e.prototype.connect=function(){return this.model_type.cache.reset(),this.wrapped_sync_fn("connect")},e}(),r.exports=function(e,t){var r,n;return r=new o(e,t),e.prototype.sync=n=function(e,n,o){return null==o&&(o={}),r.initialize(),"createSync"===e?t.apply(null,arguments):"sync"===e?r:r[e]?r[e].apply(r,Array.prototype.slice.call(arguments,1)):t.apply(t,Array.prototype.slice.call(arguments))},n}}),t.register("extensions/collection",function(e,t){var r,n,o,i,s,a,u;if(u=t("underscore"),r=t("backbone"),n=t("../utils"),o=r.Collection,a={fetch:function(e){var t,r=this;if(u.isFunction(t=arguments[arguments.length-1]))switch(arguments.length){case 1:e=n.wrapOptions({},t);break;case 2:e=n.wrapOptions(e,t)}return o.prototype._orm_original_fns.fetch.call(this,n.wrapOptions(e,function(e,t,n,o){return e?"function"==typeof o.error?o.error(r,n,o):void 0:"function"==typeof o.success?o.success(t,n,o):void 0}))},_prepareModel:function(e,t){var r,i,s;return!n.isModel(e)&&(r=n.dataId(e))?(this.model.cache&&(i=!!this.model.cache.get(r)),s=n.updateOrNew(e,this.model),i&&!s._validate(e,t)?(this.trigger("invalid",this,e,t),!1):s):o.prototype._orm_original_fns._prepareModel.call(this,e,t)}},!o.prototype._orm_original_fns){o.prototype._orm_original_fns={};for(s in a)i=a[s],o.prototype._orm_original_fns[s]=o.prototype[s],o.prototype[s]=i}}),t.register("extensions/model",function(e,t,r){var n,o,i,s,a,u,l,c,h;h=t("underscore"),n=t("backbone"),c=t("moment"),s=t("../queue"),a=t("../utils"),i=t("./model_stream"),u=t("./model_each"),l=t("./model_interval"),o=t("../database_url"),t("./collection"),r.exports=function(e){var t,r,n,o,f,p;if(t=function(){function e(){}return e}(),e.createSync=function(t){return e.prototype.sync("createSync",t)},e.resetSchema=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("resetSchema",t,r)},e.cursor=function(t){return null==t&&(t={}),e.prototype.sync("cursor",t)},e.destroy=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),h.isObject(t)||(t={id:t}),e.prototype.sync("destroy",t,r)},e.db=function(){return e.prototype.sync("db")},e.exists=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).exists(r)},e.count=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).count(r)},e.all=function(t){return e.prototype.sync("cursor",{}).toModels(t)},e.find=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),e.prototype.sync("cursor",t).toModels(r)},e.findOne=function(t,r){var n;return 1===arguments.length&&(n=[{},t],t=n[0],r=n[1]),t=h.isObject(t)?h.extend({$one:!0},t):{id:t,$one:!0},e.prototype.sync("cursor",t).toModels(r)},e.findOrCreate=function(t,r){var n;if(!h.isObject(t)||a.isModel(t)||a.isCollection(t))throw"findOrCreate requires object data";return n=h.extend({$one:!0},t),e.prototype.sync("cursor",n).toModels(function(n,o){return n?r(n):o?r(null,o):new e(t).save(r)})},e.findOneNearestDate=function(t,r,n,o){var i,s,a,u;if(!(s=r.key))throw new Error("Missing options key");return 2===arguments.length?(a=[{},n],n=a[0],o=a[1]):3===arguments.length?(u=[c.utc().toDate(),{},n],r=u[0],n=u[1],o=u[2]):n=h.clone(n),n.$one=!0,i=[function(r){return n[s]={$lte:t},e.cursor(n).sort("-"+s).toModels(r)},function(r){return n[s]={$gte:t},e.cursor(n).sort(s).toModels(r)}],r.reverse&&(i=[i[1],i[0]]),i[0](function(e,t){return e?o(e):t?o(null,t):i[1](o)})},e.each=function(t,r,n){var o;return 2===arguments.length&&(o=[{},t,r],t=o[0],r=o[1],n=o[2]),u(e,t,r,n)},e.eachC=function(t,r,n){var o;return 2===arguments.length&&(o=[{},t,r],t=o[0],r=o[1],n=o[2]),u(e,t,n,r)},e.stream=function(t){if(null==t&&(t={}),!i)throw new Error('Stream is a large dependency so you need to manually include "stream.js" in the browser.');return new i(e,t)},e.interval=function(t,r,n){return l(e,t,r,n)},e.intervalC=function(t,r,n){return l(e,t,n,r)},e.prototype.modelName=function(){return e.model_name},e.prototype.cache=function(){return e.cache},e.prototype.schema=e.schema=function(){return e.prototype.sync("schema")},e.prototype.tableName=e.tableName=function(){return e.prototype.sync("tableName")},e.prototype.relation=e.relation=function(t){var r;return(r=e.prototype.sync("schema"))?r.relation(t):void 0},e.prototype.relationIsEmbedded=e.relationIsEmbedded=function(t){var r;return(r=e.relation(t))?!!r.embed:!1},e.prototype.reverseRelation=e.reverseRelation=function(t){var r;return(r=e.prototype.sync("schema"))?r.reverseRelation(t):void 0},e.prototype.isLoaded=function(e){return 0===arguments.length&&(e="__model__"),!a.orSet(this,"needs_load",{})[e]},e.prototype.setLoaded=function(e,t){var r,n;return 1===arguments.length&&(n=["__model__",e],e=n[0],t=n[1]),r=a.orSet(this,"needs_load",{}),t&&a.get(this,"is_initialized")?(delete r[e],void 0):r[e]=!t},e.prototype.isLoadedExists=function(e){return 0===arguments.length&&(e="__model__"),a.orSet(this,"needs_load",{}).hasOwnProperty(e)},e.prototype.isPartial=function(){return!!a.get(this,"partial")},e.prototype.setPartial=function(e){return e?a.set(this,"partial",!0):a.unset(this,"partial")},e.prototype.fetchRelated=function(e,t){var r,n,o=this;return 1===arguments.length&&(n=[null,e],e=n[0],t=n[1]),r=new s(1),r.defer(function(e){return o.isLoaded()?e():o.fetch(e)}),r.defer(function(t){var r,n,i,u,l,c;for(n=h.keys(a.orSet(o,"needs_load",{})),e&&!h.isArray(e)&&(e=[e]),h.isArray(e)&&(n=h.intersection(n,e)),i=new s,u=function(e){return i.defer(function(t){return o.get(e,t)})},l=0,c=n.length;c>l;l++)r=n[l],u(r);return i.await(t)}),r.await(t)},e.prototype.patchAdd=function(e,t,r){var n;return(n=this.relation(e))?t?n.patchAdd(this,t,r):r(new Error("patchAdd: missing relateds for '"+e+"'")):r(new Error("patchAdd: relation '"+e+"' unrecognized"))},e.prototype.patchRemove=function(t,r,n){var o,i,a,u,l,c=this;if(1===arguments.length){n=t,a=e.schema(),o=new s(1),l=a.relations,u=function(e){return o.defer(function(t){return e.patchRemove(c,t)})};for(t in l)i=l[t],u(i);return o.await(n)}return(i=this.relation(t))?2===arguments.length?(n=r,i.patchRemove(this,n)):r?i.patchRemove(this,r,n):n(new Error("patchRemove: missing relateds for '"+t+"'")):n(new Error("patchRemove: relation '"+t+"' unrecognized"))},e.prototype.cursor=function(t,r){var n,o;if(null==r&&(r={}),e.schema&&(o=e.schema()),o&&(n=o.relation(t)))return n.cursor(this,t,r);throw new Error(""+o.model_name+"::cursor: Unexpected key: "+t+" is not a relation")},f=function(e,t){var r,n,o,i;return e.isNew()||!e.modelName?e.clone(t):(r=(o=t._cache)[i=e.modelName()]||(o[i]={}),(n=r[e.id])||(n=r[e.id]=e.clone(t)),n)},o={initialize:function(){var t,r,n,o,i,s;if(e.schema&&(o=e.schema())){s=o.relations;for(t in s)n=s[t],n.initializeModel(this);r=a.orSet(this,"needs_load",{});for(t in r)i=r[t],i||delete r[t];a.set(this,"is_initialized",!0)}return e.prototype._orm_original_fns.initialize.apply(this,arguments)},fetch:function(t){var r,n=this;if(h.isFunction(r=arguments[arguments.length-1]))switch(arguments.length){case 1:t=a.wrapOptions({},r);break;case 2:t=a.wrapOptions(t,r)}else t||(t={});return e.prototype._orm_original_fns.fetch.call(this,a.wrapOptions(t,function(e,t,r,o){return e?"function"==typeof o.error?o.error(n,r,o):void 0:(n.setLoaded(!0),"function"==typeof o.success?o.success(n,r,o):void 0)}))},unset:function(t){var r;return r=this.id,e.prototype._orm_original_fns.unset.apply(this,arguments),"id"===t&&e.cache&&r&&e.cache.get(r)===this?e.cache.destroy(r):void 0},set:function(t,r,n){var o,i,s,a,u;if(!e.schema||!(a=e.schema()))return e.prototype._orm_original_fns.set.apply(this,arguments);h.isString(t)?(o={})[t]=r:(o=t,n=r),u={},s={};for(t in o)r=o[t],(i=a.relation(t))?s[t]=i:u[t]=r;h.size(u)&&e.prototype._orm_original_fns.set.call(this,u,n);for(t in s)i=s[t],i.set(this,t,o[t],n);return this},get:function(t,r){var n,o,i;return e.schema&&(o=e.schema()),o&&(n=o.relation(t))?n.get(this,t,r):(i=e.prototype._orm_original_fns.get.call(this,t),r&&r(null,i),i)},toJSON:function(t){var r,n,o,i,s,u,l,c,f;if(null==t&&(t={}),e.schema&&(s=e.schema()),this._orm||(this._orm={}),this._orm.json>0)return this.id;for((l=this._orm).json||(l.json=0),this._orm.json++,r={},o=t.keys||this.whitelist||h.keys(this.attributes),c=0,f=o.length;f>c;c++)n=o[c],u=this.attributes[n],s&&(i=s.relation(n))?i.appendJSON(r,this):r[n]=a.isCollection(u)?h.map(u.models,function(e){return e?e.toJSON(t):null}):a.isModel(u)?u.toJSON(t):u;return--this._orm.json,r},save:function(t,r,n){var o,i,u,l=this;if(h.isFunction(i=arguments[arguments.length-1]))switch(arguments.length){case 1:o={},n=a.wrapOptions({},i);break;case 2:o=t,n=a.wrapOptions({},i);break;case 3:o=t,n=a.wrapOptions(r,i);break;case 4:(o={})[t]=r,n=a.wrapOptions(n,i)}else 0===arguments.length?(o={},n={}):null===t||h.isObject(t)?(o=t,n=r):(o={})[t]=r;return this.isLoaded()?(this._orm||(this._orm={}),this._orm.save>0?this.id?"function"==typeof n.success?n.success(this,{},n):void 0:"function"==typeof n.error?n.error(this,new Error("Model is in a save loop: "+e.model_name)):void 0:((u=this._orm).save||(u.save=0),this._orm.save++,this.set(o,n),o={},a.presaveBelongsToRelationships(this,function(r){return r?"function"==typeof n.error?n.error(l,r):void 0:e.prototype._orm_original_fns.save.call(l,o,a.wrapOptions(n,function(r,n,o,i){var a,u,c,h,f;if(--l._orm.save,r)return"function"==typeof i.error?i.error(l,o,i):void 0;if(a=new s(1),e.schema){c=e.schema(),f=c.relations,h=function(e){return a.defer(function(t){return e.save(l,t)})};for(t in f)u=f[t],h(u)}return a.await(function(t){var r;return t?"function"==typeof i.error?i.error(l,Error("Failed to save relations. "+t,i)):void 0:((r=e.cache)&&r.set(l.id,l),"function"==typeof i.success?i.success(l,o,i):void 0)})}))}))):"function"==typeof n.error?n.error(this,new Error("An unloaded model is trying to be saved: "+e.model_name)):void 0},destroy:function(t){var r,n,o,i,s=this;if(h.isFunction(n=arguments[arguments.length-1]))switch(arguments.length){case 1:t=a.wrapOptions({},n);break;case 2:t=a.wrapOptions(t,n)}if((r=this.cache())&&r.destroy(this.id),!e.schema||!(o=e.schema()))return e.prototype._orm_original_fns.destroy.call(this,t);if(this._orm||(this._orm={}),this._orm.destroy>0)throw new Error("Model is in a destroy loop: "+e.model_name);return(i=this._orm).destroy||(i.destroy=0),this._orm.destroy++,e.prototype._orm_original_fns.destroy.call(this,a.wrapOptions(t,function(e,t,r,n){return--s._orm.destroy,e?"function"==typeof n.error?n.error(s,r,n):void 0:s.patchRemove(function(e){return e?"function"==typeof n.error?n.error(s,new Error("Failed to destroy relations. "+e,n)):void 0:"function"==typeof n.success?n.success(s,r,n):void 0})}))},clone:function(t){var r,n,o,i,s,u,l,c,p,d,y,_;if(!e.schema)return e.prototype._orm_original_fns.clone.apply(this,arguments);if(t||(t={}),t._cache||(t._cache={}),r=(l=t._cache)[y=this.modelName()]||(l[y]={}),this._orm||(this._orm={}),this._orm.clone>0)return this.id?r[this.id]:e.prototype._orm_original_fns.clone.apply(this,arguments);for((c=this._orm).clone||(c.clone=0),this._orm.clone++,this.id?(n=r[this.id])||(r[this.id]=n=new this.constructor):n=new this.constructor,this.attributes.id&&(n.id=this.attributes.id),i=t.keys||h.keys(this.attributes),p=0,d=i.length;d>p;p++)o=i[p],u=this.attributes[o],a.isCollection(u)?((null!=(_=n.attributes[o])?_.values:void 0)||(n.attributes[o]=new u.constructor),n.attributes[o].models=function(){var e,r,n,o;for(n=u.models,o=[],e=0,r=n.length;r>e;e++)s=n[e],o.push(f(s,t));return o}()):n.attributes[o]=a.isModel(u)?f(u,t):u;return--this._orm.clone,n}},!e.prototype._orm_original_fns){e.prototype._orm_original_fns={},p=[];for(n in o)r=o[n],e.prototype._orm_original_fns[n]=e.prototype[n],p.push(e.prototype[n]=r);return p}}}),t.register("extensions/model_each",function(e,t,r){var n,o,i;i=t("underscore"),o=t("../queue"),n=null,r.exports=function(e,r,s,a){var u,l,c,h,f,p;return n||(n=t("../cursor")),c=r.$each||{},u=c.json?"toJSON":"toModels",f=0,h=n.parseQuery(i.omit(r,"$each")),i.defaults(h.cursor,{$offset:0,$sort:"id"}),l=h.cursor.$limit||1/0,c.fetch&&(h.cursor.$limit=c.fetch),(p=function(){var t;return t=e.cursor(h),t[u].call(t,function(e,t){var r,n,i,u,d;if(e||!t)return a(new Error("Failed to get models. Error: "+e));if(!t.length)return a(null,f);for(n=new o(c.threads),i=function(e){return n.defer(function(t){return s(e,t)})},u=0,d=t.length;d>u&&(r=t[u],!(f++>=l));u++)i(r);return n.await(function(e){return e?a(e):f>=l||t.length<h.cursor.$limit||!h.cursor.$limit?a(null,f):(h.cursor.$offset+=h.cursor.$limit,p())})})})()}}),t.register("extensions/model_interval",function(e,t,r){var n,o,i,s,a;a=t("underscore"),s=t("moment"),o=t("../queue"),i=t("../utils"),n=["milliseconds","seconds","minutes","hours","days","weeks","months","years"],r.exports=function(e,t,r,u){var l,c,h,f,p,d;if(f=t.$interval||{},!(c=f.key))throw new Error("missing option: key");if(!f.type)throw new Error("missing option: type");if(!a.contains(n,f.type))throw new Error("type is not recognized: "+f.type+", "+a.contains(n,f.type));return l=a.clone(f),l.range||(l.range={}),d=l.range,h=!1,p=new o(1),p.defer(function(r){var n;return(n=d.$gte||d.$gt)?(d.start=n,e.findOneNearestDate(n,{key:c,reverse:!0},t,function(e,t){return e?r(e):t?(l.first=t.get(c),r()):(h=!0,r())})):e.cursor(t).limit(1).sort(c).toModels(function(e,t){return e?r(e):t.length?(d.start=l.first=t[0].get(c),r()):(h=!0,r())})}),p.defer(function(r){var n;return h?r():(n=d.$lte||d.$lt)?(d.end=n,e.findOneNearestDate(n,{key:c},t,function(e,t){return e?r(e):t?(l.last=t.get(c),r()):(h=!0,r())})):e.cursor(t).limit(1).sort("-"+c).toModels(function(e,t){return e?r(e):t.length?(d.end=l.last=t[0].get(c),r()):(h=!0,r())})}),p.await(function(n){var o,p,y,_;if(n)return u(n);if(h)return u();if(_=d.start.getTime(),o=s.duration(a.isUndefined(f.length)?1:f.length,f.type).asMilliseconds(),!o)throw Error("length_ms is invalid: "+o+" for range: "+i.inspect(d));return t=a.omit(t,"$interval"),t.$sort=[c],p=0,l.index=0,(y=function(n){return n.isAfter(d.end)?u():(t[c]={$gte:n.toDate(),$lte:l.last},e.findOne(t,function(e,i){var a;return e?u(e):i?(a=i.get(c),l.index=Math.floor((a.getTime()-_)/o),n=s.utc(d.start).add({milliseconds:l.index*o}),l.start=n.toDate(),a=n.clone().add({milliseconds:o}),l.end=a.toDate(),t[c]={$gte:n.toDate(),$lt:a.toDate()},r(t,l,function(e){return e?u(e):y(a)})):u()}))})(s(d.start))})}}),t.register("extensions/model_stream",function(e,t,r){var n,o,i,s={}.hasOwnProperty,a=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};try{i=t("stream")}catch(u){o=u}return(null!=i?i.Readable:void 0)?(r.exports=n=function(e){function t(e,r){this.model_type=e,this.query=null!=r?r:{},t.__super__.constructor.call(this,{objectMode:!0})}return a(t,e),t.prototype._read=function(){var e,t=this;if(!this.ended&&!this.started)return this.started=!0,e=function(e){return t.ended=!0,e&&t.emit("error",e),t.push(null)},this.model_type.each(this.query,function(e,r){return t.push(e),r()},e)},t}(i.Readable),void 0):(r.exports=null,void 0)}),t.register("memory/cursor",function(e,t,r){var n,o,i,s,a,u,l,c,h,f,p,d={}.hasOwnProperty,y=function(e,t){function r(){this.constructor=e}for(var n in t)d.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},_=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};f=t("underscore"),h=t("moment"),c=t("inflection"),u=t("../queue"),l=t("../utils"),s=t("../json_utils"),n=t("../cursor"),o={$ne:function(e,t){return!f.isEqual(e,t)},$lt:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?h(e).isBefore(t):t>e},$lte:function(e,t){var r;if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?(r=h(e),r.isBefore(t)||r.isSame(t)):t>e||f.isEqual(e,t)},$gt:function(e,t){if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?h(e).isAfter(t):e>t},$gte:function(e,t){var r;if(f.isNull(t))throw Error("Cannot compare to null");return f.isDate(t)?(r=h(e),r.isAfter(t)||r.isSame(t)):e>t||f.isEqual(e,t)
}},i=f.keys(o),r.exports=a=function(e){function t(){return p=t.__super__.constructor.apply(this,arguments)}return y(t,e),t.prototype.queryToJSON=function(e){var r,n=this;return this.hasCursorQuery("$zero")?e(null,this.hasCursorQuery("$one")?null:[]):(r=this.hasCursorQuery("$exists"),this.buildFindQuery(function(o,i){var a,c,h;return o?e(o):(a=[],c=f.keys(i),h=new u(1),h.defer(function(e){var t,o,l,h,p,d,y,m,v,g,b,w,k,O,$;b=[{},{}],l=b[0],y=b[1];for(p in i)v=i[p],(null!=v?v.$in:void 0)&&(delete i[p],l[p]=v.$in),(null!=v?v.$nin:void 0)&&(delete i[p],y[p]=v.$nin);if(w=[f.size(l),f.size(y)],h=w[0],m=w[1],c.length||h||m){if(n._cursor.$ids){k=n.store;for(o in k)d=k[o],f.contains(n._cursor.$ids,o)&&f.isEqual(f.pick(d,c),i)&&a.push(s.deepClone(d));return e()}t=new u,O=n.store,g=function(e){return t.defer(function(t){var o,u;return o=f.keys(i),(u=function(l,h){return l?t(l):h?!o.length||r&&c.length!==o.length?(a.push(s.deepClone(e)),t()):n._valueIsMatch(i,o.pop(),e,u):t()})(null,!0)})};for(o in O)d=O[o],g(d);return t.await(function(t){return t?e(t):(h&&(a=f.filter(a,function(e){var t,r;for(p in l)if(t=l[p],r=e[p],_.call(t,r)>=0)return!0})),m&&(a=f.filter(a,function(e){var t,r;for(p in y)if(t=y[p],r=e[p],_.call(t,r)<0)return!0})),e())})}if(n._cursor.$ids){$=n.store;for(o in $)d=$[o],f.contains(n._cursor.$ids,o)&&a.push(s.deepClone(d))}else a=function(){var e,t;e=this.store,t=[];for(o in e)d=e[o],t.push(s.deepClone(d));return t}.call(n);return e()}),r||(h.defer(function(e){var t,r;return n._cursor.$sort&&(t=f.isArray(n._cursor.$sort)?n._cursor.$sort:[n._cursor.$sort],a.sort(function(e,r){return l.jsonFieldCompare(e,r,t)})),n._cursor.$offset&&(r=a.length-n._cursor.$offset,0>r&&(r=0),a=r?a.slice(n._cursor.$offset,n._cursor.$offset+r):[]),n._cursor.$one?a=a.length?[a[0]]:[]:n._cursor.$limit&&(a=a.splice(0,Math.min(a.length,n._cursor.$limit))),e()}),h.defer(function(e){return n.fetchIncludes(a,e)})),h.await(function(){var o;return n.hasCursorQuery("$count")?e(null,f.isArray(a)?a.length:a?1:0):r?e(null,f.isArray(a)?!!a.length:a):(a=n.selectResults(a),n.hasCursorQuery("$page")?(o=new t(n._find,f.extend(f.pick(n,["model_type","store"]))),o.count(function(t,r){return e(null,{offset:n._cursor.$offset||0,total_rows:r,rows:a})})):e(null,a))}),void 0)}))},t.prototype.buildFindQuery=function(e){var t,r,n,o,i,s,a,c,h,p,d=this;n=new u,t={},h=this._find,c=function(e,o,i){return n.defer(function(n){var s,a;return(a=d.model_type.relation(e))?a.join_table||"id"!==o?a.join_table||"belongsTo"===a.type?((s={$values:"id"})[o]=i,a.reverse_relation.model_type.cursor(s).toJSON(function(e,r){var o;return e?n(e):a.join_table?((o={})[a.reverse_relation.join_key]={$in:f.compact(r)},o.$values=a.foreign_key,a.join_table.cursor(o).toJSON(function(e,r){return e?n(e):(t.id={$in:f.compact(r)},n())})):(t[a.foreign_key]={$in:f.compact(r)},n())})):((s={})[o]=i,s.$values=a.foreign_key,a.reverse_model_type.cursor(s).toJSON(function(e,r){return e?n(e):(t.id={$in:f.compact(r)},n())})):(t[a.foreign_key]=i,n()):(t[r]=i,n())})};for(r in h)if(s=h[r],r.indexOf(".")<0){if(!(i=this.model_type.reverseRelation(r))){t[r]=s;continue}if(!i.embed&&!i.join_table){t[r]=s;continue}!function(e,r,o){return n.defer(function(n){var i;if(o.embed)throw Error("Embedded find is not yet supported. @_find: "+l.inspect(d._find));return(i={})[e]=r,i.$values=o.reverse_relation.join_key,o.join_table.cursor(i).toJSON(function(e,r){return e?n(e):(t.id={$in:r},n())})})}(r,s,i)}else p=r.split("."),o=p[0],a=p[1],this.model_type.relationIsEmbedded(o)?t[r]=s:c(o,a,s);return n.await(function(r){return e(r,t)})},t.prototype.fetchIncludes=function(e,t){var r,n,o,i,s,a,l,c,h,p;if(!this._cursor.$include)return t();for(o=new u(1),r=f.isArray(this._cursor.$include)?this._cursor.$include:[this._cursor.$include],l=0,h=r.length;h>l;l++)if(n=r[l],!this.model_type.relationIsEmbedded(n)){if(!(s=this.model_type.relation(n)))return t(new Error("Included relation '"+n+"' is not a relation"));for(a=function(e,t){return o.defer(function(r){return s.cursor(t,e).toJSON(function(n,o){return n?calback(n):(delete t[s.foriegn_key],t[e]=o,r())})})},c=0,p=e.length;p>c;c++)i=e[c],a(n,i)}return o.await(t)},t.prototype._valueIsMatch=function(e,t,r,n){var s,a,u;return s=t.split("."),a=this.model_type,(u=function(l,c){var h,p,d,y,_,m,v,g,b,w,k;if(l)return n(l);if(d=s.shift(),"id"===d&&(d=a.prototype.idAttribute),!s.length){for(v=!1,h=e[t],f.isArray(c)||(c=[c]),g=0,w=c.length;w>g;g++){if(r=c[g],y=r[d],f.isObject(h))for(b=0,k=i.length;k>b&&(_=i[b],!h.hasOwnProperty(_)||(v=!0,p=o[_](y,h[_])));b++);if(v){if(p)return n(null,p)}else if(p=f.isEqual(y,h))return n(null,p)}return n(null,!1)}return(m=a.relation(d))&&!m.embed?m.cursor(r,d).toJSON(u):u(null,r[d])})(null,r)},t}(n)}),t.register("memory/sync",function(e,t,r){var n,o,i,s,a,u,l,c,h,f,p,d;d=t("underscore"),n=t("backbone"),c=t("../queue"),s=t("./cursor"),f=t("../schema"),p=t("../utils"),i=t("../json_utils"),u=t("../cache/singletons").ModelCache,l=t("../cache/singletons").QueryCache,o=1e3,h={},a=function(){function e(e){var t;this.model_type=e,this.model_type.model_name=p.findOrGenerateModelName(this.model_type),this.schema=new f(this.model_type),this.store=this.model_type.store=h[t=this.model_type.model_name]||(h[t]={})}return e.prototype.initialize=function(){return this.is_initialized?void 0:(this.is_initialized=!0,this.schema.initialize())},e.prototype.read=function(e,t){var r,n;return e.models?t.success(function(){var e,t;e=this.store,t=[];for(r in e)n=e[r],t.push(i.deepClone(n));return t}.call(this)):d.isUndefined(this.store[e.id])?t.error(new Error("Model not found with id: "+e.id)):t.success(i.deepClone(this.store[e.id]))},e.prototype.create=function(e,t){var r=this;return l.reset(this.model_type,function(n){var o,s;return n?"function"==typeof t.error?t.error(n):void 0:((o={})[r.model_type.prototype.idAttribute]=p.guid(),e.set(o),s=r.store[e.id]=e.toJSON(),t.success(i.deepClone(s)))})},e.prototype.update=function(e,t){var r=this;return l.reset(this.model_type,function(n){var o;return n?"function"==typeof t.error?t.error(n):void 0:(r.store[e.id]=o=e.toJSON(),t.success(i.deepClone(o)))})},e.prototype["delete"]=function(e,t){var r=this;return l.reset(this.model_type,function(n){return n?"function"==typeof t.error?t.error(n):void 0:r.store[e.id]?(delete r.store[e.id],t.success()):t.error(new Error("Model not found"))})},e.prototype.resetSchema=function(e,t){var r=this;return l.reset(this.model_type,function(e){return e?t(e):r.destroy({},t)})},e.prototype.cursor=function(e){return null==e&&(e={}),new s(e,d.pick(this,["model_type","store"]))},e.prototype.destroy=function(e,t){var r=this;return l.reset(this.model_type,function(n){return n?t(n):r.model_type.each(d.extend({$each:{limit:o,json:!0}},e),function(e,t){return p.patchRemoveByJSON(r.model_type,e,function(n){return n||delete r.store[e[r.model_type.prototype.idAttribute]],t(n)})},t)})},e}(),r.exports=function(e){var t,n,o;return p.isCollection(new e)?(t=p.configureCollectionModelType(e,r.exports),e.prototype.sync=t.prototype.sync):(n=new a(e),e.prototype.sync=o=function(e,t,o){return null==o&&(o={}),n.initialize(),"createSync"===e?r.exports.apply(null,Array.prototype.slice.call(arguments,1)):"sync"===e?n:"isRemote"===e?!1:"schema"===e?n.schema:"tableName"===e?void 0:n[e]?n[e].apply(n,Array.prototype.slice.call(arguments,1)):void 0},p.configureModelType(e),u.configureSync(e,o))}}),t.register("relations/many",function(e,t,r){var n,o,i,s,a,u,l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};n=t("backbone"),u=t("underscore"),a=t("inflection"),i=t("../queue"),s=t("../utils"),r.exports=o=function(e){function t(e,t,r){var o,i,s;this.model_type=e,this.key=t;for(t in r)i=r[t],this[t]=i;this.virtual_id_accessor||(this.virtual_id_accessor=""+a.singularize(this.key)+"_ids"),this.join_key||(this.join_key=this.foreign_key||a.foreign_key(this.model_type.model_name)),this.foreign_key||(this.foreign_key=a.foreign_key(this.as||this.model_type.model_name)),this.collection_type||(o=function(e){function t(){return s=t.__super__.constructor.apply(this,arguments)}return c(t,e),t.prototype.model=t.reverse_model_type,t}(n.Collection),this.collection_type=o)}return c(t,e),t.prototype.initialize=function(){var e;if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.");if("hasOne"===(null!=(e=this.reverse_relation)?e.type:void 0))throw new Error("The reverse of a hasMany relation should be `belongsTo`, not `hasOne` ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+").");return"hasMany"===this.reverse_relation.type?this.join_table=this.findOrGenerateJoinTable(this):void 0},t.prototype.initializeModel=function(e){return e.isLoadedExists(this.key)||e.setLoaded(this.key,!1),this._bindBacklinks(e)},t.prototype.releaseModel=function(e){return this._unbindBacklinks(e),delete e._orm},t.prototype.set=function(e,t,r){var n,o,i,a,l,c,h,f;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("Many.set: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(n=this._bindBacklinks(e),s.isCollection(r)&&(r=r.models),u.isUndefined(r)&&(r=[]),!u.isArray(r))throw new Error("HasMany.set: Unexpected type to set "+t+". Expecting array: "+s.inspect(r));if(s.orSet(e,"rel_dirty",{})[this.key]=!0,e.setLoaded(this.key,u.all(r,function(e){return s.dataId(e)!==e})),a=function(){var e,t,i;for(i=[],e=0,t=r.length;t>e;e++)o=r[e],i.push((c=n.get(s.dataId(o)))?s.updateModel(c,o):s.updateOrNew(o,this.reverse_model_type));return i}.call(this),e.setLoaded(this.key,u.all(a,function(e){return e.isLoaded()})),l=u.clone(n.models),n.reset(a),"belongsTo"===this.reverse_relation.type)for(i=u.pluck(a,"id"),h=0,f=l.length;f>h;h++)c=l[h],u.contains(i,c.id)||c.set(this.foreign_key,null);return this},t.prototype.get=function(e,t,r){var n,o,i,a,u=this;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("Many.get: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return n=this._ensureCollection(e),a=function(){var e,r,o,i,s;if(t===u.virtual_id_accessor){for(i=n.models,s=[],r=0,o=i.length;o>r;r++)e=i[r],s.push(e.id);return s}return n},!r||this.isVirtual()||this.manual_fetch||(o=e.isLoaded(this.key))||this.cursor(e,this.key).toJSON(function(t,o){var i,l,c,h,f,p,d,y,_;if(t)return r(t);for(e.setLoaded(u.key,!0),f=0,d=o.length;d>f;f++)l=o[f],(c=n.get(l[u.reverse_model_type.prototype.idAttribute]))?c.set(l):n.add(c=s.updateOrNew(l,u.reverse_model_type));if(i=u.reverse_model_type.cache)for(_=n.models,p=0,y=_.length;y>p;p++)c=_[p],i.set(c.id,c);return h=a(),r(null,h.models?h.models:h)}),i=a(),r&&(o||this.manual_fetch)&&r(null,i.models?i.models:i),i},t.prototype.save=function(e,t){var r;return this._hasChanged(e)?(delete s.orSet(e,"rel_dirty",{})[this.key],r=this._ensureCollection(e),this._saveRelated(e,u.clone(r.models),t)):t()},t.prototype.appendJSON=function(e,t){var r,n;if(!this.isVirtual())return r=this._ensureCollection(t),n=this.embed?this.key:this.virtual_id_accessor,this.embed?e[n]=r.toJSON():void 0},t.prototype.add=function(e,t){var r,n;return r=this._ensureCollection(e),n=r.get(t.id),n!==t?(n&&r.remove(n),this.reverse_model_type.cache&&t.id&&this.reverse_model_type.cache.set(t.id,t),r.add(t)):void 0},t.prototype.remove=function(e,t){var r,n;return r=this._ensureCollection(e),(n=r.get(t.id))?r.remove(n):void 0},t.prototype.patchAdd=function(e,t,r){var n,o,a,l,c,h,f,p,d,y,_,m,v,g=this;if(!e.id)return r(new Error("Many.patchAdd: model has null id for: "+this.key));if(!t)return r(new Error("Many.patchAdd: missing model for: "+this.key));if(u.isArray(t)||(t=[t]),n=this._ensureCollection(e),t=function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)o=t[e],i.push((p=n.get(s.dataId(o)))?s.updateModel(p,o):s.updateOrNew(o,this.reverse_model_type));return i}.call(this),f=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)c=t[e],n.push(s.dataId(c));return n}(),n.add(t),e.isLoaded(this.key))for(y=0,m=t.length;m>y;y++)if(c=t[y],!c.isLoaded()){e.setLoaded(this.key,!1);break}if(this.join_table){for(l=new i(1),d=function(t){return l.defer(function(r){var n,o;return t?(n=function(r){var n,o;return n={},n[g.foreign_key]=e.id,n[g.reverse_relation.foreign_key]=t,o=new g.join_table(n),o.save(r)},"hasMany"===g.reverse_relation.type?n(r):((o={})[g.reverse_relation.foreign_key]=t,g.join_table.find(o,function(t,o){return t?r(t):o?o[g.foreign_key]===e.id?r():(o[g.foreign_key]=e.id,s.modelJSONSave(o,g.join_table,r)):n(r)}))):r(new Error("Many.patchAdd: cannot add an new model. Please save first."))})},_=0,v=f.length;v>_;_++)h=f[_],d(h);return l.await(r)}return a={id:{$in:f}},this.reverse_model_type.cursor(a).toJSON(function(t,n){var o,a,u,c;for(l=new i(1),a=function(t){return l.defer(function(r){return t[g.reverse_relation.foreign_key]=e.id,s.modelJSONSave(t,g.reverse_model_type,r)})},u=0,c=n.length;c>u;u++)o=n[u],a(o);return l.await(r)})},t.prototype.patchRemove=function(e,t,r){var n,o,a,l,c,h,f,p,d,y,_,m,v,g,b,w,k=this;if(!e.id)return r(new Error("Many.patchRemove: model has null id for: "+this.key));if(2===arguments.length){if(r=t,!this.reverse_relation)return r();for(s.isModel(e)?(delete s.orSet(e,"rel_dirty",{})[this.key],o=this._ensureCollection(e),d=u.clone(o.models)):d=function(){var t,r,n,o;for(n=e[this.key]||[],o=[],t=0,r=n.length;r>t;t++)l=n[t],o.push(new this.reverse_model_type(l));return o}.call(this),y=0,v=d.length;v>y;y++)p=d[y],p.set(this.foreign_key,null),(n=p.cache())&&n.set(p.id,p);return this.join_table?((c={})[this.join_key]=e.id,this.join_table.destroy(c,r)):((c={})[this.reverse_relation.foreign_key]=e.id,this.reverse_model_type.cursor(c).toJSON(function(e,t){var n,o,a,u,l;if(e)return r(e);for(n=new i(1),a=function(e){return n.defer(function(t){return e[k.reverse_relation.foreign_key]=null,s.modelJSONSave(e,k.reverse_model_type,t)})},u=0,l=t.length;l>u;u++)o=t[u],a(o);return n.await(r)}),void 0)}if(this.isEmbedded())return r(new Error("Many.patchRemove: embedded relationships are not supported"));if(!t)return r(new Error("One.patchRemove: missing model for remove"));for(u.isArray(t)||(t=[t]),o=this._ensureCollection(e),_=0,g=t.length;g>_;_++)for(h=t[_],w=o.models,m=0,b=w.length;b>m;m++)if(a=w[m],s.dataIsSameModel(a,h)){o.remove(a);break}return f=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)h=t[e],n.push(s.dataId(h));return n}(),this.join_table?(c={},c[this.join_key]=e.id,c[this.reverse_relation.join_key]={$in:f},this.join_table.destroy(c,r)):(c={},c[this.reverse_relation.foreign_key]=e.id,c.id={$in:f},this.reverse_model_type.cursor(c).toJSON(function(e,t){var n,o,a,u,l;if(e)return r(e);for(n=new i(1),a=function(e){return n.defer(function(t){return e[k.reverse_relation.foreign_key]=null,s.modelJSONSave(e,k.reverse_model_type,t)})},u=0,l=t.length;l>u;u++)o=t[u],a(o);return n.await(r)}))},t.prototype.cursor=function(e,t,r){var n;return n=s.isModel(e)?e.attributes:e,(r=u.clone(r||{}))[this.join_table?this.join_key:this.reverse_relation.foreign_key]=n[this.model_type.prototype.idAttribute],t===this.virtual_id_accessor&&(r.$values||(r.$values=[])).push("id"),this.reverse_model_type.cursor(r)},t.prototype._bindBacklinks=function(e){var t,r,n,o,i,a,l=this;if((t=e.attributes[this.key])instanceof this.collection_type)return t;if(t=e.attributes[this.key]=new this.collection_type,!this.reverse_relation)return t;for(r=s.set(t,"events",{}),r.add=function(t){var r,n;return l.reverse_relation.add?l.reverse_relation.add(t,e):(r=t.get(l.reverse_relation.key),n=e.id&&s.dataId(r)===e.id,!n||n&&!r.isLoaded()?t.set(l.reverse_relation.key,e):void 0)},r.remove=function(t){var r;return l.reverse_relation.remove?l.reverse_relation.remove(t,e):(r=t.get(l.reverse_relation.key),s.dataId(r)===e.id?t.set(l.reverse_relation.key,null):void 0)},r.reset=function(e,t){var n,o,i,s,a,l,c,h,f,p,d;if(i=e.models,s=t.previousModels||[],o=u.groupBy(s,function(e){return u.find(i,function(t){return t.id===e.id})?"kept":"removed"}),n=o.kept?u.select(i,function(e){return!u.find(o.kept,function(t){return t.id===e.id})}):i,o.removed)for(p=o.removed,l=0,h=p.length;h>l;l++)a=p[l],r.remove(a);for(d=[],c=0,f=n.length;f>c;c++)a=n[c],d.push(r.add(a));return d},a=["add","remove","reset"],o=0,i=a.length;i>o;o++)n=a[o],t.on(n,r[n]);return t},t.prototype._unbindBacklinks=function(e){var t,r,n,o,i,a;if(r=s.get(e,"events"))for(s.unset(e,"events"),t=e.attributes[this.key],t.models.splice(),r=u.clone(),a=["add","remove","reset"],o=0,i=a.length;i>o;o++)n=a[o],t.off(n,r[n]),r[n]=null},t.prototype._ensureCollection=function(e){return this._bindBacklinks(e)},t.prototype._hasChanged=function(e){return!!s.orSet(e,"rel_dirty",{})[this.key]||e.hasChanged(this.key)},t}(t("./relation"))}),t.register("relations/one",function(e,t,r){var n,o,i,s,a,u,l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};u=t("underscore"),n=t("backbone"),a=t("inflection"),i=t("../queue"),s=t("../utils"),r.exports=o=function(e){function t(e,t,r){var n;this.model_type=e,this.key=t;for(t in r)n=r[t],this[t]=n;this.virtual_id_accessor||(this.virtual_id_accessor=""+this.key+"_id"),this.join_key||(this.join_key=this.foreign_key||a.foreign_key(this.model_type.model_name)),this.foreign_key||(this.foreign_key=a.foreign_key("belongsTo"===this.type?this.key:this.as||this.model_type.model_name))}return c(t,e),t.prototype.initialize=function(){if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.")},t.prototype.initializeModel=function(e){return e.isLoadedExists(this.key)||e.setLoaded(this.key,this.isEmbedded()),this._bindBacklinks(e)},t.prototype.releaseModel=function(e){return this._unbindBacklinks(e),delete e._orm},t.prototype.set=function(e,t,r,o){var i,a,l,c,h;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("One.set: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(u.isArray(r))throw new Error("One.set: cannot set an array for attribute "+this.key+" on "+this.model_type.model_name);return u.isUndefined(r)&&(r=null),r===(h=e.get(this.key))?this:(i=s.isModel(r),l=s.dataId(r),c=s.dataId(h),s.orSet(e,"rel_dirty",{})[this.key]=!0,c===l&&e.isLoaded(this.key)||(i&&r.isLoaded()&&l!==r?e.setLoaded(this.key,!0):e.setLoaded(this.key,u.isNull(r))),r&&!i&&((a=c===l)||(r=s.updateOrNew(r,this.reverse_model_type))),a||n.Model.prototype.set.call(e,this.key,r,o),a?s.updateModel(h,r):null!==r||!this.reverse_relation||"hasOne"!==this.reverse_relation.type&&"belongsTo"!==this.reverse_relation.type||this.embed||this.reverse_relation.embed||e.isLoaded(this.key)&&h&&h.get(this.reverse_relation.key)===e&&h.set(this.reverse_relation.key,null),this)},t.prototype.get=function(e,t,r){var n,o,i,a=this;if(t!==this.key&&t!==this.virtual_id_accessor&&t!==this.foreign_key)throw new Error("One.get: Unexpected key "+t+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return i=function(){var r;return(r=e.attributes[a.key])?t===a.virtual_id_accessor?r.id:r:null},!r||this.isVirtual()||this.manual_fetch||(n=e.isLoaded(this.key))||this.cursor(e,t).toJSON(function(n,o){var u,l;return n?r(n):(t!==a.virtual_id_accessor&&e.setLoaded(a.key,!0),u=e.get(a.key),u&&u.id===(null!=o?o.id:void 0)?s.updateModel(u,o):(l=o?s.updateOrNew(o,a.reverse_model_type):null,e.set(a.key,l)),r(null,i()))}),o=i(),r&&(n||this.manual_fetch)&&r(null,o),o},t.prototype.save=function(e,t){var r;return this._hasChanged(e)?(delete s.orSet(e,"rel_dirty",{})[this.key],(r=e.attributes[this.key])?this._saveRelated(e,[r],t):t()):t()},t.prototype.patchAdd=function(e,t,r){var n,o,a=this;return e.id?t?u.isArray(t)?r(new Error("One.patchAdd: should be provided with one model only for key: "+this.key)):(o=s.dataId(t))?(this.reverse_model_type.cache&&!s.isModel(t)&&(n=this.reverse_model_type.cache.get(o))&&(s.updateModel(n,t),t=n),e.set(this.key,t),"belongsTo"===this.type?this.model_type.cursor({id:e.id,$one:!0}).toJSON(function(t,n){return t?r(t):n?(n[a.foreign_key]=o,e.save(n,r)):r(new Error("Failed to fetch model with id: "+e.id))}):this.cursor(e,this.key).toJSON(function(n,u){var l;return n?r(n):u&&o===u[a.reverse_model_type.prototype.idAttribute]?r():(l=new i(1),u&&l.defer(function(t){return a.patchRemove(e,u,t)}),l.defer(function(r){var n,i;return s.isModel(t)?t.isLoaded()&&(i=t.toJSON()):o!==t&&(i=t),i?(i[a.reverse_relation.foreign_key]=e.id,s.modelJSONSave(i,a.reverse_model_type,r)):(n={$one:!0},n.id=o,a.reverse_model_type.cursor(n).toJSON(function(t,n){return t?r(t):n?(n[a.reverse_relation.foreign_key]=e.id,s.modelJSONSave(n,a.reverse_model_type,r)):r()}))}),l.await(r))})):r(new Error("One.patchAdd: cannot add a new model. Please save first.")):r(new Error("One.patchAdd: missing model for: "+this.key)):r(new Error("One.patchAdd: model has null id for: "+this.key))},t.prototype.patchRemove=function(e,t,r){var n,o,i,a,l,c=this;if(2===arguments.length&&(r=t,t=void 0),!e.id)return r(new Error("One.patchRemove: model has null id for: "+this.key));if(2===arguments.length)return this.reverse_relation?(s.isModel(e)&&delete s.orSet(e,"rel_dirty",{})[this.key],this.cursor(e,this.key).toJSON(function(e,t){return e?r(e):t?(t[c.reverse_relation.foreign_key]=null,s.modelJSONSave(t,c.reverse_model_type,r)):r()}),void 0):r();if(this.isEmbedded())return r(new Error("One.patchRemove: embedded relationships are not supported"));if(!t)return r(new Error("One.patchRemove: missing model for remove"));if(u.isArray(t)||(t=[t]),n=e.get(this.key))for(a=0,l=t.length;l>a;a++)if(o=t[a],s.dataIsSameModel(n,o)){e.set(this.key,null);break}return i=function(){var e,r,n;for(n=[],e=0,r=t.length;r>e;e++)o=t[e],n.push(s.dataId(o));return n}(),"belongsTo"===this.type?this.model_type.cursor({id:e.id,$one:!0}).toJSON(function(e,t){return e?r(e):t?u.contains(i,t[c.foreign_key])?(t[c.foreign_key]=null,s.modelJSONSave(t,c.model_type,r)):r():r()}):this.cursor(e,this.key).toJSON(function(e,t){return e?r(e):t?u.contains(i,t[c.reverse_model_type.prototype.idAttribute])?(t[c.reverse_relation.foreign_key]=null,s.modelJSONSave(t,c.reverse_model_type,r)):r():r()})},t.prototype.appendJSON=function(e,t){var r,n;if(!this.isVirtual())return r=this.embed?this.key:this.foreign_key,(n=t.attributes[this.key])?this.embed?e[r]=n.toJSON():"belongsTo"===this.type?e[r]=n.id:void 0:((this.embed||"belongsTo"===this.type)&&(e[r]=null),void 0)},t.prototype.cursor=function(e,t,r){var n;if(r=u.extend({$one:!0},r||{}),s.isModel(e))if("belongsTo"===this.type)(r.id=null!=(n=e.attributes[this.key])?n.id:void 0)||(r.$zero=!0,delete r.id);else{if(!e.id)throw new Error("Cannot create cursor for non-loaded model");r[this.reverse_relation.foreign_key]=e.id}else if("belongsTo"===this.type)(r.id=e[this.foreign_key])||(r.$zero=!0,delete r.id);else{if(!e.id)throw new Error("Cannot create cursor for non-loaded model");r[this.reverse_relation.foreign_key]=e.id}return t===this.virtual_id_accessor&&(r.$values=["id"]),this.reverse_model_type.cursor(r)},t.prototype._bindBacklinks=function(e){var t,r,n,o=this;if(this.reverse_relation)return t=s.set(e,"events",{}),n=function(t){return o.reverse_relation.add?o.reverse_relation.add(t,e):t.set(o.reverse_relation.key,e)},t.change=function(e){var t,r,i;return i=e.get(o.key),r=e.previous(o.key),s.dataId(i)!==s.dataId(r)?(r&&o.reverse_relation&&"belongsTo"!==o.reverse_relation.type&&(o.reverse_relation.remove?o.isVirtual()&&i||o.reverse_relation.remove(r,e):(t=r.get(o.reverse_relation.key),s.dataId(t)===e.id&&r.set(o.reverse_relation.key,null))),i?n(i):void 0):void 0},e.on("change:"+this.key,t.change),(r=e.get(this.key))?n(r):e.attributes[this.key]=null,e},t.prototype._unbindBacklinks=function(e){var t;(t=s.get(e,"events"))&&(s.unset(e,"events"),e.attributes[this.key]=null,e.off("change:"+this.key,t.change),t.change=null)},t.prototype._hasChanged=function(e){return!!s.orSet(e,"rel_dirty",{})[this.key]||e.hasChanged(this.key)},t}(t("./relation"))}),t.register("relations/relation",function(e,t,r){var n,o,i,s,a,u;u=t("underscore"),n=t("backbone"),a=t("inflection"),o=t("../queue"),s=t("../utils"),r.exports=i=function(){function e(){}return e.prototype.isEmbedded=function(){return!!(this.embed||this.reverse_relation&&this.reverse_relation.embed)},e.prototype.isVirtual=function(){return!!(this.virtual||this.reverse_relation&&this.reverse_relation.virtual)},e.prototype.findOrGenerateJoinTable=function(){var e;return(e=this.join_table||this.reverse_relation.join_table)?e:this.model_type.schema().generateJoinTable(this)},e.prototype._findOrGenerateReverseRelation=function(){var e,t,r,n;return t=this.model_type,r=this.reverse_model_type,u.isFunction(r.schema)||(r.sync=t.createSync(r)),e=this.as||a.underscore(t.model_name),n=r.relation(e),n||(n=r.relation(a.singularize(e))),n||(n=r.relation(a.pluralize(e))),n||"belongsTo"===this.type||(n=r.schema().generateBelongsTo(t)),n&&!n.reverse_relation&&(n.reverse_relation=this),n},e.prototype._saveRelated=function(e,t,r){var n=this;return this.embed||!this.reverse_relation||"belongsTo"===this.type?r():this.isVirtual()?r():this.cursor(e,this.key).toJSON(function(i,a){var l,c,h,f,p,d,y,_,m,v,g,b,w,k,O,$,S,j,M;if(i)return r(i);if(u.isArray(a)||(a=a?[a]:[]),f=new o(1),d=u.pluck(t,"id"),h=u.groupBy(a,function(e){return u.contains(d,e.id)?"kept":"removed"}),c=h.kept?u.difference(d,function(){var e,t,r,n;for(r=h.kept,n=[],e=0,t=r.length;t>e;e++)m=r[e],n.push(m.id);return n}()):d,h.removed)if(n.join_table)f.defer(function(e){var t,r;return t={},t[n.reverse_relation.join_key]={$in:function(){var e,t,n,o;for(n=h.removed,o=[],e=0,t=n.length;t>e;e++)r=n[e],o.push(r[this.reverse_model_type.prototype.idAttribute]);return o}.call(n)},n.join_table.destroy(t,e)});else for(M=h.removed,v=function(e){return f.defer(function(t){return e[n.reverse_relation.foreign_key]=null,s.modelJSONSave(e,n.reverse_model_type,t)})},w=0,$=M.length;$>w;w++)y=M[w],v(y);if(c.length)if(n.join_table)for(g=function(t){return f.defer(function(r){var o,i;return o={},o[n.foreign_key]=e.id,o[n.reverse_relation.foreign_key]=t,i=new n.join_table(o),i.save(r)})},k=0,S=c.length;S>k;k++)p=c[k],g(p);else for(b=function(e){return f.defer(function(t){return e.save(function(e,r){var o;return!e&&(o=n.reverse_model_type.cache)&&o.set(r.id,r),t(e)})})},O=0,j=c.length;j>O;O++)l=c[O],_=u.find(t,function(e){return e.id===l}),n.reverse_relation._hasChanged(_)&&b(_);return f.await(r)})},e}()}),"object"==typeof exports?module.exports=t("index"):"function"==typeof define&&define.amd?define(["require","underscore","backbone","moment","inflection"],function(){return t("index")}):this.BackboneORM=t("index")}).call(this);