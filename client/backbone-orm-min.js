/*
  backbone-orm.js 0.0.1
  Copyright (c) 2013 Vidigami - https://github.com/vidigami/backbone-orm
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Backbone.js and Underscore.js.
*/
(function(){if(function(){"use strict";var a="undefined"!=typeof window?window:global;if("function"!=typeof a.require){var b={},c={},d=function(a,b){return{}.hasOwnProperty.call(a,b)},e=function(a,b){var c,d,e=[];c=/^\.\.?(\/|$)/.test(b)?[a,b].join("/").split("/"):b.split("/");for(var f=0,g=c.length;g>f;f++)d=c[f],".."===d?e.pop():"."!==d&&""!==d&&e.push(d);return e.join("/")},f=function(a){return a.split("/").slice(0,-1).join("/")},g=function(b){return function(c){var d=f(b),g=e(d,c);return a.require(g,b)}},h=function(a,b){var d={id:a,exports:{}};return c[a]=d,b(d.exports,g(a),d),d.exports},i=function(a,f){var g=e(a,".");if(null==f&&(f="/"),d(c,g))return c[g].exports;if(d(b,g))return h(g,b[g]);var i=e(g,"./index");if(d(c,i))return c[i].exports;if(d(b,i))return h(i,b[i]);throw new Error('Cannot find module "'+a+'" from "'+f+'"')},j=function(a,c){if("object"==typeof a)for(var e in a)d(a,e)&&(b[e]=a[e]);else b[a]=c},k=function(){var a=[];for(var c in b)d(b,c)&&a.push(c);return a};a.require=i,a.require.define=j,a.require.register=j,a.require.list=k,a.require.brunch=!0}}(),require.register("backbone-orm/node/browserify/_shims",function(a){function b(a){return"[object Array]"===h.call(a)}function c(a,b){var c;if(null===a)c={__proto__:null};else{if("object"!=typeof a)throw new TypeError("typeof prototype["+typeof a+"] != 'object'");var d=function(){};d.prototype=a,c=new d,c.__proto__=a}return"undefined"!=typeof b&&Object.defineProperties&&Object.defineProperties(c,b),c}function d(a){return"object"!=typeof a&&"function"!=typeof a||null===a}function e(a){if(d(a))throw new TypeError("Object.keys called on a non-object");var b=[];for(var c in a)i.call(a,c)&&b.push(c);return b}function f(b){if(d(b))throw new TypeError("Object.getOwnPropertyNames called on a non-object");var c=e(b);return a.isArray(b)&&-1===a.indexOf(b,"length")&&c.push("length"),c}function g(a,b){return{value:a[b]}}var h=Object.prototype.toString,i=Object.prototype.hasOwnProperty;a.isArray="function"==typeof Array.isArray?Array.isArray:b,a.indexOf=function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1},a.filter=function(a,b){if(a.filter)return a.filter(b);for(var c=[],d=0;d<a.length;d++)b(a[d],d,a)&&c.push(a[d]);return c},a.forEach=function(a,b,c){if(a.forEach)return a.forEach(b,c);for(var d=0;d<a.length;d++)b.call(c,a[d],d,a)},a.map=function(a,b){if(a.map)return a.map(b);for(var c=new Array(a.length),d=0;d<a.length;d++)c[d]=b(a[d],d,a);return c},a.reduce=function(a,b,c){if(a.reduce)return a.reduce(b,c);var d,e=!1;2<arguments.length&&(d=c,e=!0);for(var f=0,g=a.length;g>f;++f)a.hasOwnProperty(f)&&(e?d=b(d,a[f],f,a):(d=a[f],e=!0));return d},a.substr="b"!=="ab".substr(-1)?function(a,b,c){return 0>b&&(b=a.length+b),a.substr(b,c)}:function(a,b,c){return a.substr(b,c)},a.trim=function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},a.bind=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(b.bind)return b.bind.apply(b,a);var c=a.shift();return function(){b.apply(c,a.concat([Array.prototype.slice.call(arguments)]))}},a.create="function"==typeof Object.create?Object.create:c;var j="function"==typeof Object.keys?Object.keys:e,k="function"==typeof Object.getOwnPropertyNames?Object.getOwnPropertyNames:f;if((new Error).hasOwnProperty("description")){var l=function(b,c){return"[object Error]"===h.call(b)&&(c=a.filter(c,function(a){return"description"!==a&&"number"!==a&&"message"!==a})),c};a.keys=function(a){return l(a,j(a))},a.getOwnPropertyNames=function(a){return l(a,k(a))}}else a.keys=j,a.getOwnPropertyNames=k;if("function"==typeof Object.getOwnPropertyDescriptor)try{Object.getOwnPropertyDescriptor({a:1},"a"),a.getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor}catch(m){a.getOwnPropertyDescriptor=function(a,b){try{return Object.getOwnPropertyDescriptor(a,b)}catch(c){return g(a,b)}}}else a.getOwnPropertyDescriptor=g}),require.register("backbone-orm/node/lru-cache",function(a,b,c){!function(){function a(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function b(){return 1}function d(c){function f(a,b){var c=p[a];return c&&(n&&Date.now()-c.now>n?(j(c),m||(c=void 0)):b&&g(c),c&&(c=c.value)),c}function g(a){i(a),a.lu=r++,q[a.lu]=a}function h(){for(;r>s&&t>k;)j(q[s])}function i(a){for(delete q[a.lu];r>s&&!q[s];)s++}function j(a){a&&(o&&o(a.key,a.value),t-=a.length,u--,delete p[a.key],i(a))}if(!(this instanceof d))return new d(c);var k;"number"==typeof c&&(k=c,c={max:k}),c||(c={}),k=c.max;var l=c.length||b;"function"!=typeof l&&(l=b),(!k||"number"!=typeof k||0>=k)&&(k=1/0);var m=c.stale||!1,n=c.maxAge||null,o=c.dispose,p=Object.create(null),q=Object.create(null),r=0,s=0,t=0,u=0;Object.defineProperty(this,"max",{set:function(a){(!a||"number"!=typeof a||0>=a)&&(a=1/0),k=a,t>k&&h()},get:function(){return k},enumerable:!0}),Object.defineProperty(this,"lengthCalculator",{set:function(a){if("function"!=typeof a){l=b,t=u;for(var c in p)p[c].length=1}else{l=a,t=0;for(var c in p)p[c].length=l(p[c].value),t+=p[c].length}t>k&&h()},get:function(){return l},enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return t},enumerable:!0}),Object.defineProperty(this,"itemCount",{get:function(){return u},enumerable:!0}),this.forEach=function(a,b){b=b||this;for(var c=0,d=r-1;d>=0&&u>c;d--)if(q[d]){c++;var e=q[d];n&&Date.now()-e.now>n&&(j(e),m||(e=void 0)),e&&a.call(b,e.value,e.key,this)}},this.keys=function(){for(var a=new Array(u),b=0,c=r-1;c>=0&&u>b;c--)if(q[c]){var d=q[c];a[b++]=d.key}return a},this.values=function(){for(var a=new Array(u),b=0,c=r-1;c>=0&&u>b;c--)if(q[c]){var d=q[c];a[b++]=d.value}return a},this.reset=function(){if(o)for(var a in p)o(a,p[a].value);p={},q={},s=0,r=0,t=0,u=0},this.dump=function(){return p},this.dumpLru=function(){return q},this.set=function(b,c){if(a(p,b))return o&&o(b,p[b].value),n&&(p[b].now=Date.now()),p[b].value=c,this.get(b),!0;var d=l(c),f=n?Date.now():0,g=new e(b,c,r++,d,f);return g.length>k?(o&&o(b,c),!1):(t+=g.length,q[g.lu]=p[b]=g,u++,t>k&&h(),!0)},this.has=function(b){if(!a(p,b))return!1;var c=p[b];return n&&Date.now()-c.now>n?!1:!0},this.get=function(a){return f(a,!0)},this.peek=function(a){return f(a,!1)},this.del=function(a){j(p[a])}}function e(a,b,c,d,e){this.key=a,this.value=b,this.lu=c,this.length=d,this.now=e}"object"==typeof c&&c.exports?c.exports=d:this.LRUCache=d}()}),require.register("backbone-orm/node/querystring",function(a,b){function c(a,b){return Object.prototype.hasOwnProperty.call(a,b)}var d=a,e=b("./util"),f=b("./browserify/_shims");d.unescape=function(a){return decodeURIComponent(a)},d.escape=function(a){return encodeURIComponent(a)};var g=function(a){return e.isString(a)?a:e.isBoolean(a)?a?"true":"false":e.isNumber(a)?isFinite(a)?a:"":""};d.stringify=d.encode=function(a,b,c,h){return b=b||"&",c=c||"=",e.isNull(a)&&(a=void 0),e.isObject(a)?f.map(f.keys(a),function(h){var i=d.escape(g(h))+c;return e.isArray(a[h])?f.map(a[h],function(a){return i+d.escape(g(a))}).join(b):i+d.escape(g(a[h]))}).join(b):h?d.escape(g(h))+c+d.escape(g(a)):""},d.parse=d.decode=function(a,b,f,g){b=b||"&",f=f||"=";var h={};if(!e.isString(a)||0===a.length)return h;var i=/\+/g;a=a.split(b);var j=1e3;g&&e.isNumber(g.maxKeys)&&(j=g.maxKeys);var k=a.length;j>0&&k>j&&(k=j);for(var l=0;k>l;++l){var m,n,o,p,q=a[l].replace(i,"%20"),r=q.indexOf(f);r>=0?(m=q.substr(0,r),n=q.substr(r+1)):(m=q,n="");try{o=decodeURIComponent(m),p=decodeURIComponent(n)}catch(s){o=d.unescape(m,!0),p=d.unescape(n,!0)}c(h,o)?e.isArray(h[o])?h[o].push(p):h[o]=[h[o],p]:h[o]=p}return h}}),require.register("backbone-orm/node/url",function(a,b){function c(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function d(a,b,d){if(a&&i.isObject(a)&&a instanceof c)return a;var e=new c;return e.parse(a,b,d),e}function e(a){return i.isString(a)&&(a=d(a)),a instanceof c?a.format():c.prototype.format.call(a)}function f(a,b){return d(a,!1,!0).resolve(b)}function g(a,b){return a?d(a,!1,!0).resolveObject(b):b}var h={encode:function(a){return a}},i=b("./util"),j=b("./browserify/_shims");a.parse=d,a.resolve=f,a.resolveObject=g,a.format=e,a.Url=c;var k=/^([a-z0-9.+-]+:)/i,l=/:[0-9]*$/,m=["<",">",'"',"`"," ","\r","\n","	"],n=["{","}","|","\\","^","`"].concat(m),o=["'"].concat(n),p=["%","/","?",";","#"].concat(o),q=["/","?","#"],r=255,s=/^[a-z0-9A-Z_-]{0,63}$/,t=/^([a-z0-9A-Z_-]{0,63})(.*)$/,u={javascript:!0,"javascript:":!0},v={javascript:!0,"javascript:":!0},w={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},x=b("./querystring");c.prototype.parse=function(a,b,c){if(!i.isString(a))throw new TypeError("Parameter 'url' must be a string, not "+typeof a);var d=a;d=j.trim(d);var e=k.exec(d);if(e){e=e[0];var f=e.toLowerCase();this.protocol=f,d=d.substr(e.length)}if(c||e||d.match(/^\/\/[^@\/]+@[^@\/]+/)){var g="//"===d.substr(0,2);!g||e&&v[e]||(d=d.substr(2),this.slashes=!0)}if(!v[e]&&(g||e&&!w[e])){for(var l=-1,m=0;m<q.length;m++){var n=d.indexOf(q[m]);-1!==n&&(-1===l||l>n)&&(l=n)}var y,z;z=-1===l?d.lastIndexOf("@"):d.lastIndexOf("@",l),-1!==z&&(y=d.slice(0,z),d=d.slice(z+1),this.auth=decodeURIComponent(y)),l=-1;for(var m=0;m<p.length;m++){var n=d.indexOf(p[m]);-1!==n&&(-1===l||l>n)&&(l=n)}-1===l&&(l=d.length),this.host=d.slice(0,l),d=d.slice(l),this.parseHost(),this.hostname=this.hostname||"";var A="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!A)for(var B=this.hostname.split(/\./),m=0,C=B.length;C>m;m++){var D=B[m];if(D&&!D.match(s)){for(var E="",F=0,G=D.length;G>F;F++)E+=D.charCodeAt(F)>127?"x":D[F];if(!E.match(s)){var H=B.slice(0,m),I=B.slice(m+1),J=D.match(t);J&&(H.push(J[1]),I.unshift(J[2])),I.length&&(d="/"+I.join(".")+d),this.hostname=H.join(".");break}}}if(this.hostname=this.hostname.length>r?"":this.hostname.toLowerCase(),!A){for(var K=this.hostname.split("."),L=[],m=0;m<K.length;++m){var M=K[m];L.push(M.match(/[^A-Za-z0-9_-]/)?"xn--"+h.encode(M):M)}this.hostname=L.join(".")}var N=this.port?":"+this.port:"",O=this.hostname||"";this.host=O+N,this.href+=this.host,A&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==d[0]&&(d="/"+d))}if(!u[f])for(var m=0,C=o.length;C>m;m++){var P=o[m],Q=encodeURIComponent(P);Q===P&&(Q=escape(P)),d=d.split(P).join(Q)}var R=d.indexOf("#");-1!==R&&(this.hash=d.substr(R),d=d.slice(0,R));var S=d.indexOf("?");if(-1!==S?(this.search=d.substr(S),this.query=d.substr(S+1),b&&(this.query=x.parse(this.query)),d=d.slice(0,S)):b&&(this.search="",this.query={}),d&&(this.pathname=d),w[f]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var N=this.pathname||"",M=this.search||"";this.path=N+M}return this.href=this.format(),this},c.prototype.format=function(){var a=this.auth||"";a&&(a=encodeURIComponent(a),a=a.replace(/%3A/i,":"),a+="@");var b=this.protocol||"",c=this.pathname||"",d=this.hash||"",e=!1,f="";this.host?e=a+this.host:this.hostname&&(e=a+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(e+=":"+this.port)),this.query&&i.isObject(this.query)&&j.keys(this.query).length&&(f=x.stringify(this.query));var g=this.search||f&&"?"+f||"";return b&&":"!==j.substr(b,-1)&&(b+=":"),this.slashes||(!b||w[b])&&e!==!1?(e="//"+(e||""),c&&"/"!==c.charAt(0)&&(c="/"+c)):e||(e=""),d&&"#"!==d.charAt(0)&&(d="#"+d),g&&"?"!==g.charAt(0)&&(g="?"+g),c=c.replace(/[?#]/g,function(a){return encodeURIComponent(a)}),g=g.replace("#","%23"),b+e+c+g+d},c.prototype.resolve=function(a){return this.resolveObject(d(a,!1,!0)).format()},c.prototype.resolveObject=function(a){if(i.isString(a)){var b=new c;b.parse(a,!1,!0),a=b}var d=new c;if(j.forEach(j.keys(this),function(a){d[a]=this[a]},this),d.hash=a.hash,""===a.href)return d.href=d.format(),d;if(a.slashes&&!a.protocol)return j.forEach(j.keys(a),function(b){"protocol"!==b&&(d[b]=a[b])}),w[d.protocol]&&d.hostname&&!d.pathname&&(d.path=d.pathname="/"),d.href=d.format(),d;if(a.protocol&&a.protocol!==d.protocol){if(!w[a.protocol])return j.forEach(j.keys(a),function(b){d[b]=a[b]}),d.href=d.format(),d;if(d.protocol=a.protocol,a.host||v[a.protocol])d.pathname=a.pathname;else{for(var e=(a.pathname||"").split("/");e.length&&!(a.host=e.shift()););a.host||(a.host=""),a.hostname||(a.hostname=""),""!==e[0]&&e.unshift(""),e.length<2&&e.unshift(""),d.pathname=e.join("/")}if(d.search=a.search,d.query=a.query,d.host=a.host||"",d.auth=a.auth,d.hostname=a.hostname||a.host,d.port=a.port,d.pathname||d.search){var f=d.pathname||"",g=d.search||"";d.path=f+g}return d.slashes=d.slashes||a.slashes,d.href=d.format(),d}var h=d.pathname&&"/"===d.pathname.charAt(0),k=a.host||a.pathname&&"/"===a.pathname.charAt(0),l=k||h||d.host&&a.pathname,m=l,n=d.pathname&&d.pathname.split("/")||[],e=a.pathname&&a.pathname.split("/")||[],o=d.protocol&&!w[d.protocol];if(o&&(d.hostname="",d.port=null,d.host&&(""===n[0]?n[0]=d.host:n.unshift(d.host)),d.host="",a.protocol&&(a.hostname=null,a.port=null,a.host&&(""===e[0]?e[0]=a.host:e.unshift(a.host)),a.host=null),l=l&&(""===e[0]||""===n[0])),k)d.host=a.host||""===a.host?a.host:d.host,d.hostname=a.hostname||""===a.hostname?a.hostname:d.hostname,d.search=a.search,d.query=a.query,n=e;else if(e.length)n||(n=[]),n.pop(),n=n.concat(e),d.search=a.search,d.query=a.query;else if(!i.isNullOrUndefined(a.search)){if(o){d.hostname=d.host=n.shift();var p=d.host&&d.host.indexOf("@")>0?d.host.split("@"):!1;p&&(d.auth=p.shift(),d.host=d.hostname=p.shift())}return d.search=a.search,d.query=a.query,i.isNull(d.pathname)&&i.isNull(d.search)||(d.path=(d.pathname?d.pathname:"")+(d.search?d.search:"")),d.href=d.format(),d}if(!n.length)return d.pathname=null,d.path=d.search?"/"+d.search:null,d.href=d.format(),d;for(var q=n.slice(-1)[0],r=(d.host||a.host)&&("."===q||".."===q)||""===q,s=0,t=n.length;t>=0;t--)q=n[t],"."==q?n.splice(t,1):".."===q?(n.splice(t,1),s++):s&&(n.splice(t,1),s--);if(!l&&!m)for(;s--;s)n.unshift("..");!l||""===n[0]||n[0]&&"/"===n[0].charAt(0)||n.unshift(""),r&&"/"!==j.substr(n.join("/"),-1)&&n.push("");var u=""===n[0]||n[0]&&"/"===n[0].charAt(0);if(o){d.hostname=d.host=u?"":n.length?n.shift():"";var p=d.host&&d.host.indexOf("@")>0?d.host.split("@"):!1;p&&(d.auth=p.shift(),d.host=d.hostname=p.shift())}return l=l||d.host&&n.length,l&&!u&&n.unshift(""),n.length?d.pathname=n.join("/"):(d.pathname=null,d.path=null),i.isNull(d.pathname)&&i.isNull(d.search)||(d.path=(d.pathname?d.pathname:"")+(d.search?d.search:"")),d.auth=a.auth||d.auth,d.slashes=d.slashes||a.slashes,d.href=d.format(),d},c.prototype.parseHost=function(){var a=this.host,b=l.exec(a);b&&(b=b[0],":"!==b&&(this.port=b.substr(1)),a=a.substr(0,a.length-b.length)),a&&(this.hostname=a)}}),require.register("backbone-orm/node/util",function(a,b){function c(a){return j.isArray(a)}function d(a){return"boolean"==typeof a}function e(a){return null===a}function f(a){return null==a}function g(a){return"number"==typeof a}function h(a){return"string"==typeof a}function i(a){return"object"==typeof a&&a}var j=b("./browserify/_shims");a.isArray=c,a.isBoolean=d,a.isNull=e,a.isNullOrUndefined=f,a.isNumber=g,a.isString=h,a.isObject=i}),require.register("backbone-orm/lib/cache/cursor",function(a,b,c){var d,e,f,g={}.hasOwnProperty,h=function(a,b){function c(){this.constructor=a}for(var d in b)g.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};e=b("underscore"),c.exports=d=function(a){function b(){return f=b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.toJSON=function(a){return this.wrapped_sync_fn("cursor",e.extend({},this._find,this._cursor)).toJSON(a)},b}(b("../cursor"))}),require.register("backbone-orm/lib/cache/memory_store",function(a,b,c){var d,e,f,g,h=function(a,b){return function(){return a.apply(b,arguments)}};g=b("underscore"),d=b("../../node/lru-cache"),f=b("inflection"),c.exports=e=function(){function a(a){var b,c,e;null==a&&(a={}),this.reset=h(this.reset,this),this.destroy=h(this.destroy,this),this.get=h(this.get,this),this.set=h(this.set,this),c={};for(b in a)e=a[b],"destroy"===b?c.dispose=e:c[this._normalizeKey(b)]=e;this.cache=new d(c)}return a.prototype.set=function(a,b,c){return b._orm_never_cache?("function"==typeof c?c(null,b):void 0)||this:(this.cache.set(a,b),"function"==typeof c&&c(null,b),this)},a.prototype.get=function(a,b){var c;return c=this.cache.get(a),"function"==typeof b&&b(null,c),c},a.prototype.destroy=function(a,b){return this.cache.del(a),"function"==typeof b&&b(),this},a.prototype.reset=function(a){return this.cache.reset(),"function"==typeof a&&a(),this},a.prototype._normalizeKey=function(a){return a=f.underscore(a),a.indexOf("_")<0?a.toLowerCase():f.camelize(a)},a}()}),require.register("backbone-orm/lib/cache/model_cache",function(a,b,c){var d,e,f,g,h,i,j;d=b("backbone"),j=b("underscore"),h=b("../queue"),f=b("./memory_store"),e=["max","max_age","destroy"],i=b("../utils"),c.exports=g=function(){function a(){this.enabled=!1,this.caches={},this.options={modelTypes:{}},this.verbose=!1}return a.prototype.configure=function(a){var b,c,d,e,f,g;if(null==a&&(a={}),this.enabled=a.enabled,this.reset(function(){}),!a)return this.options={modelTypes:{}},this;for(b in a)if(c=a[b],j.isObject(c)){(g=this.options)[b]||(g[b]={}),f=this.options[b];for(d in c)e=c[d],f[d]=e}else this.options[b]=c;return this},a.prototype.configureSync=function(a,c){var d;return a.prototype._orm_never_cache||!(d=this.getOrCreateCache(a.model_name))?c:(a.cache=d,b("./sync")(a,c))},a.prototype.reset=function(a){var b,c,d,e,f;c=new h,f=this.caches,e=function(a){return c.defer(function(b){return a.reset(b)})};for(b in f)d=f[b],e(d);return c.await(a)},a.prototype.hardReset=function(){var a,b,c;this.configure(),c=this.caches;for(a in c)b=c[a],delete this.caches[a];return this},a.prototype.getOrCreateCache=function(a){var b,c,d;if(!this.enabled)return null;if(!a)throw new Error("Missing model name for cache");return(b=this.caches[a])?b:(c=this.options.modelTypes[a])?this.caches[a]=("function"==typeof c.store?c.store():void 0)||new f(j.pick(c,e)):this.options.store||this.options.max||this.options.max_age?this.caches[a]=("function"==typeof(d=this.options).store?d.store():void 0)||new f(j.pick(this.options,e)):null},a}()}),require.register("backbone-orm/lib/cache/query_cache",function(a,b,c){var d,e,f,g,h,i,j,k=function(a,b){return function(){return a.apply(b,arguments)}};j=b("underscore"),i=b("inflection"),h=b("../queue"),e=b("../json_utils"),f=b("./memory_store"),d=2,c.exports=g=function(){function a(){this.storeKeyForModelTypes=k(this.storeKeyForModelTypes,this),this.getKeysForModelTypes=k(this.getKeysForModelTypes,this),this.clearMetaForModelTypes=k(this.clearMetaForModelTypes,this),this.clearModelTypes=k(this.clearModelTypes,this),this.reset=k(this.reset,this),this.hardReset=k(this.hardReset,this),this.getMeta=k(this.getMeta,this),this.getKey=k(this.getKey,this),this.get=k(this.get,this),this.set=k(this.set,this),this.configure=k(this.configure,this),this.enabled=!1}return a.prototype.configure=function(a){return null==a&&(a={}),this.enabled=a.enabled,this.verbose=a.verbose,this.hits=this.misses=this.clears=0,this.store=a.store||new f,this},a.prototype.cacheKey=function(a,b){return""+j.result(a.prototype,"url")+"_"+JSON.stringify(b)},a.prototype.cacheKeyMeta=function(a){return"meta_"+j.result(a.prototype,"url")},a.prototype.set=function(a,b,c,f,g){var h,i,j,k=this;return this.enabled?(this.verbose&&console.log("QueryCache:set",a.name,function(){var a,b,d;for(d=[],a=0,b=c.length;b>a;a++)i=c[a],d.push(i.name);return d}(),this.cacheKey(a,b),JSON.stringify(f),"\n-----------"),j=[a].concat(c||[]),h=this.cacheKey(a,b),this.store.set(h,e.deepClone(f,d),function(a){return a?g(a):k.storeKeyForModelTypes(j,h,g)})):g()},a.prototype.get=function(a,b,c){return this.enabled?this.getKey(this.cacheKey(a,b),c):c()},a.prototype.getKey=function(a,b){var c=this;return this.enabled?this.store.get(a,function(f,g){return f?b(f):j.isUndefined(g)||j.isNull(g)?(c.misses++,c.verbose&&console.log("QueryCache:miss",a,g,"\n-----------"),b()):(c.hits++,c.verbose&&console.log("QueryCache:hit",a,g,"\n-----------"),b(null,e.deepClone(g,d)))}):b()},a.prototype.getMeta=function(a,b){return this.enabled?this.store.get(this.cacheKeyMeta(a),b):b()},a.prototype.hardReset=function(a){return this.enabled?(this.verbose&&console.log("QueryCache:hardReset"),this.hits=this.misses=this.clears=0,this.store?this.store.reset(a):a()):a()},a.prototype.reset=function(a,b){var c,d,e,f;if(1===arguments.length)return this.hardReset(a);if(!this.enabled)return b();for(j.isArray(a)||(a=[a]),d=[],e=0,f=a.length;f>e;e++)c=a[e],d=d.concat(c.schema().allRelations());return a=a.concat(d),this.clearModelTypes(a,b)},a.prototype.clearModelTypes=function(a,b){var c=this;return a.length?this.getKeysForModelTypes(a,function(d,e){var f,g,i,k,l,m;if(d)return b(d);for(g=new h,g.defer(function(b){return c.clearMetaForModelTypes(a,b)}),m=j.uniq(e),i=function(a){return g.defer(function(b){return c.verbose&&console.log("QueryCache:cleared",a,"\n-----------"),c.clears++,c.store.destroy(a,b)})},k=0,l=m.length;l>k;k++)f=m[k],i(f);return g.await(b)}):b()},a.prototype.clearMetaForModelTypes=function(a,b){var c,d,e,f,g,i=this;for(d=new h,e=function(a){return d.defer(function(b){return i.verbose&&console.log("QueryCache:meta cleared",a.name,"\n-----------"),i.store.destroy(i.cacheKeyMeta(a),b)})},f=0,g=a.length;g>f;f++)c=a[f],e(c);return d.await(b)},a.prototype.getKeysForModelTypes=function(a,b){var c,d,e,f,g,i,j=this;for(c=[],e=new h(1),f=function(a){return e.defer(function(b){return j.getMeta(a,function(a,d){return a||!d?b(a):(c=c.concat(d),b())})})},g=0,i=a.length;i>g;g++)d=a[g],f(d);return e.await(function(a){return b(a,c)})},a.prototype.storeKeyForModelTypes=function(a,b,c){var d,e,f,g,i,k=this;for(e=new h(1),f=function(a){return e.defer(function(c){var d;return d=k.cacheKeyMeta(a),k.store.get(d,function(a,e){return a?c(a):((e||(e=[])).push(b),k.store.set(d,j.uniq(e),c))})})},g=0,i=a.length;i>g;g++)d=a[g],f(d);return e.await(c)},a}()}),require.register("backbone-orm/lib/cache/singletons",function(a,b,c){c.exports={ModelCache:new(b("./model_cache")),QueryCache:new(b("./query_cache"))}}),require.register("backbone-orm/lib/cache/sync",function(a,b,c){var d,e,f,g,h,i,j,k;k=b("underscore"),d=b("./cursor"),h=b("../schema"),i=b("../utils"),j=i.bbCallback,f=1e3,g=100,e=function(){function a(a,b){this.model_type=a,this.wrapped_sync_fn=b}return a.prototype.initialize=function(){if(!this.is_initialized&&(this.is_initialized=!0,this.wrapped_sync_fn("initialize"),!this.model_type.model_name))throw new Error("Missing model_name for model")},a.prototype.read=function(a,b){var c;return!b.force&&(c=this.model_type.cache.get(a.id))?b.success(c.toJSON()):this.wrapped_sync_fn("read",a,b)},a.prototype.create=function(a,b){var c=this;return this.wrapped_sync_fn("create",a,j(function(d,e){var f;return d?b.error(d):(a.set({id:e.id}),(f=c.model_type.cache.get(a.id))?f!==a&&i.updateModel(f,a):c.model_type.cache.set(a.id,a),b.success(e))}))},a.prototype.update=function(a,b){var c=this;return this.wrapped_sync_fn("update",a,j(function(d,e){var f;return d?b.error(d):((f=c.model_type.cache.get(a.id))?f!==a&&i.updateModel(f,a):c.model_type.cache.set(a.id,a),b.success(e))}))},a.prototype["delete"]=function(a,b){return this.model_type.cache.destroy(a.id),this.wrapped_sync_fn("delete",a,j(function(a,c){return a?b.error(a):b.success(c)}))},a.prototype.resetSchema=function(a,b){var c=this;return this.model_type.cache.reset(function(d){return d?b(d):c.wrapped_sync_fn("resetSchema",a,b)})},a.prototype.cursor=function(a){return null==a&&(a={}),new d(a,k.pick(this,["model_type","wrapped_sync_fn"]))},a.prototype.destroy=function(a,b){return this.model_type.batch(a,{$limit:f,parallelism:g},b,function(a,b){return a.destroy(j(b))})},a.prototype.connect=function(){return this.model_type.cache.reset(),this.wrapped_sync_fn("connect")},a}(),c.exports=function(a,b){var c,d;return c=new e(a,b),a.prototype.sync=d=function(a,d,e){return null==e&&(e={}),c.initialize(),"createSync"===a?b.apply(null,arguments):"sync"===a?c:c[a]?c[a].apply(c,Array.prototype.slice.call(arguments,1)):b.apply(b,Array.prototype.slice.call(arguments))},d}}),require.register("backbone-orm/lib/client_utils",function(a,b,c){var d,e;e=b("../node/util").isArray,c.exports=d=function(){function a(){}return a.loadDependencies=function(a){var c,d,f,g;if("undefined"!=typeof window&&null!==window?window.require.register:void 0)for(e(a)||(a=[a]),d=function(a){var c,d;try{if(c=b(a.path))return}catch(e){d=e}if(!(c=this[a.symbol])){if(a.optional)return;throw new Error("Missing dependency: "+a.path)}return window.require.register(a.path,function(a,b,d){return d.exports=c})},f=0,g=a.length;g>f;f++)c=a[f],d(c)},a}()}),require.register("backbone-orm/lib/connection_pool",function(a,b,c){var d;d=b("./cache/memory_store"),c.exports=new d({destroy:function(a,b){return b.destroy()}})}),require.register("backbone-orm/lib/cursor",function(a,b,c){var d,e,f,g,h,i=function(a,b){return function(){return a.apply(b,arguments)}};h=b("underscore"),f=b("./cache/singletons").QueryCache,g=b("./utils"),d=["$count","$exists","$zero","$one","$offset","$limit","$page","$sort","$white_list","$select","$include","$values","$ids"],c.exports=e=function(){function a(b,c){this.relatedModelTypesInQuery=i(this.relatedModelTypesInQuery,this);var d,e,f,g,j,k;for(d in c)f=c[d],this[d]=f;for(e=a.parseQuery(b,this.model_type),this._find=e.find,this._cursor=e.cursor,k=["$white_list","$select","$values"],g=0,j=k.length;j>g;g++)d=k[g],this._cursor[d]&&!h.isArray(this._cursor[d])&&(this._cursor[d]=[this._cursor[d]])}return a.validateQuery=function(b,c,d){var e,f,g,i;i=[];for(f in b)if(g=b[f],h.isUndefined(g)||h.isObject(g)){if(e=c?""+c+"."+f:f,h.isUndefined(g))throw new Error("Unexpected undefined for query key '"+e+"' on "+(null!=d?d.model_name:void 0));h.isObject(g)?i.push(a.validateQuery(g,e,d)):i.push(void 0)}return i},a.parseQuery=function(b,c){var d,e,f,g;if(b){if(h.isObject(b)){if(b.find||b.cursor)return{find:b.find||{},cursor:b.cursor||{}};try{a.validateQuery(b,null,c)}catch(i){throw d=i,new Error(""+d+", "+util.inspect(b))}f={find:{},cursor:{}};for(e in b)g=b[e],"$"!==e[0]?f.find[e]=g:f.cursor[e]=g;return f}return{find:{id:b},cursor:{$one:!0}}}return{find:{},cursor:{}}},a.prototype.offset=function(a){return this._cursor.$offset=a,this},a.prototype.limit=function(a){return this._cursor.$limit=a,this},a.prototype.sort=function(a){return this._cursor.$sort=a,this},a.prototype.whiteList=function(){var a;return a=h.flatten(arguments),this._cursor.$white_list=this._cursor.$white_list?h.intersection(this._cursor.$white_list,a):a,this},a.prototype.select=function(){var a;return a=h.flatten(arguments),this._cursor.$select=this._cursor.$select?h.intersection(this._cursor.$select,a):a,this},a.prototype.include=function(){var a;return a=h.flatten(arguments),this._cursor.$include=this._cursor.$include?h.intersection(this._cursor.$include,a):a,this},a.prototype.values=function(){var a;return a=h.flatten(arguments),this._cursor.$values=this._cursor.$values?h.intersection(this._cursor.$values,a):a,this},a.prototype.ids=function(){return this._cursor.$values=["id"],this},a.prototype.count=function(a){return this.execWithCursorQuery("$count","toJSON",a)},a.prototype.exists=function(a){return this.execWithCursorQuery("$exists","toJSON",a)},a.prototype.toModel=function(a){return this.execWithCursorQuery("$one","toModels",a)},a.prototype.hasCursorQuery=function(a){return this._cursor[a]||""===this._cursor[a]},a.prototype.execWithCursorQuery=function(a,b,c){var d,e=this;return d=this._cursor[a],this._cursor[a]=!0,this[b](function(b,f){return h.isUndefined(d)?delete e._cursor[a]:e._cursor[a]=d,c(b,f)})},a.prototype.toModels=function(a){var b=this;return h.isFunction(a)||console.trace("toModels: "+util.inspect(a)),this._cursor.$values?a(new Error("Cannot call toModels on cursor with values for model "+this.model_type.model_name+". Values: "+util.inspect(this._cursor.$values))):this.toJSON(function(c,d){return c?a(c):b._cursor.$one&&!d?a(null,null):(h.isArray(d)||(d=[d]),b.prepareIncludes(d,function(c,d){var e,f,h,i;return i=(e=!(b._cursor.$select||b._cursor.$whitelist))?function(){var a,b,c;for(c=[],a=0,b=d.length;b>a;a++)f=d[a],c.push(g.updateOrNew(f,this.model_type));return c}.call(b):function(){var a,b,c;for(h=new this.model_type(this.model_type.prototype.parse(f)),h.setPartial(!0),c=[],a=0,b=d.length;b>a;a++)f=d[a],c.push(h);return c}.call(b),a(null,b._cursor.$one?i[0]:i)}))})},a.prototype.toJSON=function(a){var b,c=this;return b=h.extend({},h.pick(this._cursor,d),this._find),f.get(this.model_type,b,function(d,e){var g;return d?a(d):h.isUndefined(e)?(g=c.relatedModelTypesInQuery(),c.queryToJSON(function(d,e){return d?a(d):h.isNull(e)?a(null,e):f.set(c.model_type,b,g,e,function(b){return b&&console.log("Error setting query cache: "+b),a(null,e)})})):a(null,e)})},a.prototype.queryToJSON=function(){throw new Error("toJSON must be implemented by a concrete cursor for a Backbone Sync type")},a.prototype.relatedModelTypesInQuery=function(){var a,b,c,d,e,f,g,h,i,j,k,l;b=[],c=[],j=this._find;for(a in j)g=j[a],a.indexOf(".")>0?(k=a.split("."),e=k[0],a=k[1],b.push(e)):(f=this.model_type.reverseRelation(a))&&f.join_table&&(c.push(f.model_type),c.push(f.join_table));for((null!=(l=this._cursor)?l.$include:void 0)&&(b=b.concat(this._cursor.$include)),h=0,i=b.length;i>h;h++)e=b[h],d=this.model_type.relation(e),c.push(d.reverse_model_type),d.join_table&&c.push(d.join_table);return c},a.prototype.selectResults=function(a){var b,c,d,e;return this._cursor.$values?(c=this._cursor.$white_list?h.intersection(this._cursor.$values,this._cursor.$white_list):this._cursor.$values,1===this._cursor.$values.length?(e=this._cursor.$values[0],a=c.length?function(){var b,c,f;for(f=[],b=0,c=a.length;c>b;b++)d=a[b],f.push(d.hasOwnProperty(e)?d[e]:null);return f}():h.map(a,function(){return null})):a=function(){var b,f,g;for(g=[],b=0,f=a.length;f>b;b++)d=a[b],g.push(function(){var a,b,f;for(f=[],a=0,b=c.length;b>a;a++)e=c[a],d.hasOwnProperty(e)&&f.push(d[e]);return f}());return g}()):this._cursor.$select?(b=this._cursor.$white_list?h.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,a=function(){var c,e,f;for(f=[],c=0,e=a.length;e>c;c++)d=a[c],f.push(h.pick(d,b));return f}()):this._cursor.$white_list&&(a=function(){var b,c,e;for(e=[],b=0,c=a.length;c>b;b++)d=a[b],e.push(h.pick(d,this._cursor.$white_list));return e}.call(this)),this._cursor.$one?a[0]||null:a},a.prototype.selectFromModels=function(a){var b,c,d;return this._cursor.$select?(b=this._cursor.$white_list?h.intersection(this._cursor.$select,this._cursor.$white_list):this._cursor.$select,a=function(){var e,f,g;for(d=new this.model_type(h.pick(d.attributes,b)),d.setPartial(!0),g=[],e=0,f=a.length;f>e;e++)c=a[e],g.push(d);return g}.call(this)):this._cursor.$white_list&&(a=function(){var b,e,f;for(d=new this.model_type(h.pick(d.attributes,this._cursor.$white_list)),d.setPartial(!0),f=[],b=0,e=a.length;e>b;b++)c=a[b],f.push(d);return f}.call(this)),a},a.prototype.prepareIncludes=function(a,b){var c,d,e,f,g,i,j,k,l,m,n,o,p;if(!h.isArray(this._cursor.$include)||h.isEmpty(this._cursor.$include))return b(null,a);for(j=this.model_type.schema(),k={},c=function(a,b){return k[a.id]||(b.cache?(k[a.id]=b.cache.get(a.id))||b.cache.set(a.id,k[a.id]=new b(a)):k[a.id]=new b(a)),k[a.id]},p=this._cursor.$include,l=0,n=p.length;n>l;l++)for(d=p[l],i=j.relation(d),k={},m=0,o=a.length;o>m;m++)f=a[m],h.isArray(g=f[d])?f[d]=function(){var a,b,d;for(d=[],a=0,b=g.length;b>a;a++)e=g[a],d.push(c(e,i.reverse_model_type));return d}():g&&(f[d]=c(g,i.reverse_model_type));return b(null,a)},a}.call(this)}),require.register("backbone-orm/lib/database_url",function(a,b,c){var d,e,f,g,h;h=b("underscore"),g=b("inflection"),f=b("../node/url"),e=["protocol","slashes","auth","host","hostname","port","search","query","hash","href"],c.exports=d=function(){function a(a,b,c){var d,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;
if(q=f.parse(a,b,c),m=q.pathname.split(","),m.length>1){for(o=h.pick(q,"protocol","auth","slashes"),o.host="{1}",o.pathname="{2}",p=f.format(o),p=p.replace("{1}/{2}",""),n=q.pathname.split("/"),q.pathname="/"+n[n.length-2]+"/"+n[n.length-1],j=a.replace(p,""),j=j.substring(0,j.indexOf(q.pathname)),i=j.split(","),x=["host","hostname","port"],r=0,u=x.length;u>r;r++)l=x[r],delete q[l];for(this.hosts=[],s=0,v=i.length;v>s;s++)d=i[s],k=d.split(":"),this.hosts.push(1===k.length?{host:k[0],hostname:k[0]}:{host:k[0],hostname:""+k[0]+":"+k[1],port:k[1]})}for(g=q.pathname.split("/"),this.table=g.pop(),this.database=g[g.length-1],t=0,w=e.length;w>t;t++)l=e[t],q.hasOwnProperty(l)&&(this[l]=q[l])}return a.prototype.format=function(a){var b,c,d;return null==a&&(a={}),d=h.pick(this,e),d.pathname="",this.hosts&&(b=h.map(this.hosts,function(a){return""+a.host+(a.port?":"+a.port:"")}),d.pathname+=b.join(","),d.host="{1}"),this.database&&(d.pathname+="/"+this.database),this.table&&!a.exclude_table&&(d.pathname+="/"+this.table),(a.exclude_search||a.exclude_query)&&(delete d.search,delete d.query),c=f.format(d),this.hosts&&(c=c.replace("{1}/"+d.pathname,d.pathname)),c},a.prototype.parseAuth=function(){var a,b;return this.auth?(a=this.auth.split(":"),b={user:a[0]},b.password=a.length>1?a[1]:null,b):null},a.prototype.modelName=function(){return this.table?g.classify(g.singularize(this.table)):null},a}()}),require.register("backbone-orm/lib/extensions/collection",function(a,b){var c,d,e;c=b("backbone"),d=b("../utils"),e=c.Collection.prototype._prepareModel,c.Collection.prototype._prepareModel=function(a,b){var c,f,g;return!d.isModel(a)&&(c=d.dataId(a))?(this.model.cache&&(f=!!this.model.cache.get(c)),g=d.updateOrNew(a,this.model),f&&!g._validate(a,b)?(this.trigger("invalid",this,a,b),!1):g):e.call(this,a,b)}}),require.register("backbone-orm/lib/extensions/model",function(a,b,c){var d,e,f,g,h;h=b("underscore"),d=b("backbone"),g=b("moment"),e=b("../queue"),f=b("../utils"),b("./collection"),c.exports=function(a){var b,c,d,i,j,k;if(b=function(){function a(){}return a}(),a.createSync=function(b){return a.prototype.sync("createSync",b)},a.resetSchema=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),a.prototype.sync("resetSchema",b,c)},a.cursor=function(b){return null==b&&(b={}),a.prototype.sync("cursor",b)},a.destroy=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),h.isObject(b)||(b={id:b}),a.prototype.sync("destroy",b,c)},a.db=function(){return a.prototype.sync("db")},a.exists=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),a.prototype.sync("cursor",b).exists(c)},a.count=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),a.prototype.sync("cursor",b).count(c)},a.all=function(b){return a.prototype.sync("cursor",{}).toModels(b)},a.find=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),a.prototype.sync("cursor",b).toModels(c)},a.findOne=function(b,c){var d;return 1===arguments.length&&(d=[{},b],b=d[0],c=d[1]),b=h.isObject(b)?h.extend({$one:!0},b):{id:b,$one:!0},a.prototype.sync("cursor",b).toModels(c)},a.findOrCreate=function(b,c){var d;if(!h.isObject(b)||f.isModel(b)||f.isCollection(b))throw"findOrCreate requires object data";return d=h.extend({$one:!0},b),a.prototype.sync("cursor",d).toModels(function(d,e){return d?c(d):e?c(null,e):(e=new a(b),e.save({},function(b){var d;return b?c(b):((d=a.cache)&&d.set(e.id,e),c(null,e))}))})},a.findOneNearestDate=function(b,c,d,e){var f,i,j,k;if(!(i=c.key))throw new Error("Missing options key");return 2===arguments.length?(j=[{},d],d=j[0],e=j[1]):3===arguments.length?(k=[g.utc().toDate(),{},d],c=k[0],d=k[1],e=k[2]):d=h.clone(d),d.$one=!0,f=[function(c){return d[i]={$lte:b},a.cursor(d).sort("-"+i).toModels(c)},function(c){return d[i]={$gte:b},a.cursor(d).sort(i).toModels(c)}],c.reverse&&(f=[f[1],f[0]]),f[0](function(a,b){return a?e(a):b?e(null,b):f[1](e)})},a.batch=function(){var b;for(b=h.toArray(arguments);b.length<4;)b.unshift({});return b.unshift(a),f.batch.apply(null,b)},a.interval=function(){var b;for(b=h.toArray(arguments);b.length<4;)b.unshift({});return b.unshift(a),f.interval.apply(null,b)},a.prototype.modelName=function(){return a.model_name},a.prototype.cache=function(){return a.cache},a.prototype.schema=a.schema=function(){return a.prototype.sync("schema")},a.prototype.tableName=a.tableName=function(){return a.prototype.sync("tableName")},a.prototype.relation=a.relation=function(b){var c;return(c=a.prototype.sync("schema"))?c.relation(b):void 0},a.prototype.relationIsEmbedded=a.relationIsEmbedded=function(b){var c;return(c=a.relation(b))?!!c.embed:!1},a.prototype.reverseRelation=a.reverseRelation=function(b){var c;return(c=a.prototype.sync("schema"))?c.reverseRelation(b):void 0},a.prototype.isLoaded=function(a){return 0===arguments.length&&(a="__model__"),!f.orSet(this,"needs_load",{})[a]},a.prototype.setLoaded=function(a,b){var c,d;return 1===arguments.length&&(d=["__model__",a],a=d[0],b=d[1]),c=f.orSet(this,"needs_load",{}),b&&f.get(this,"is_initialized")?(delete c[a],void 0):c[a]=!b},a.prototype.isLoadedExists=function(a){return 0===arguments.length&&(a="__model__"),f.orSet(this,"needs_load",{}).hasOwnProperty(a)},a.prototype.isPartial=function(){return!!f.get(this,"partial")},a.prototype.setPartial=function(a){return a?f.set(this,"partial",!0):f.unset(this,"partial")},a.prototype.release=function(){throw"release: experimental and incomplete"},a.prototype.patchAdd=function(a,b,c){var d;return(d=this.relation(a))?b?d.patchAdd(this,b,c):c(new Error("patchAdd: missing relateds for '"+a+"'")):c(new Error("patchAdd: relation '"+a+"' unrecognized"))},a.prototype.patchRemove=function(b,c,d){var f,g,h,i,j,k=this;if(1===arguments.length){d=b,h=a.schema(),f=new e(1),j=h.relations,i=function(a){return f.defer(function(b){return a.patchRemove(k,b)})};for(b in j)g=j[b],i(g);return f.await(d)}return(g=this.relation(b))?2===arguments.length?(d=c,g.patchRemove(this,d)):c?g.patchRemove(this,c,d):d(new Error("patchRemove: missing relateds for '"+b+"'")):d(new Error("patchRemove: relation '"+b+"' unrecognized"))},a.prototype.cursor=function(b,c){var d,e;if(null==c&&(c={}),a.schema&&(e=a.schema()),e&&(d=e.relation(b)))return d.cursor(this,b,c);throw new Error(""+e.model_name+"::cursor: Unexpected key: "+b+" is not a relation")},j=function(a,b){var c,d,e,f;return a.isNew()||!a.modelName?a.clone(b):(c=(e=b._cache)[f=a.modelName()]||(e[f]={}),(d=c[a.id])||(d=c[a.id]=a.clone(b)),d)},i={initialize:function(){var b,c,d,e,g,h;if(a.schema&&(e=a.schema())){h=e.relations;for(b in h)d=h[b],d.initializeModel(this);c=f.orSet(this,"needs_load",{});for(b in c)g=c[b],g||delete c[b];f.set(this,"is_initialized",!0)}return a.prototype._orm_original_fns.initialize.apply(this,arguments)},fetch:function(b){var c=this;return a.prototype._orm_original_fns.fetch.call(this,f.wrapOptions(b,function(a,b,d,e){return a?"function"==typeof e.error?e.error(c,d,e):void 0:(c.setLoaded(!0),"function"==typeof e.success?e.success(b,d,e):void 0)}))},unset:function(b){var c;return c=this.id,a.prototype._orm_original_fns.unset.apply(this,arguments),"id"===b&&a.cache&&c&&a.cache.get(c)===this?a.cache.destroy(c):void 0},set:function(b,c,d){var e,f,g,i,j;if(!a.schema||!(i=a.schema()))return a.prototype._orm_original_fns.set.apply(this,arguments);h.isString(b)?(e={})[b]=c:(e=b,d=c),j={},g={};for(b in e)c=e[b],(f=i.relation(b))?g[b]=f:j[b]=c;h.size(j)&&a.prototype._orm_original_fns.set.call(this,j,d);for(b in g)f=g[b],f.set(this,b,e[b],d);return this},get:function(b,c){var d,e,f;return a.schema&&(e=a.schema()),e&&(d=e.relation(b))?d.get(this,b,c):(f=a.prototype._orm_original_fns.get.call(this,b),c&&c(null,f),f)},toJSON:function(b){var c,d,e,g,i,j,k,l,m;if(null==b&&(b={}),a.schema&&(i=a.schema()),this._orm||(this._orm={}),this._orm.json>0)return this.id;for((k=this._orm).json||(k.json=0),this._orm.json++,c={},e=b.keys||this.whitelist||h.keys(this.attributes),l=0,m=e.length;m>l;l++)d=e[l],j=this.attributes[d],i&&(g=i.relation(d))?g.appendJSON(c,this):c[d]=f.isCollection(j)?h.map(j.models,function(a){return a?a.toJSON(b):null}):f.isModel(j)?j.toJSON(b):j;return--this._orm.json,c},save:function(b,c,d){var g,i,j=this;return null===b||h.isObject(b)?(g=b,d=c):(g={})[b]=c,this.isLoaded()?(this._orm||(this._orm={}),this._orm.save>0?"function"==typeof d.error?d.error(this,new Error("Model is in a save loop: "+a.model_name)):void 0:((i=this._orm).save||(i.save=0),this._orm.save++,this.set(g,d),g={},f.presaveBelongsToRelationships(this,function(c){return c?"function"==typeof d.error?d.error(j,c):void 0:a.prototype._orm_original_fns.save.call(j,g,f.wrapOptions(d,function(c,d,f,g){var h,i,k,l,m;if(--j._orm.save,c)return"function"==typeof g.error?g.error(j,f,g):void 0;if(h=new e(1),a.schema){k=a.schema(),m=k.relations,l=function(a){return h.defer(function(b){return a.save(j,b)})};for(b in m)i=m[b],l(i)}return h.await(function(a){return a?"function"==typeof g.error?g.error(j,Error("Failed to save relations. "+a,g)):void 0:"function"==typeof g.success?g.success(j,f,g):void 0})}))}))):"function"==typeof d.error?d.error(this,new Error("An unloaded model is trying to be saved: "+a.model_name)):void 0},destroy:function(b){var c,d,e,g=this;if((c=this.cache())&&c.destroy(this.id),!a.schema||!(d=a.schema()))return _original_destroy.apply(this,arguments);if(this._orm||(this._orm={}),this._orm.destroy>0)throw new Error("Model is in a destroy loop: "+a.model_name);return(e=this._orm).destroy||(e.destroy=0),this._orm.destroy++,a.prototype._orm_original_fns.destroy.call(this,f.wrapOptions(b,function(a,b,c,d){return--g._orm.destroy,a?"function"==typeof d.error?d.error(g,c,d):void 0:g.patchRemove(function(a){return a?"function"==typeof d.error?d.error(g,new Error("Failed to destroy relations. "+a,d)):void 0:"function"==typeof d.success?d.success(b,c,d):void 0})}))},clone:function(b){var c,d,e,g,i,k,l,m,n,o,p,q;if(!a.schema)return a.prototype._orm_original_fns.clone.apply(this,arguments);if(b||(b={}),b._cache||(b._cache={}),c=(l=b._cache)[p=this.modelName()]||(l[p]={}),this._orm||(this._orm={}),this._orm.clone>0)return this.id?c[this.id]:a.prototype._orm_original_fns.clone.apply(this,arguments);for((m=this._orm).clone||(m.clone=0),this._orm.clone++,this.id?(d=c[this.id])||(c[this.id]=d=new this.constructor):d=new this.constructor,this.attributes.id&&(d.id=this.attributes.id),g=b.keys||h.keys(this.attributes),n=0,o=g.length;o>n;n++)e=g[n],k=this.attributes[e],f.isCollection(k)?((null!=(q=d.attributes[e])?q.values:void 0)||(d.attributes[e]=new k.constructor),d.attributes[e].models=function(){var a,c,d,e;for(d=k.models,e=[],a=0,c=d.length;c>a;a++)i=d[a],e.push(j(i,b));return e}()):d.attributes[e]=f.isModel(k)?j(k,b):k;return--this._orm.clone,d}},!a.prototype._orm_original_fns){a.prototype._orm_original_fns={},k=[];for(d in i)c=i[d],a.prototype._orm_original_fns[d]=a.prototype[d],k.push(a.prototype[d]=c);return k}}}),require.register("backbone-orm/lib/index",function(a,b,c){var d;d=b("./client_utils"),d.loadDependencies([{symbol:"_",path:"lodash",optional:!0},{symbol:"_",path:"underscore"},{symbol:"Backbone",path:"backbone"},{symbol:"moment",path:"moment"},{symbol:"inflection",path:"inflection"}]),c.exports={sync:b("./memory/sync"),Utils:b("./utils"),JSONUtils:b("./json_utils"),DatabaseURL:b("./database_url"),Queue:b("./queue"),ConnectionPool:b("./connection_pool"),CacheSingletons:b("./cache/singletons")}}),require.register("backbone-orm/lib/json_utils",function(a,b,c){var d,e,f,g;g=b("underscore"),f=b("moment"),e=b("./queue"),c.exports=d=function(){function a(){}return a.parseParams=function(a){var b,c,d;c={};for(b in a)d=a[b],c[b]=JSON.parse(d);return c},a.parse=function(b){var c,d,e,h,i,j;if(g.isNull(b)||"null"===b)return null;if(g.isDate(b))return b;if(g.isArray(b))return g.map(b,a.parse);if(g.isObject(b)){i={};for(e in b)j=b[e],i[e]=a.parse(j);return i}if(g.isString(b)){if(b.length>=20&&"Z"===b[b.length-1])return c=f.utc(b),c&&c.isValid()?c.toDate():b;if("true"===b)return!0;if("false"===b)return!1;if(h=/^\"(.*)\"$/.exec(b))return h[0];try{if(b=JSON.parse(b))return a.parse(b)}catch(k){d=k}}return b},a.toQuery=function(b,c){var d,e,f;if(null==c&&(c=0),g.isNull(b))return null;if(g.isArray(b))return JSON.stringify(b);if(g.isDate(b)||b.toJSON)return b.toJSON();if(g.isObject(b)){if(c>0)return JSON.stringify(b);e={};for(d in b)f=b[d],e[d]=a.toQuery(f,1);return e}return b},a.renderTemplate=function(b,c,d,f){var h,i,j,k,l,m;if(3===arguments.length&&(f=d,d={}),g.isArray(b)){for(j=[],i=new e(1),k=function(b){return i.defer(function(e){return a.renderTemplate(b,c,d,function(a,b){return a?e(a):(j.push(b),e())})})},l=0,m=b.length;m>l;l++)h=b[l],k(h);return i.await(function(a){return f(a,a?void 0:j)})}return b?g.isString(c)?a.renderKey(b,c,d,f):g.isArray(c)?a.renderKeys(b,c,d,f):g.isFunction(c)?c(b,d,f):a.renderDSL(b,c,d,f):f(null,null)},a.renderDSL=function(b,c,d,f){var h,i,j,k,l;3===arguments.length&&(f=d,d={}),j=new e,k={},l=function(c,e){return j.defer(function(f){var h,i,j,l,m;return h=e.key||c,(l=b.relation(h))?(e.query?(j=e.query,m=e.template):e.$count?(j=g.clone(e),delete j.key):g.isFunction(e)?m=e:e.template?g.isObject(e.template)&&!g.isFunction(e.template)?j=e.template:(m=e.template,j=g.clone(e),delete j.key,delete j.template,0===g.size(j)&&(j=null)):(m=g.clone(e),delete m.key),m?j?l.cursor(b,h,j).toModels(function(b,e){return b?f(b):a.renderTemplate(e,m,d,function(a,b){return k[c]=b,f(a)})}):b.get(h,function(b,e){return b?f(b):a.renderTemplate(e,m,d,function(a,b){return k[c]=b,f(a)})}):l.cursor(b,h,j).toJSON(function(a,b){return k[c]=b,f(a)})):(c.length>1&&"_"===c[c.length-1]&&(c=c.slice(0,+(c.length-2)+1||9e9)),"$select"===c?g.isString(e)?a.renderKey(b,e,d,function(a,b){return k[e]=b,f(a)}):a.renderKeys(b,e,d,function(a,b){return g.extend(k,b),f(a)}):g.isString(e)?a.renderKey(b,e,d,function(a,b){return k[c]=b,f(a)}):g.isFunction(e)?e(b,d,function(a,b){return k[c]=b,f(a)}):g.isString(e.method)?(i=g.isArray(e.args)?e.args.slice():e.args?[e.args]:[],i.push(function(a,b){return k[c]=b,f()}),b[e.method].apply(b,i)):(console.trace("Unknown DSL action: "+c+": "+util.inspect(e)),f(new Error("Unknown DSL action: "+c+": "+util.inspect(e)))))})};for(i in c)h=c[i],l(i,h);return j.await(function(a){return f(a,a?void 0:k)})},a.renderKeys=function(b,c,d,f){var g,h,i,j,k,l;for(3===arguments.length&&(f=d,d={}),i={},h=new e,j=function(c){return h.defer(function(e){return a.renderKey(b,c,d,function(a,b){return a?e(a):(i[c]=b,e())})})},k=0,l=c.length;l>k;k++)g=c[k],j(g);return h.await(function(a){return f(a,a?void 0:i)})},a.renderKey=function(a,b,c,d){return 3===arguments.length&&(d=c,c={}),a.get(b,function(c,e){var f;if(c)return d(c);if(a.relation(b)){if(g.isArray(e))return d(null,function(){var a,b,c;for(c=[],a=0,b=e.length;b>a;a++)f=e[a],c.push(f.toJSON());return c}());if(e&&e.toJSON)return d(null,e=e.toJSON())}return d(null,e)})},a.renderRelated=function(b,c,d,f,h){var i,j,k,l,m,n;if(4===arguments.length&&(h=f,f={}),g.isArray(b)){for(k=[],j=new e,l=function(b){return j.defer(function(e){return b.get(c,function(b,c){return b&&e(b),a.renderTemplate(c,d,f,function(a,b){return a?e(a):(k.push(b),e())})})})},m=0,n=b.length;n>m;m++)i=b[m],l(i);return j.await(function(a){return h(a,a?void 0:k)})}return b.get(c,function(b,c){return b&&h(b),a.renderTemplate(c,d,f,h)})},a.deepClone=function(b,c){var d,e;if(!b||"object"!=typeof b)return b;if(g.isString(b))return String.prototype.slice.call(b);if(g.isDate(b))return new Date(b.valueOf());if(g.isFunction(b.clone))return b.clone();if(g.isArray(b))d=Array.prototype.slice.call(b);else{if(b.constructor!=={}.constructor)return b;d=g.extend({},b)}if(!g.isUndefined(c)&&c>0)for(e in d)d[e]=a.deepClone(d[e],c-1);return d},a}.call(this)}),require.register("backbone-orm/lib/memory/cursor",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n={}.hasOwnProperty,o=function(a,b){function c(){this.constructor=a}for(var d in b)n.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},p=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};l=b("underscore"),k=b("moment"),j=b("inflection"),h=b("../queue"),i=b("../utils"),d=b("../cursor"),e={$ne:function(a,b){return!l.isEqual(a,b)},$lt:function(a,b){if(l.isNull(b))throw Error("Cannot compare to null");return l.isDate(b)?k(a).isBefore(b):b>a},$lte:function(a,b){var c;if(l.isNull(b))throw Error("Cannot compare to null");return l.isDate(b)?(c=k(a),c.isBefore(b)||c.isSame(b)):b>a||l.isEqual(a,b)},$gt:function(a,b){if(l.isNull(b))throw Error("Cannot compare to null");return l.isDate(b)?k(a).isAfter(b):a>b},$gte:function(a,b){var c;if(l.isNull(b))throw Error("Cannot compare to null");return l.isDate(b)?(c=k(a),c.isAfter(b)||c.isSame(b)):a>b||l.isEqual(a,b)}},f=l.keys(e),c.exports=g=function(a){function b(){return m=b.__super__.constructor.apply(this,arguments)}return o(b,a),b.prototype.queryToJSON=function(a){var c,d=this;return this.hasCursorQuery("$zero")?a(null,this.hasCursorQuery("$one")?null:[]):(c=this.hasCursorQuery("$exists"),this.buildFindQuery(function(e,f){var g,j,k;return e?a(e):(g=[],j=l.keys(f),k=new h(1),k.defer(function(a){var b,e,k,m,n,o,q,r,s,t,u;k={};for(n in f)q=f[n],(null!=q?q.$in:void 0)&&(delete f[n],k[n]=q.$in);if(m=l.size(k),j.length||m){if(d._cursor.$ids){s=d.store;for(e in s)o=s[e],l.contains(d._cursor.$ids,o.id)&&l.isEqual(l.pick(o,j),f)&&g.push(i.deepClone(o));return a()}b=new h,t=d.store,r=function(a){return b.defer(function(b){var e,h;return e=l.keys(f),h=function(k,l){return k?b(k):l?!e.length||c&&j.length!==e.length?(g.push(i.deepClone(a)),b()):d._valueIsMatch(f,e.pop(),a,h):b()},h(null,!0)})};for(e in t)o=t[e],r(o);return b.await(function(b){return b?a(b):(m&&(g=l.filter(g,function(a){var b,c;for(n in k)if(b=k[n],c=a[n],p.call(b,c)>=0)return!0})),a())})}if(d._cursor.$ids){u=d.store;for(e in u)o=u[e],l.contains(d._cursor.$ids,o.id)&&g.push(i.deepClone(o))}else g=function(){var a,b;a=this.store,b=[];for(e in a)o=a[e],b.push(i.deepClone(o));return b}.call(d);return a()}),c||(k.defer(function(a){var b,c;return d._cursor.$sort&&(b=l.isArray(d._cursor.$sort)?d._cursor.$sort:[d._cursor.$sort],g.sort(function(a,c){return i.jsonFieldCompare(a,c,b)})),d._cursor.$offset&&(c=g.length-d._cursor.$offset,0>c&&(c=0),g=c?g.slice(d._cursor.$offset,d._cursor.$offset+c):[]),d._cursor.$one?g=g.length?[g[0]]:[]:d._cursor.$limit&&(g=g.splice(0,Math.min(g.length,d._cursor.$limit))),a()}),k.defer(function(a){return d.fetchIncludes(g,a)})),k.await(function(){var e;return d.hasCursorQuery("$count")?a(null,l.isArray(g)?g.length:g?1:0):c?a(null,l.isArray(g)?!!g.length:g):(g=d.selectResults(g),d.hasCursorQuery("$page")?(e=new b(d._find,l.extend(l.pick(d,["model_type","store"]))),e.count(function(b,c){return a(null,{offset:d._cursor.$offset||0,total_rows:c,rows:g})})):a(null,g))}),void 0)}))},b.prototype.buildFindQuery=function(a){var b,c,d,e,f,g,i,j,k,m,n=this;d=new h,b={},k=this._find,j=function(a,e,f){return d.defer(function(d){var g,h;return(h=n.model_type.relation(a))?h.join_table||"id"!==e?h.join_table||"belongsTo"===h.type?((g={$values:"id"})[e]=f,h.reverse_relation.model_type.cursor(g).toJSON(function(a,c){var e;return a?d(a):h.join_table?((e={})[h.reverse_relation.join_key]={$in:l.compact(c)},e.$values=h.foreign_key,h.join_table.cursor(e).toJSON(function(a,c){return a?d(a):(b.id={$in:l.compact(c)},d())})):(b[h.foreign_key]={$in:l.compact(c)},d())})):((g={})[e]=f,g.$values=h.foreign_key,h.reverse_model_type.cursor(g).toJSON(function(a,c){return a?d(a):(b.id={$in:l.compact(c)},d())})):(b[h.foreign_key]=f,d()):(b[c]=f,d())})};for(c in k)if(g=k[c],c.indexOf(".")<0){if(!(f=this.model_type.reverseRelation(c))){b[c]=g;continue}if(!f.embed&&!f.join_table){b[c]=g;continue}!function(a,c,e){return d.defer(function(d){var f;if(e.embed)throw Error("Embedded find is not yet supported. @_find: "+util.inspect(n._find));return(f={})[a]=c,f.$values=e.reverse_relation.join_key,e.join_table.cursor(f).toJSON(function(a,c){return a?d(a):(b.id={$in:c},d())})})}(c,g,f)}else m=c.split("."),e=m[0],i=m[1],this.model_type.relationIsEmbedded(e)?b[c]=g:j(e,i,g);return d.await(function(c){return a(c,b)})},b.prototype.fetchIncludes=function(a,b){var c,d,e,f,g,i,j,k,m,n;if(!this._cursor.$include)return b();for(e=new h(1),c=l.isArray(this._cursor.$include)?this._cursor.$include:[this._cursor.$include],j=0,m=c.length;m>j;j++)if(d=c[j],!this.model_type.relationIsEmbedded(d)){if(!(g=this.model_type.relation(d)))return b(new Error("Included relation '"+d+"' is not a relation"));for(i=function(a,b){return e.defer(function(c){return g.cursor(b,a).toJSON(function(d,e){return d?calback(d):(delete b[g.foriegn_key],b[a]=e,c())})})},k=0,n=a.length;n>k;k++)f=a[k],i(d,f)}return e.await(b)},b.prototype._valueIsMatch=function(a,b,c,d){var g,h,i;return g=b.split("."),h=this.model_type,i=function(j,k){var m,n,o,p,q,r,s,t,u,v,w;if(j)return d(j);if(o=g.shift(),!g.length){for(s=!1,m=a[b],l.isArray(k)||(k=[k]),t=0,v=k.length;v>t;t++){if(c=k[t],p=c[o],l.isObject(m))for(u=0,w=f.length;w>u&&(q=f[u],!m.hasOwnProperty(q)||(s=!0,n=e[q](p,m[q])));u++);if(s){if(n)return d(null,n)}else if(n=l.isEqual(p,m))return d(null,n)}return d(null,!1)}return(r=h.relation(o))&&!r.embed?r.cursor(c,o).toJSON(i):i(null,c[o])},i(null,c)},b}(d)}),require.register("backbone-orm/lib/memory/sync",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o;o=b("underscore"),d=b("backbone"),j=b("../queue"),f=b("./cursor"),l=b("../schema"),m=b("../utils"),h=b("../cache/singletons").ModelCache,i=b("../cache/singletons").QueryCache,n=b("../extensions/model"),e=1e3,k={},g=function(){function a(a){var b;this.model_type=a,this.model_type.model_name=m.findOrGenerateModelName(this.model_type),this.schema=new l(this.model_type),this.store=this.model_type.store=k[b=this.model_type.model_name]||(k[b]={})}return a.prototype.initialize=function(){return this.is_initialized?void 0:(this.is_initialized=!0,this.schema.initialize())},a.prototype.read=function(a,b){var c,d;return b.success(a.models?function(){var a,b;a=this.store,b=[];for(c in a)d=a[c],b.push(m.deepClone(d));return b}.call(this):m.deepClone(this.store[a.id]))},a.prototype.create=function(a,b){var c=this;return i.reset(this.model_type,function(d){var e;return d?"function"==typeof b.error?b.error(d):void 0:(a.set({id:m.guid()}),e=c.store[a.id]=a.toJSON(),b.success(m.deepClone(e)))})},a.prototype.update=function(a,b){var c=this;return i.reset(this.model_type,function(d){var e;return d?"function"==typeof b.error?b.error(d):void 0:(c.store[a.id]=e=a.toJSON(),b.success(m.deepClone(e)))})},a.prototype["delete"]=function(a,b){var c=this;return i.reset(this.model_type,function(d){return d?"function"==typeof b.error?b.error(d):void 0:c.store[a.id]?(delete c.store[a.id],b.success()):b.error(new Error("Model not found"))})},a.prototype.resetSchema=function(a,b){var c=this;return i.reset(this.model_type,function(a){return a?b(a):c.destroy({},b)})},a.prototype.cursor=function(a){return null==a&&(a={}),new f(a,o.pick(this,["model_type","store"]))},a.prototype.destroy=function(a,b){var c=this;return i.reset(this.model_type,function(d){return d?b(d):c.model_type.batch(a,{$limit:e,method:"toJSON"},b,function(a,b){return m.patchRemoveByJSON(c.model_type,a,function(d){return d||delete c.store[a.id],b(d)})})})},a}(),c.exports=function(a){var b,d,e;return m.isCollection(new a)?(b=m.configureCollectionModelType(a,c.exports),a.prototype.sync=b.prototype.sync):(d=new g(a),a.prototype.sync=e=function(a,b,e){return null==e&&(e={}),d.initialize(),"createSync"===a?c.exports.apply(null,Array.prototype.slice.call(arguments,1)):"sync"===a?d:"isRemote"===a?!1:"schema"===a?d.schema:"tableName"===a?void 0:d[a]?d[a].apply(d,Array.prototype.slice.call(arguments,1)):void 0},n(a),h.configureSync(a,e))}}),require.register("backbone-orm/lib/queue",function(a,b,c){var d,e=function(a,b){return function(){return a.apply(b,arguments)}};c.exports=d=function(){function a(a){this.parallelism=a,this._doneTask=e(this._doneTask,this),this.parallelism||(this.parallelism=1/0),this.tasks=[],this.running_count=0,this.error=null,this.await_callback=null}return a.prototype.defer=function(a){return this.tasks.push(a),this._runTasks()},a.prototype.await=function(a){if(this.await_callback)throw new Error("Awaiting callback was added twice: "+a);return this.await_callback=a,this.tasks.length+this.running_count?void 0:this._callAwaiting()},a.prototype._doneTask=function(a){return this.running_count--,this.error||(this.error=a),this._runTasks()},a.prototype._runTasks=function(){var a;if(this.error||!(this.tasks.length+this.running_count))return this._callAwaiting();for(;this.running_count<this.parallelism;){if(!this.tasks.length)return;a=this.tasks.shift(),this.running_count++,a(this._doneTask)}},a.prototype._callAwaiting=function(){return!this.await_called&&this.await_callback?(this.await_called=!0,this.await_callback(this.error)):void 0},a}()}),require.register("backbone-orm/lib/relations/many",function(a,b,c){var d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=b("backbone"),j=b("underscore"),i=b("inflection"),f=b("../queue"),g=b("../utils"),h=g.bbCallback,c.exports=e=function(a){function b(a,b,c){var e,f,g;this.model_type=a,this.key=b;for(b in c)f=c[b],this[b]=f;this.virtual_id_accessor||(this.virtual_id_accessor=""+i.singularize(this.key)+"_ids"),this.join_key||(this.join_key=i.foreign_key(this.model_type.model_name)),this.foreign_key||(this.foreign_key=i.foreign_key(this.as||this.model_type.model_name)),this.collection_type||(this.collection_type=e=function(a){function b(){return g=b.__super__.constructor.apply(this,arguments)}return l(b,a),b.prototype.model=b.reverse_model_type,b}(d.Collection))}return l(b,a),b.prototype.initialize=function(){var a;if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.");if("hasOne"===(null!=(a=this.reverse_relation)?a.type:void 0))throw new Error("The reverse of a hasMany relation should be `belongsTo`, not `hasOne` ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+").");return"hasMany"===this.reverse_relation.type?this.join_table=this.findOrGenerateJoinTable(this):void 0},b.prototype.initializeModel=function(a){return a.isLoadedExists(this.key)||a.setLoaded(this.key,!1),this._bindBacklinks(a)},b.prototype.releaseModel=function(a){return this._unbindBacklinks(a),delete a._orm},b.prototype.set=function(a,b,c){var d,e,f,h,i,k,l,m;if(b!==this.key&&b!==this.virtual_id_accessor&&b!==this.foreign_key)throw new Error("Many.set: Unexpected key "+b+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(d=this._bindBacklinks(a),g.isCollection(c)&&(c=c.models),j.isUndefined(c)&&(c=[]),!j.isArray(c))throw new Error("HasMany.set: Unexpected type to set "+b+". Expecting array: "+util.inspect(c));if(g.orSet(a,"rel_dirty",{})[this.key]=!0,a.setLoaded(this.key,!0),h=function(){var a,b,f;for(f=[],a=0,b=c.length;b>a;a++)e=c[a],f.push((k=d.get(g.dataId(e)))?g.updateModel(k,e):g.updateOrNew(e,this.reverse_model_type));return f}.call(this),i=j.clone(d.models),d.reset(h),"belongsTo"===this.reverse_relation.type)for(f=j.pluck(h,"id"),l=0,m=i.length;m>l;l++)k=i[l],j.contains(f,k.id)||k.set(this.foreign_key,null);return this},b.prototype.get=function(a,b,c){var d,e,f,h,i=this;if(b!==this.key&&b!==this.virtual_id_accessor&&b!==this.foreign_key)throw new Error("Many.get: Unexpected key "+b+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return d=this._ensureCollection(a),h=function(){var a,c,e,f,g;if(b===i.virtual_id_accessor){for(f=d.models,g=[],c=0,e=f.length;e>c;c++)a=f[c],g.push(a.id);return g}return d},!c||this.isVirtual()||this.manual_fetch||(e=a.isLoaded(this.key))||this.cursor(a,this.key).toJSON(function(b,e){var f,j,k,l,m,n,o,p,q;if(b)return c(b);for(a.setLoaded(i.key,!0),m=0,o=e.length;o>m;m++)j=e[m],(k=d.get(j.id))?k.set(j):d.add(k=g.updateOrNew(j,i.reverse_model_type));if(f=i.reverse_model_type.cache)for(q=d.models,n=0,p=q.length;p>n;n++)k=q[n],f.set(a.id,k);return l=h(),c(null,l.models?l.models:l)}),f=h(),c&&(e||this.manual_fetch)&&c(null,f.models?f.models:f),f},b.prototype.save=function(a,b){var c;return this._hasChanged(a)?(delete g.orSet(a,"rel_dirty",{})[this.key],c=this._ensureCollection(a),this._saveRelated(a,j.clone(c.models),b)):b()},b.prototype.appendJSON=function(a,b){var c,d;if(!this.isVirtual())return c=this._ensureCollection(b),d=this.embed?this.key:this.virtual_id_accessor,this.embed?a[d]=c.toJSON():void 0},b.prototype.add=function(a,b){var c,d;return c=this._ensureCollection(a),d=c.get(b.id),d!==b?(d&&c.remove(d),this.reverse_model_type.cache&&b.id&&this.reverse_model_type.cache.set(b.id,b),c.add(b)):void 0},b.prototype.remove=function(a,b){var c,d;return c=this._ensureCollection(a),(d=c.get(b.id))?c.remove(d):void 0},b.prototype.patchAdd=function(a,b,c){var d,e,i,k,l,m,n,o,p,q,r,s,t,u=this;if(!a.id)return c(new Error("Many.patchAdd: model has null id for: "+this.key));if(!b)return c(new Error("Many.patchAdd: missing model for: "+this.key));if(j.isArray(b)||(b=[b]),d=this._ensureCollection(a),b=function(){var a,c,f;for(f=[],a=0,c=b.length;c>a;a++)e=b[a],f.push((o=d.get(g.dataId(e)))?g.updateModel(o,e):g.updateOrNew(e,this.reverse_model_type));return f}.call(this),n=function(){var a,c,d;for(d=[],a=0,c=b.length;c>a;a++)l=b[a],d.push(g.dataId(l));return d}(),d.add(b),a.isLoaded(this.key))for(q=0,s=b.length;s>q;q++)if(l=b[q],!l.isLoaded()){a.setLoaded(this.key,!1);break}if(this.join_table){for(k=new f(1),p=function(b){return k.defer(function(c){var d,e;return b?(d=function(c){var d,e;return d={},d[u.foreign_key]=a.id,d[u.reverse_relation.foreign_key]=b,e=new u.join_table(d),e.save({},h(c))},"hasMany"===u.reverse_relation.type?d(c):((e={})[u.reverse_relation.foreign_key]=b,u.join_table.find(e,function(b,e){return b?c(b):e?e[u.foreign_key]===a.id?c():(e[u.foreign_key]=a.id,g.modelJSONSave(e,u.join_table,c)):d(c)}))):c(new Error("Many.patchAdd: cannot add an new model. Please save first."))})},r=0,t=n.length;t>r;r++)m=n[r],p(m);return k.await(c)}return i={id:{$in:n}},this.reverse_model_type.cursor(i).toJSON(function(b,d){var e,h,i,j;for(k=new f(1),h=function(b){return k.defer(function(c){return b[u.reverse_relation.foreign_key]=a.id,g.modelJSONSave(b,u.reverse_model_type,c)})},i=0,j=d.length;j>i;i++)e=d[i],h(e);return k.await(c)})},b.prototype.patchRemove=function(a,b,c){var d,e,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w=this;if(!a.id)return c(new Error("Many.patchRemove: model has null id for: "+this.key));if(2===arguments.length){if(c=b,!this.reverse_relation)return c();for(g.isModel(a)?(delete g.orSet(a,"rel_dirty",{})[this.key],e=this._ensureCollection(a),o=j.clone(e.models)):o=function(){var b,c,d,e;for(d=a[this.key]||[],e=[],b=0,c=d.length;c>b;b++)i=d[b],e.push(new this.reverse_model_type(i));return e}.call(this),p=0,s=o.length;s>p;p++)n=o[p],n.set(this.foreign_key,null),(d=n.cache())&&d.set(n.id,n);return this.join_table?((k={})[this.join_key]=a.id,this.join_table.destroy(k,c)):((k={})[this.reverse_relation.foreign_key]=a.id,this.reverse_model_type.cursor(k).toJSON(function(a,b){var d,e,h,i,j;if(a)return c(a);for(d=new f(1),h=function(a){return d.defer(function(b){return a[w.reverse_relation.foreign_key]=null,g.modelJSONSave(a,w.reverse_model_type,b)})},i=0,j=b.length;j>i;i++)e=b[i],h(e);return d.await(c)}),void 0)}if(this.isEmbedded())return c(new Error("Many.patchRemove: embedded relationships are not supported"));if(!b)return c(new Error("One.patchRemove: missing model for remove"));for(j.isArray(b)||(b=[b]),e=this._ensureCollection(a),q=0,t=b.length;t>q;q++)for(l=b[q],v=e.models,r=0,u=v.length;u>r;r++)if(h=v[r],g.dataIsSameModel(h,l)){e.remove(h);
break}return m=function(){var a,c,d;for(d=[],a=0,c=b.length;c>a;a++)l=b[a],d.push(g.dataId(l));return d}(),this.join_table?(k={},k[this.join_key]=a.id,k[this.reverse_relation.join_key]={$in:m},this.join_table.destroy(k,c)):(k={},k[this.reverse_relation.foreign_key]=a.id,k.id={$in:m},this.reverse_model_type.cursor(k).toJSON(function(a,b){var d,e,h,i,j;if(a)return c(a);for(d=new f(1),h=function(a){return d.defer(function(b){return a[w.reverse_relation.foreign_key]=null,g.modelJSONSave(a,w.reverse_model_type,b)})},i=0,j=b.length;j>i;i++)e=b[i],h(e);return d.await(c)}))},b.prototype.cursor=function(a,b,c){var d;return d=g.isModel(a)?a.attributes:a,(c=j.clone(c||{}))[this.join_table?this.join_key:this.reverse_relation.foreign_key]=d.id,b===this.virtual_id_accessor&&(c.$values||(c.$values=[])).push("id"),this.reverse_model_type.cursor(c)},b.prototype._bindBacklinks=function(a){var b,c,d,e,f,h,i=this;if((b=a.attributes[this.key])instanceof this.collection_type)return b;if(b=a.attributes[this.key]=new this.collection_type,!this.reverse_relation)return b;for(c=g.set(b,"events",{}),c.add=function(b){var c,d;return i.reverse_relation.add?i.reverse_relation.add(b,a):(c=b.get(i.reverse_relation.key),d=a.id&&g.dataId(c)===a.id,!d||d&&!c.isLoaded()?b.set(i.reverse_relation.key,a):void 0)},c.remove=function(b){var c;return i.reverse_relation.remove?i.reverse_relation.remove(b,a):(c=b.get(i.reverse_relation.key),g.dataId(c)===a.id?b.set(i.reverse_relation.key,null):void 0)},c.reset=function(a,b){var d,e,f,g,h,i,k,l,m,n,o;if(f=a.models,g=b.previousModels||[],e=j.groupBy(g,function(a){return j.find(f,function(b){return b.id===a.id})?"kept":"removed"}),d=e.kept?j.select(f,function(a){return!j.find(e.kept,function(b){return b.id===a.id})}):f,e.removed)for(n=e.removed,i=0,l=n.length;l>i;i++)h=n[i],c.remove(h);for(o=[],k=0,m=d.length;m>k;k++)h=d[k],o.push(c.add(h));return o},h=["add","remove","reset"],e=0,f=h.length;f>e;e++)d=h[e],b.on(d,c[d]);return b},b.prototype._unbindBacklinks=function(a){var b,c,d,e,f,h;if(c=g.get(a,"events"))for(g.unset(a,"events"),b=a.attributes[this.key],b.models.splice(),c=j.clone(),h=["add","remove","reset"],e=0,f=h.length;f>e;e++)d=h[e],b.off(d,c[d]),c[d]=null},b.prototype._ensureCollection=function(a){return this._bindBacklinks(a)},b.prototype._hasChanged=function(a){return!!g.orSet(a,"rel_dirty",{})[this.key]||a.hasChanged(this.key)},b}(b("./relation"))}),require.register("backbone-orm/lib/relations/one",function(a,b,c){var d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};j=b("underscore"),d=b("backbone"),i=b("inflection"),f=b("../queue"),g=b("../utils"),h=g.bbCallback,c.exports=e=function(a){function b(a,b,c){var d;this.model_type=a,this.key=b;for(b in c)d=c[b],this[b]=d;this.virtual_id_accessor||(this.virtual_id_accessor=""+this.key+"_id"),this.join_key||(this.join_key=i.foreign_key(this.model_type.model_name)),this.foreign_key||(this.foreign_key=i.foreign_key("belongsTo"===this.type?this.key:this.as||this.model_type.model_name))}return l(b,a),b.prototype.initialize=function(){if(this.reverse_relation=this._findOrGenerateReverseRelation(this),this.embed&&this.reverse_relation&&this.reverse_relation.embed)throw new Error("Both relationship directions cannot embed ("+this.model_type.model_name+" and "+this.reverse_model_type.model_name+"). Choose one or the other.")},b.prototype.initializeModel=function(a){return a.isLoadedExists(this.key)||a.setLoaded(this.key,this.isEmbedded()),this._bindBacklinks(a)},b.prototype.releaseModel=function(a){return this._unbindBacklinks(a),delete a._orm},b.prototype.set=function(a,b,c,e){var f,h,i,k,l;if(b!==this.key&&b!==this.virtual_id_accessor&&b!==this.foreign_key)throw new Error("One.set: Unexpected key "+b+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);if(j.isArray(c))throw new Error("One.set: cannot set an array for attribute "+this.key+" on "+this.model_type.model_name);return j.isUndefined(c)&&(c=null),c===(l=a.get(this.key))?this:(f=g.isModel(c),i=g.dataId(c),k=g.dataId(l),g.orSet(a,"rel_dirty",{})[this.key]=!0,k===i&&a.isLoaded(this.key)||(f&&c.isLoaded()&&i!==c?a.setLoaded(this.key,!0):a.setLoaded(this.key,j.isNull(c))),c&&!f&&((h=k===i)||(c=g.updateOrNew(c,this.reverse_model_type))),h||d.Model.prototype.set.call(a,this.key,c,e),h?g.updateModel(l,c):null!==c||!this.reverse_relation||"hasOne"!==this.reverse_relation.type&&"belongsTo"!==this.reverse_relation.type||this.embed||this.reverse_relation.embed||a.isLoaded(this.key)&&l&&l.get(this.reverse_relation.key)===a&&l.set(this.reverse_relation.key,null),this)},b.prototype.get=function(a,b,c){var d,e,f,h=this;if(b!==this.key&&b!==this.virtual_id_accessor&&b!==this.foreign_key)throw new Error("One.get: Unexpected key "+b+". Expecting: "+this.key+" or "+this.virtual_id_accessor+" or "+this.foreign_key);return f=function(){var c;return(c=a.attributes[h.key])?b===h.virtual_id_accessor?c.id:c:null},!c||this.isVirtual()||this.manual_fetch||(d=a.isLoaded(this.key))||this.cursor(a,b).toJSON(function(d,e){var i,j;return d?c(d):(b!==h.virtual_id_accessor&&a.setLoaded(h.key,!0),i=a.get(h.key),i&&i.id===(null!=e?e.id:void 0)?g.updateModel(i,e):(j=e?g.updateOrNew(e,h.reverse_model_type):null,a.set(h.key,j)),c(null,f()))}),e=f(),c&&(d||this.manual_fetch)&&c(null,e),e},b.prototype.save=function(a,b){var c;return this._hasChanged(a)?(delete g.orSet(a,"rel_dirty",{})[this.key],(c=a.attributes[this.key])?this._saveRelated(a,[c],b):b()):b()},b.prototype.patchAdd=function(a,b,c){var d,e,i=this;return a.id?b?j.isArray(b)?c(new Error("One.patchAdd: should be provided with one model only for key: "+this.key)):(e=g.dataId(b))?(this.reverse_model_type.cache&&!g.isModel(b)&&(d=this.reverse_model_type.cache.get(e))&&(g.updateModel(d,b),b=d),a.set(this.key,b),"belongsTo"===this.type?this.model_type.cursor({id:a.id,$one:!0}).toJSON(function(b,d){return b?c(b):d?(d[i.foreign_key]=e,a.save(d,h(c))):c(new Error("Failed to fetch model with id: "+a.id))}):this.cursor(a,this.key).toJSON(function(d,h){var j;return d?c(d):h&&e===h.id?c():(j=new f(1),h&&j.defer(function(b){return i.patchRemove(a,h,b)}),j.defer(function(c){var d,f;return g.isModel(b)?b.isLoaded()&&(f=b.toJSON()):e!==b&&(f=b),f?(f[i.reverse_relation.foreign_key]=a.id,g.modelJSONSave(f,i.reverse_model_type,c)):(d={$one:!0},d.id=e,i.reverse_model_type.cursor(d).toJSON(function(b,d){return b?c(b):d?(d[i.reverse_relation.foreign_key]=a.id,g.modelJSONSave(d,i.reverse_model_type,c)):c()}))}),j.await(c))})):c(new Error("One.patchAdd: cannot add a new model. Please save first.")):c(new Error("One.patchAdd: missing model for: "+this.key)):c(new Error("One.patchAdd: model has null id for: "+this.key))},b.prototype.patchRemove=function(a,b,c){var d,e,f,h,i,k=this;if(2===arguments.length&&(c=b,b=void 0),!a.id)return c(new Error("One.patchRemove: model has null id for: "+this.key));if(2===arguments.length)return this.reverse_relation?(g.isModel(a)&&delete g.orSet(a,"rel_dirty",{})[this.key],this.cursor(a,this.key).toJSON(function(a,b){return a?c(a):b?(b[k.reverse_relation.foreign_key]=null,g.modelJSONSave(b,k.reverse_model_type,c)):c()}),void 0):c();if(this.isEmbedded())return c(new Error("One.patchRemove: embedded relationships are not supported"));if(!b)return c(new Error("One.patchRemove: missing model for remove"));if(j.isArray(b)||(b=[b]),d=a.get(this.key))for(h=0,i=b.length;i>h;h++)if(e=b[h],g.dataIsSameModel(d,e)){a.set(this.key,null);break}return f=function(){var a,c,d;for(d=[],a=0,c=b.length;c>a;a++)e=b[a],d.push(g.dataId(e));return d}(),"belongsTo"===this.type?this.model_type.cursor({id:a.id,$one:!0}).toJSON(function(a,b){return a?c(a):b?j.contains(f,b[k.foreign_key])?(b[k.foreign_key]=null,g.modelJSONSave(b,k.model_type,c)):c():c()}):this.cursor(a,this.key).toJSON(function(a,b){return a?c(a):b?j.contains(f,b.id)?(b[k.reverse_relation.foreign_key]=null,g.modelJSONSave(b,k.reverse_model_type,c)):c():c()})},b.prototype.appendJSON=function(a,b){var c,d;if(!this.isVirtual())return c=this.embed?this.key:this.foreign_key,(d=b.attributes[this.key])?this.embed?a[c]=d.toJSON():"belongsTo"===this.type?a[c]=d.id:void 0:((this.embed||"belongsTo"===this.type)&&(a[c]=null),void 0)},b.prototype.cursor=function(a,b,c){var d;if(c=j.extend({$one:!0},c||{}),g.isModel(a))if("belongsTo"===this.type)(c.id=null!=(d=a.attributes[this.key])?d.id:void 0)||(c.$zero=!0,delete c.id);else{if(!a.id)throw new Error("Cannot create cursor for non-loaded model");c[this.reverse_relation.foreign_key]=a.id}else if("belongsTo"===this.type)(c.id=a[this.foreign_key])||(c.$zero=!0,delete c.id);else{if(!a.id)throw new Error("Cannot create cursor for non-loaded model");c[this.reverse_relation.foreign_key]=a.id}return b===this.virtual_id_accessor&&(c.$values=["id"]),this.reverse_model_type.cursor(c)},b.prototype._bindBacklinks=function(a){var b,c,d,e=this;if(this.reverse_relation)return b=g.set(a,"events",{}),d=function(b){return e.reverse_relation.add?e.reverse_relation.add(b,a):b.set(e.reverse_relation.key,a)},b.change=function(a){var b,c,f;return f=a.get(e.key),c=a.previous(e.key),g.dataId(f)!==g.dataId(c)?(c&&e.reverse_relation&&"belongsTo"!==e.reverse_relation.type&&(e.reverse_relation.remove?e.isVirtual()&&f||e.reverse_relation.remove(c,a):(b=c.get(e.reverse_relation.key),g.dataId(b)===a.id&&c.set(e.reverse_relation.key,null))),f?d(f):void 0):void 0},a.on("change:"+this.key,b.change),(c=a.get(this.key))&&d(c),a},b.prototype._unbindBacklinks=function(a){var b;(b=g.get(a,"events"))&&(g.unset(a,"events"),a.attributes[this.key]=null,a.off("change:"+this.key,b.change),b.change=null)},b.prototype._hasChanged=function(a){return!!g.orSet(a,"rel_dirty",{})[this.key]||a.hasChanged(this.key)},b}(b("./relation"))}),require.register("backbone-orm/lib/relations/relation",function(a,b,c){var d,e,f,g,h,i,j;j=b("underscore"),d=b("backbone"),e=b("../queue"),i=b("inflection"),g=b("../utils"),h=g.bbCallback,c.exports=f=function(){function a(){}return a.prototype.isEmbedded=function(){return!!(this.embed||this.reverse_relation&&this.reverse_relation.embed)},a.prototype.isVirtual=function(){return!!(this.virtual||this.reverse_relation&&this.reverse_relation.virtual)},a.prototype.findOrGenerateJoinTable=function(){var a;return(a=this.join_table||this.reverse_relation.join_table)?a:this.model_type.schema().generateJoinTable(this)},a.prototype._findOrGenerateReverseRelation=function(){var a,b,c,d;return b=this.model_type,c=this.reverse_model_type,j.isFunction(c.schema)||(c.sync=b.createSync(c)),a=this.as||i.underscore(b.model_name),d=c.relation(a),d||(d=c.relation(i.singularize(a))),d||(d=c.relation(i.pluralize(a))),d||"belongsTo"===this.type||(d=c.schema().generateBelongsTo(b)),d&&!d.reverse_relation&&(d.reverse_relation=this),d},a.prototype._saveRelated=function(a,b,c){var d=this;return this.embed||!this.reverse_relation||"belongsTo"===this.type?c():this.isVirtual()?c():this.cursor(a,this.key).toJSON(function(f,i){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;if(f)return c(f);if(j.isArray(i)||(i=i?[i]:[]),n=new e(1),p=j.pluck(b,"id"),m=j.groupBy(i,function(a){return j.contains(p,a.id)?"kept":"removed"}),l=m.kept?j.difference(p,function(){var a,b,c,d;for(c=m.kept,d=[],a=0,b=c.length;b>a;a++)s=c[a],d.push(s.id);return d}()):p,m.removed)if(d.join_table)n.defer(function(a){var b,c;return b={},b[d.reverse_relation.join_key]={$in:function(){var a,b,d,e;for(d=m.removed,e=[],a=0,b=d.length;b>a;a++)c=d[a],e.push(c.id);return e}()},d.join_table.destroy(b,a)});else for(C=m.removed,t=function(a){return n.defer(function(b){return a[d.reverse_relation.foreign_key]=null,g.modelJSONSave(a,d.reverse_model_type,b)})},w=0,z=C.length;z>w;w++)q=C[w],t(q);if(l.length)if(d.join_table)for(u=function(b){return n.defer(function(c){var e,f;return e={},e[d.foreign_key]=a.id,e[d.reverse_relation.foreign_key]=b,f=new d.join_table(e),f.save({},h(c))})},x=0,A=l.length;A>x;x++)o=l[x],u(o);else for(v=function(a){return n.defer(function(b){return a.save({},h(function(a,c){var e;return!a&&(e=d.reverse_model_type.cache)&&e.set(c.id,c),b(a)}))})},y=0,B=l.length;B>y;y++)k=l[y],r=j.find(b,function(a){return a.id===k}),d.reverse_relation._hasChanged(r)&&v(r);return n.await(c)})},a}()}),require.register("backbone-orm/lib/schema",function(a,b,c){var d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};j=b("underscore"),d=b("backbone"),g=b("./relations/one"),f=b("./relations/many"),i=b("inflection"),e=b("./database_url"),c.exports=h=function(){function a(a){this.model_type=a,this.raw=j.clone(j.result(this.model_type,"schema")||{}),this.fields={},this.relations={},this.virtual_accessors={}}return a.prototype.initialize=function(){var a,b,c,d,e;if(!this.is_initialized){this.is_initialized=!0,d=this.raw;for(b in d)a=d[b],this._parseField(b,a);e=this.relations;for(b in e)c=e[b],c.initialize()}},a.prototype.relation=function(a){return this.relations[a]||this.virtual_accessors[a]},a.prototype.reverseRelation=function(a){var b,c,d;d=this.relations;for(b in d)if(c=d[b],c.reverse_relation&&c.reverse_relation.join_key===a)return c.reverse_relation;return null},a.prototype.allRelations=function(){var a,b,c,d;b=[],d=this.relations;for(a in d)c=d[a],b.push(c.reverse_model_type),c.join_table&&b.push(c.join_table);return b},a.prototype.generateBelongsTo=function(a){var b,c;return b=i.underscore(a.model_name),(c=this.relations[b])?c:this.raw[b]?(c=this._parseField(b,this.raw[b]),c.initialize(),c):(c=this._parseField(b,this.raw[b]=["belongsTo",a,{manual_fetch:!0}]),c.initialize(),c)},a.joinTableURL=function(a){var b,c;return b=i.pluralize(i.underscore(a.model_type.model_name)),c=i.pluralize(i.underscore(a.reverse_relation.model_type.model_name)),b.localeCompare(c)<0?""+b+"_"+c:""+c+"_"+b},a.prototype.generateJoinTable=function(b){var c,f,g,h,k,m;g={},g[b.join_key]=["Integer",{indexed:!0}],g[b.reverse_relation.join_key]=["Integer",{indexed:!0}],h=a.joinTableURL(b),f=i.pluralize(i.classify(h));try{c=function(a){function c(){return k=c.__super__.constructor.apply(this,arguments)}return l(c,a),c.model_name=f,c.prototype.urlRoot=""+new e(j.result(b.model_type.prototype,"url")).format({exclude_table:!0})+"/"+h,c.schema=g,c.prototype.sync=b.model_type.createSync(c),c}(d.Model)}catch(n){c=function(a){function c(){return m=c.__super__.constructor.apply(this,arguments)}return l(c,a),c.model_name=f,c.prototype.urlRoot="/"+h,c.schema=g,c.prototype.sync=b.model_type.createSync(c),c}(d.Model)}return c},a.prototype.allColumns=function(){var a,b,c,d;a=j.keys(this.fields),d=this.relations;for(b in d)c=d[b],"belongsTo"===c.type&&a.push(c.foreign_key);return a},a.prototype._parseField=function(a,b){var c,d,e;if(c=this._fieldInfoToOptions(j.isFunction(b)?b():b),!c.type)return this.fields[a]=c;switch(e=i.camelize(i.underscore(c.type),!0)){case"hasOne":case"belongsTo":case"hasMany":return c.type=e,d=this.relations[a]="hasMany"===e?new f(this.model_type,a,c):new g(this.model_type,a,c),d.virtual_id_accessor&&(this.virtual_accessors[d.virtual_id_accessor]=d),"belongsTo"===e&&(this.virtual_accessors[d.foreign_key]=d),d;default:if(!j.isString(c.type))throw new Error("Unexpected type name is not a string: "+util.inspect(c));return this.fields[a]=c}},a.prototype._fieldInfoToOptions=function(a){var b;if(j.isString(a))return{type:a};if(!j.isArray(a))return a;if(b={},j.isString(a[0])&&(b.type=a[0],a=a.slice(1),0===a.length))return b;if(j.isFunction(a[0])&&(b.reverse_model_type=a[0],a=a.slice(1)),a.length>1)throw new Error("Unexpected field options array: "+util.inspect(a));return 1===a.length&&j.extend(b,a[0]),b},a}()}),require.register("backbone-orm/lib/utils",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};k=b("../node/url"),g=b("./database_url"),f=b("backbone"),o=b("underscore"),m=b("inflection"),n=b("moment"),i=b("./queue"),j=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)},d=1500,e=1,h=["milliseconds","seconds","minutes","hours","days","weeks","months","years"],c.exports=l=function(){function a(){}return a.bbCallback=function(a){return{success:function(b,c,d){return a(null,b,c,d)},error:function(b,c,d){return a(c||new Error("Backbone call failed"),b,c,d)}}},a.wrapOptions=function(b,c){return null==b&&(b={}),o.isFunction(b)&&(b=a.bbCallback(b)),o.defaults(a.bbCallback(function(a,d,e){return c(a,d,e,b)}),b)},a.isModel=function(a){return a&&a.attributes&&(a instanceof f.Model||a.parse&&a.fetch)},a.isCollection=function(a){return a&&a.models&&(a instanceof f.Collection||a.reset&&a.fetch)},a.deepClone=function(b){var c,d,e,f;if(!b||"object"!=typeof b)return b;if(o.isString(b))return String.prototype.slice.call(b);if(o.isDate(b))return new Date(b.valueOf());if(o.isArray(b))return function(){var d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],f.push(a.deepClone(c));return f}();if(o.isObject(b)&&b.constructor==={}.constructor){e={};for(d in b)f=b[d],e[d]=a.deepClone(f);return e}return b},a.guid=function(){return j()+j()+"-"+j()+"-"+j()+"-"+j()+"-"+j()+j()+j()},a.get=function(a,b,c){return a._orm||(a._orm={}),a._orm.hasOwnProperty(b)?a._orm[b]:c},a.set=function(a,b,c){return a._orm||(a._orm={}),a._orm[b]=c,a._orm[b]},a.orSet=function(a,b,c){return a._orm||(a._orm={}),a._orm.hasOwnProperty(b)||(a._orm[b]=c),a._orm[b]},a.unset=function(a,b){return a._orm||(a._orm={}),delete a._orm[b]},a.findOrGenerateModelName=function(a){var b,c;if(a.model_name)return a.model_name;if((c=o.result(a.prototype,"url"))&&(b=new g(c).modelName()))return b;if(a.name)return a.name;throw"Could not find or generate model name for "+a},a.configureCollectionModelType=function(a,b){var c,d,e,g;return d=function(){var b,c;return b=o.result(this.collection||a.prototype,"url"),this.isNew()||(c=k.parse(b),c.pathname=""+c.pathname+"/encodeURIComponent(@id)",b=k.format(c)),b},e=a.prototype.model,e&&e!==f.Model?(e.prototype.sync===f.Model.prototype.sync&&(e.prototype.url=d,e.prototype.sync=b(e)),e):(c=function(a){function c(){return g=c.__super__.constructor.apply(this,arguments)}return q(c,a),c.prototype.url=d,c.prototype.sync=b(c),c}(f.Model),a.prototype.model=c)},a.patchRemoveByJSON=function(a,b,c){var d,e,f,g,h,j,k;if(!(g=a.schema()))return c();for(e=new i(1),h=function(a){return e.defer(function(c){return a.patchRemove(b,c)})},f=j=0,k=g.length;k>j;f=++j)d=g[f],h(f);return e.await(c)},a.presaveBelongsToRelationships=function(b,c){var d,e,f,g,h,j,k,l,m,n,o;if(!b.schema)return c();e=new i(1),j=b.schema(),o=j.relations;for(d in o)if(h=o[d],"belongsTo"===h.type&&!h.isVirtual()&&(k=b.get(d)))for(g=k.models?k.models:[k],l=function(b){return e.defer(function(c){return b.save({},a.bbCallback(c))})},m=0,n=g.length;n>m;m++)f=g[m],f.id||l(f);return e.await(c)},a.dataId=function(a){return o.isObject(a)?a.id:a},a.dataIsSameModel=function(b,c){return a.dataId(b)||a.dataId(c)?a.dataId(b)===a.dataId(c):o.isEqual(b,c)},a.dataToModel=function(b,c){var d,e;return b?o.isArray(b)?function(){var e,f,g;for(g=[],e=0,f=b.length;f>e;e++)d=b[e],g.push(a.dataToModel(d,c));return g}():(a.isModel(b)?e=b:a.dataId(b)!==b?e=new c(c.prototype.parse(b)):(e=new c({id:b}),e.setLoaded(!1)),e):null},a.updateModel=function(b,c){return!c||b===c||c._orm_needs_load?b:(a.isModel(c)&&(c=c.toJSON()),a.dataId(c)!==c&&(b.setLoaded(!0),b.set(c)),b)},a.updateOrNew=function(b,c){var d,e,f;return(d=c.cache)&&(e=a.dataId(b))&&(f=d.get(e))&&a.updateModel(f,b),f||(f=a.isModel(b)?b:a.dataToModel(b,c),f&&d&&d.set(f.id,f)),f},a.modelJSONSave=function(b,c,d){var e;return e=new f.Model(b),e._orm_never_cache=!0,e.urlRoot=function(){var a,b;try{b=o.result(c.prototype,"url")}catch(d){a=d}return b},c.prototype.sync("update",e,a.bbCallback(d))},a.isSorted=function(a,b){var c,d,e,f;for(b=o.uniq(b),e=0,f=a.length;f>e;e++){if(d=a[e],c&&1===this.fieldCompare(c,d,b))return!1;c=d}return!0},a.fieldCompare=function(a,b,c){var d,e;return e=c[0],o.isArray(e)&&(e=e[0]),"-"===e.charAt(0)&&(e=e.substr(1),d=!0),a.get(e)===b.get(e)?c.length>1?this.fieldCompare(a,b,c.splice(1)):0:d?a.get(e)<b.get(e)?1:-1:a.get(e)>b.get(e)?1:-1},a.jsonFieldCompare=function(a,b,c){var d,e;return e=c[0],o.isArray(e)&&(e=e[0]),"-"===e.charAt(0)&&(e=e.substr(1),d=!0),a[e]===b[e]?c.length>1?this.jsonFieldCompare(a,b,c.splice(1)):0:d?JSON.stringify(a[e])<JSON.stringify(b[e])?1:-1:JSON.stringify(a[e])>JSON.stringify(b[e])?1:-1},a.resetSchemas=function(a,b,c){var d,e,f,g,h,j,k,l,m;for(2===arguments.length&&(m=[{},b],b=m[0],c=m[1]),h=0,k=a.length;k>h;h++)e=a[h],e.schema();for(d=[],f=new i(1),g=function(a){return f.defer(function(c){return a.resetSchema(b,function(b){return b&&(d.push(a.model_name),console.log("Error when dropping schema for "+a.model_name+". "+b)),c()})})},j=0,l=a.length;l>j;j++)e=a[j],g(e);return f.await(function(){return b.verbose&&console.log(""+(a.length-d.length)+" schemas dropped."),d.length?c(new Error("Failed to migrate schemas: "+d.join(", "))):c()})},a.batch=function(a,c,f,g,h){var j,k,l,m,n,p,q,r,s;return j=b("./cursor"),3===arguments.length&&(r=[{},{},c,f],c=r[0],f=r[1],g=r[2],h=r[3]),4===arguments.length&&(s=[{},c,f,g],c=s[0],f=s[1],g=s[2],h=s[3]),p=0,n=j.parseQuery(c),m=f.hasOwnProperty("parallelism")?f.parallelism:e,l=f.method||"toModels",q=function(b,c){var d;return d=a.cursor(b),d[l].call(d,function(a,d){var e,f,g,j,k;if(a||!d)return c(new Error("Failed to get models. Error: "+a));if(!d.length)return c(null,p);for(f=new i(m),g=function(a){return f.defer(function(b){return h(a,b)})},j=0,k=d.length;k>j&&(e=d[j],g(e),p++,!(n.cursor.$limit&&p>=n.cursor.$limit));j++);return f.await(function(a){return a?c(a):n.cursor.$limit&&p>=n.cursor.$limit?c(null,p):(b.$offset+=b.$limit,q(b,c))})})},k=o.extend({$limit:f.$limit||d,$offset:n.cursor.$offset||0,$sort:n.cursor.$sort||"id"},n.find),q(k,g)},a.interval=function(a,b,c,d,e){var f,g,j,k,l,m,p;if(3===arguments.length&&(m=[{},{},b,c],b=m[0],c=m[1],d=m[2],e=m[3]),4===arguments.length&&(p=[{},b,c,d],b=p[0],c=p[1],d=p[2],e=p[3]),!(g=c.key))throw new Error("missing option: key");if(!c.type)throw new Error("missing option: type");if(!o.contains(h,c.type))throw new Error("type is not recognized: "+c.type+", "+o.contains(h,c.type));return f=o.clone(c),f.range||(f.range={}),l=f.range,j=!1,k=new i(1),k.defer(function(c){var d;return(d=l.$gte||l.$gt)?(l.start=d,a.findOneNearestDate(d,{key:g,reverse:!0},b,function(a,b){return a?c(a):b?(f.first=b.get(g),c()):(j=!0,c())})):a.cursor(b).limit(1).sort(g).toModels(function(a,b){return a?c(a):b.length?(l.start=f.first=b[0].get(g),c()):(j=!0,c())})}),k.defer(function(c){var d;return j?c():(d=l.$lte||l.$lt)?(l.end=d,a.findOneNearestDate(d,{key:g},b,function(a,b){return a?c(a):b?(f.last=b.get(g),c()):(j=!0,c())})):a.cursor(b).limit(1).sort("-"+g).toModels(function(a,b){return a?c(a):b.length?(l.end=f.last=b[0].get(g),c()):(j=!0,c())})}),k.await(function(h){var i,k,m,p;if(h)return d(h);if(j)return d();if(p=l.start.getTime(),i=n.duration(o.isUndefined(c.length)?1:c.length,c.type).asMilliseconds(),!i)throw Error("length_ms is invalid: "+i+" for range: "+util.inspect(l));return b=o.clone(b),b.$sort=[g],k=0,f.index=0,m=function(c){return c.isAfter(l.end)?d():(b[g]={$gte:c.toDate(),$lte:f.last},a.findOne(b,function(a,h){var j;return a?d(a):h?(j=h.get(g),f.index=Math.floor((j.getTime()-p)/i),c=n.utc(l.start).add({milliseconds:f.index*i}),f.start=c.toDate(),j=c.clone().add({milliseconds:i}),f.end=j.toDate(),b[g]={$gte:c.toDate(),$lt:j.toDate()},e(b,f,function(a){return a?d(a):m(j)})):d()}))},m(n(l.start))})},a}()}),"object"==typeof exports)module.exports=require("backbone-orm/lib/index");else if("function"==typeof define&&define.amd)define("backbone-orm",["underscore","backbone","moment","inflection"],function(){return require("backbone-orm/lib/index")});else{var a=this.Backbone;if(!a&&"function"==typeof require)try{a=require("backbone")}catch(b){a=this.Backbone={}}a.ORM=require("backbone-orm/lib/index")}}).call(this);
